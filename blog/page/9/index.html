<!DOCTYPE html><html class="no-js" lang="en"><head>
<meta charset="utf-8">
<meta content="width=device-width,initial-scale=1" name="viewport">
<meta content="A blog about Azure, DevOps and other stuff" name="description">
<meta content="Rafael FernÃ¡ndez" name="author">
<link href="https://rfernandezdo.github.io/blog/page/9/" rel="canonical">
<link href="../../tags/" rel="next">
<link href="../../../feed_rss_created.xml" rel="alternate" title="RSS feed" type="application/rss+xml">
<link href="../../../feed_rss_updated.xml" rel="alternate" title="RSS feed of updated content" type="application/rss+xml">
<link href="../../../assets/images/favicon.png" rel="icon">
<meta content="mkdocs-1.6.1, mkdocs-material-9.6.22" name="generator">
<title>Blog - Un Rinconcito donde contar lo que quiera</title>
<link href="../../../assets/stylesheets/main.84d31ad4.min.css" rel="stylesheet">
<link href="../../../assets/stylesheets/palette.06af60db.min.css" rel="stylesheet">
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect">
<link href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet">
<style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
<script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
<meta content="website" property="og:type">
<meta content="Blog - Un Rinconcito donde contar lo que quiera" property="og:title">
<meta content="A blog about Azure, DevOps and other stuff" property="og:description">
<meta content="https://rfernandezdo.github.io/assets/images/social/blog/page/9/index.png" property="og:image">
<meta content="image/png" property="og:image:type">
<meta content="1200" property="og:image:width">
<meta content="630" property="og:image:height">
<meta content="https://rfernandezdo.github.io/blog/page/9/" property="og:url">
<meta content="summary_large_image" name="twitter:card">
<meta content="Blog - Un Rinconcito donde contar lo que quiera" name="twitter:title">
<meta content="A blog about Azure, DevOps and other stuff" name="twitter:description">
<meta content="https://rfernandezdo.github.io/assets/images/social/blog/page/9/index.png" name="twitter:image">
<link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"><script src="../../../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head>
<body data-md-color-accent="blue" data-md-color-primary="blue" data-md-color-scheme="default" dir="ltr">
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox">
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox">
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#blog">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
</div>
<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="Un Rinconcito donde contar lo que quiera" class="md-header__button md-logo" data-md-component="logo" href="../../.." title="Un Rinconcito donde contar lo que quiera">
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            Un Rinconcito donde contar lo que quiera
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Blog
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="blue" data-md-color-media="" data-md-color-primary="blue" data-md-color-scheme="default" id="__palette_0" name="__palette" type="radio">
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to dark mode">
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="blue" data-md-color-media="" data-md-color-primary="black" data-md-color-scheme="slate" id="__palette_1" name="__palette" type="radio">
<label class="md-header__button md-icon" for="__palette_0" hidden="" title="Switch to light mode">
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"></path></svg>
</label>
</form>
<script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
<div class="md-header__option">
<div class="md-select">
<button aria-label="Select language" class="md-header__button md-icon">
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"></path></svg>
</button>
<div class="md-select__inner">
<ul class="md-select__list">
<li class="md-select__item">
<a class="md-select__link" href="https://rfernandezdo-github-io.translate.goog/?_x_tr_sl=auto&amp;_x_tr_tl=es&amp;_x_tr_hl=es&amp;_x_tr_pto=wapp" hreflang="en">
              English
            </a>
</li>
<li class="md-select__item">
<a class="md-select__link" href="https://rfernandezdo-github-io.translate.goog/?_x_tr_sl=auto&amp;_x_tr_tl=en&amp;_x_tr_hl=en&amp;_x_tr_pto=wapp" hreflang="es">
              Spanish
            </a>
</li>
</ul>
</div>
</div>
</div>
<label class="md-header__button md-icon" for="__search">
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text">
<label class="md-search__icon md-icon" for="__search">
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="" tabindex="0">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list" role="presentation"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item md-tabs__item--active">
<a class="md-tabs__link" href="../../">
          
  
  
  Blog

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../..">
        
  
  
    
  
  About

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../contributions/">
        
  
  
    
  
  Contributions

      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../Azure/Security/MCSB/Readme/">
          
  
  
  Azure

        </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../Tools/Federated_Identity_Credentials_Report/README-federated-identity-credentials/">
          
  
  
  Tools

        </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Un Rinconcito donde contar lo que quiera" class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="Un Rinconcito donde contar lo que quiera">
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>
</a>
    Un Rinconcito donde contar lo que quiera
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" id="__nav_1" type="checkbox">
<label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="">
<span class="md-ellipsis">
    Blog
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="true" aria-labelledby="__nav_1_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_1">
<span class="md-nav__icon md-icon"></span>
            Blog
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<input class="md-nav__toggle md-toggle" id="__toc" type="checkbox">
<a class="md-nav__link md-nav__link--active" href="../../">
<span class="md-ellipsis">
    Blog
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../tags/">
<span class="md-ellipsis">
    Posts by Tags
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_1_3" type="checkbox">
<label class="md-nav__link" for="__nav_1_3" id="__nav_1_3_label" tabindex="">
<span class="md-ellipsis">
    Archive
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_1_3_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_1_3">
<span class="md-nav__icon md-icon"></span>
            Archive
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../2025/10/">
<span class="md-ellipsis">
    2025/10
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../2025/09/">
<span class="md-ellipsis">
    2025/09
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../2025/08/">
<span class="md-ellipsis">
    2025/08
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../2025/07/">
<span class="md-ellipsis">
    2025/07
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../2025/06/">
<span class="md-ellipsis">
    2025/06
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../2025/05/">
<span class="md-ellipsis">
    2025/05
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../2025/04/">
<span class="md-ellipsis">
    2025/04
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../2025/03/">
<span class="md-ellipsis">
    2025/03
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../2025/02/">
<span class="md-ellipsis">
    2025/02
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../2025/01/">
<span class="md-ellipsis">
    2025/01
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../2024/12/">
<span class="md-ellipsis">
    2024/12
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../2024/11/">
<span class="md-ellipsis">
    2024/11
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../2024/10/">
<span class="md-ellipsis">
    2024/10
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../2024/09/">
<span class="md-ellipsis">
    2024/09
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../2024/06/">
<span class="md-ellipsis">
    2024/06
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../2024/05/">
<span class="md-ellipsis">
    2024/05
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../2024/04/">
<span class="md-ellipsis">
    2024/04
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../2024/03/">
<span class="md-ellipsis">
    2024/03
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../2024/02/">
<span class="md-ellipsis">
    2024/02
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../2023/12/">
<span class="md-ellipsis">
    2023/12
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../2023/11/">
<span class="md-ellipsis">
    2023/11
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../2023/10/">
<span class="md-ellipsis">
    2023/10
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--section md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_1_4" type="checkbox">
<label class="md-nav__link" for="__nav_1_4" id="__nav_1_4_label" tabindex="">
<span class="md-ellipsis">
    Categories
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_1_4_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_1_4">
<span class="md-nav__icon md-icon"></span>
            Categories
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/azure/">
<span class="md-ellipsis">
    Azure
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/azure-ad/">
<span class="md-ellipsis">
    Azure AD
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/azure-automation/">
<span class="md-ellipsis">
    Azure Automation
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/azure-devops/">
<span class="md-ellipsis">
    Azure DevOps
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/azure-frameworks/">
<span class="md-ellipsis">
    Azure Frameworks
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/azure-governance/">
<span class="md-ellipsis">
    Azure Governance
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/azure-networking/">
<span class="md-ellipsis">
    Azure Networking
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/azure-security/">
<span class="md-ellipsis">
    Azure Security
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/azure-services/">
<span class="md-ellipsis">
    Azure Services
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/azure-updates/">
<span class="md-ellipsis">
    Azure Updates
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/caf/">
<span class="md-ellipsis">
    CAF
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/cicd/">
<span class="md-ellipsis">
    CI/CD
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/devops/">
<span class="md-ellipsis">
    DevOps
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/development/">
<span class="md-ellipsis">
    Development
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/drift-detection/">
<span class="md-ellipsis">
    Drift Detection
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/english/">
<span class="md-ellipsis">
    English
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/enterprise-policy-as-code/">
<span class="md-ellipsis">
    Enterprise Policy as Code
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/finops/">
<span class="md-ellipsis">
    FinOps
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/firewall/">
<span class="md-ellipsis">
    Firewall
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/gtd/">
<span class="md-ellipsis">
    GTD
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/git/">
<span class="md-ellipsis">
    Git
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/github-actions/">
<span class="md-ellipsis">
    GitHub Actions
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/hashicorp/">
<span class="md-ellipsis">
    HashiCorp
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/hello_world/">
<span class="md-ellipsis">
    Hello_World
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/infrastructure-as-code/">
<span class="md-ellipsis">
    Infrastructure as Code
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/learning/">
<span class="md-ellipsis">
    Learning
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/m365/">
<span class="md-ellipsis">
    M365
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/microsoft-365/">
<span class="md-ellipsis">
    Microsoft 365
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/microsoft-entra/">
<span class="md-ellipsis">
    Microsoft Entra
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/microsoft-entra-external-id/">
<span class="md-ellipsis">
    Microsoft Entra External ID
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/microsoft-entra-id/">
<span class="md-ellipsis">
    Microsoft Entra ID
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/networking/">
<span class="md-ellipsis">
    Networking
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/outlook/">
<span class="md-ellipsis">
    Outlook
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/pim/">
<span class="md-ellipsis">
    PIM
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/power-automate/">
<span class="md-ellipsis">
    Power Automate
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/power-bi/">
<span class="md-ellipsis">
    Power BI
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/productividad/">
<span class="md-ellipsis">
    Productividad
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/productividad--microsoft-365/">
<span class="md-ellipsis">
    Productividad / Microsoft 365
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/security/">
<span class="md-ellipsis">
    Security
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/seguridad/">
<span class="md-ellipsis">
    Seguridad
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/snowflake/">
<span class="md-ellipsis">
    Snowflake
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/terraform/">
<span class="md-ellipsis">
    Terraform
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/threat-intelligence/">
<span class="md-ellipsis">
    Threat Intelligence
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/tools/">
<span class="md-ellipsis">
    Tools
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/troubleshooting/">
<span class="md-ellipsis">
    Troubleshooting
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/visual-studio-code/">
<span class="md-ellipsis">
    Visual Studio Code
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/viva-insights/">
<span class="md-ellipsis">
    Viva Insights
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../category/windows/">
<span class="md-ellipsis">
    Windows
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../..">
<span class="md-ellipsis">
    About
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../contributions/">
<span class="md-ellipsis">
    Contributions
    
  </span>
</a>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_4" type="checkbox">
<label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
<span class="md-ellipsis">
    Azure
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
            Azure
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_4_1" type="checkbox">
<label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
<span class="md-ellipsis">
    Security
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_1_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_4_1">
<span class="md-nav__icon md-icon"></span>
            Security
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_4_1_1" type="checkbox">
<label class="md-nav__link" for="__nav_4_1_1" id="__nav_4_1_1_label" tabindex="0">
<span class="md-ellipsis">
    MCSB
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_4_1_1_label" class="md-nav" data-md-level="3">
<label class="md-nav__title" for="__nav_4_1_1">
<span class="md-nav__icon md-icon"></span>
            MCSB
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Azure/Security/MCSB/Readme/">
<span class="md-ellipsis">
    MCSB_v1 - Readme
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Azure/Security/MCSB/Asset%20Management/">
<span class="md-ellipsis">
    MCSB_v1 - Asset Management
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Azure/Security/MCSB/Backup%20and%20Recovery/">
<span class="md-ellipsis">
    MCSB_v1 - Backup and Recovery
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Azure/Security/MCSB/Data%20Protection/">
<span class="md-ellipsis">
    MCSB_v1 - Data Protection
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Azure/Security/MCSB/DevOps%20Security/">
<span class="md-ellipsis">
    MCSB_v1 - DevOps Security
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Azure/Security/MCSB/Endpoint%20Security/">
<span class="md-ellipsis">
    MCSB_v1 - Endpoint Security
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Azure/Security/MCSB/Governance%20and%20Strategy/">
<span class="md-ellipsis">
    MCSB_v1 - Governance and Strategy
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Azure/Security/MCSB/Identity%20Management/">
<span class="md-ellipsis">
    MCSB_v1 - Identity Management
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Azure/Security/MCSB/Incident%20Response/">
<span class="md-ellipsis">
    MCSB_v1 - Incident Response
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Azure/Security/MCSB/Logging%20and%20Threat%20Detection/">
<span class="md-ellipsis">
    MCSB_v1 - Logging and Threat Detection
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Azure/Security/MCSB/Network%20Security/">
<span class="md-ellipsis">
    MCSB_v1 - Network Security
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Azure/Security/MCSB/Posture%20and%20Vulnerability%20Mgmt/">
<span class="md-ellipsis">
    MCSB_v1 - Posture and Vulnerability Mgmt
    
  </span>
</a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Azure/Security/MCSB/Privileged%20Access/">
<span class="md-ellipsis">
    MCSB_v1 - Privileged Access
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_5" type="checkbox">
<label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
<span class="md-ellipsis">
    Tools
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_5_label" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_5">
<span class="md-nav__icon md-icon"></span>
            Tools
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_5_1" type="checkbox">
<label class="md-nav__link" for="__nav_5_1" id="__nav_5_1_label" tabindex="0">
<span class="md-ellipsis">
    Federated Identity Credentials Report
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_5_1_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_5_1">
<span class="md-nav__icon md-icon"></span>
            Federated Identity Credentials Report
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tools/Federated_Identity_Credentials_Report/README-federated-identity-credentials/">
<span class="md-ellipsis">
    Script de Reporte para Federated Identity Credentials
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input class="md-nav__toggle md-toggle md-toggle--indeterminate" id="__nav_5_2" type="checkbox">
<label class="md-nav__link" for="__nav_5_2" id="__nav_5_2_label" tabindex="0">
<span class="md-ellipsis">
    Analyze Virtual Network Flows
    
  </span>
<span class="md-nav__icon md-icon"></span>
</label>
<nav aria-expanded="false" aria-labelledby="__nav_5_2_label" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_5_2">
<span class="md-nav__icon md-icon"></span>
            Analyze Virtual Network Flows
          </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../Tools/Analyze_Virtual_Network_Flows/">
<span class="md-ellipsis">
    Analyze-VNETFlowLogs
    
  </span>
</a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<div class="md-content__inner">
<header class="md-typeset">
<h1 id="blog">Blog</h1>
</header>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<nav class="md-post__authors md-typeset">
<span class="md-author">
<img alt="Rafael FernÃ¡ndez" src="https://avatars.githubusercontent.com/u/39990341">
</span>
</nav>
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2025-01-05 00:00:00+00:00">January 5, 2025</time></li>
<li class="md-meta__item">
            in
            
              <a class="md-meta__link" href="../../category/azure-security/">Azure Security</a></li>
<li class="md-meta__item">
            
              4 min read
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="rotacion-automatica-de-secretos-en-azure-key-vault"><a class="toclink" href="../../2025/01/05/rotaci%C3%B3n-autom%C3%A1tica-de-secretos-en-azure-key-vault/">RotaciÃ³n automÃ¡tica de secretos en Azure Key Vault</a></h2>
<h3 id="resumen"><a class="toclink" href="../../2025/01/05/rotaci%C3%B3n-autom%C3%A1tica-de-secretos-en-azure-key-vault/#resumen">Resumen</a></h3>
<p>Rotar secretos manualmente es error-prone y tedioso. Azure Key Vault soporta rotaciÃ³n automatizada mediante Event Grid + Azure Functions. AquÃ­ te muestro cÃ³mo implementarla paso a paso.</p>
<h3 id="por-que-rotar-secretos"><a class="toclink" href="../../2025/01/05/rotaci%C3%B3n-autom%C3%A1tica-de-secretos-en-azure-key-vault/#por-que-rotar-secretos">Â¿Por quÃ© rotar secretos?</a></h3>
<ul>
<li><strong>Compliance</strong>: PCI-DSS, SOC2 exigen rotaciÃ³n periÃ³dica</li>
<li><strong>Seguridad</strong>: Limita ventana de exposiciÃ³n si hay leak</li>
<li><strong>Best practice</strong>: NIST recomienda rotaciÃ³n cada 90 dÃ­as</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Keys vs Secrets</p>
<ul>
<li><strong>Keys criptogrÃ¡ficas</strong>: Tienen rotaciÃ³n nativa con rotation policy</li>
<li><strong>Secrets</strong> (passwords, API keys): Requieren Event Grid + Function App</li>
</ul>
<p>Este artÃ­culo cubre <strong>secrets</strong>. Para keys, ver <a href="https://learn.microsoft.com/en-us/azure/key-vault/keys/how-to-configure-key-rotation">Configure key rotation</a>.</p>
</div>
<h3 id="arquitectura-de-rotacion-automatica"><a class="toclink" href="../../2025/01/05/rotaci%C3%B3n-autom%C3%A1tica-de-secretos-en-azure-key-vault/#arquitectura-de-rotacion-automatica">Arquitectura de rotaciÃ³n automÃ¡tica</a></h3>
<p>Azure Key Vault usa Event Grid para notificar cuando un secreto estÃ¡ cerca de expirar:</p>
<pre class="mermaid"><code>graph LR
    A[Key Vault Secret] --&gt;|30 dÃ­as antes expiraciÃ³n| B[Event Grid]
    B --&gt;|SecretNearExpiry event| C[Function App]
    C --&gt;|Genera nuevo secret| D[Servicio Externo/SQL]
    C --&gt;|Actualiza secreto| A
</code></pre>
<p><strong>Proceso:</strong>
1. Key Vault publica evento <code>SecretNearExpiry</code> 30 dÃ­as antes de expiraciÃ³n
2. Event Grid llama a Function App vÃ­a HTTP POST
3. Function genera nuevo secreto y actualiza el servicio
4. Function actualiza Key Vault con nueva versiÃ³n del secreto</p>
<h3 id="implementacion-rotar-sql-server-password"><a class="toclink" href="../../2025/01/05/rotaci%C3%B3n-autom%C3%A1tica-de-secretos-en-azure-key-vault/#implementacion-rotar-sql-server-password">ImplementaciÃ³n: Rotar SQL Server password</a></h3>
<h4 id="1-crear-secreto-con-fecha-de-expiracion"><a class="toclink" href="../../2025/01/05/rotaci%C3%B3n-autom%C3%A1tica-de-secretos-en-azure-key-vault/#1-crear-secreto-con-fecha-de-expiracion">1. Crear secreto con fecha de expiraciÃ³n</a></h4>
<h4 id="1-crear-secreto-con-fecha-de-expiracion_1"><a class="toclink" href="../../2025/01/05/rotaci%C3%B3n-autom%C3%A1tica-de-secretos-en-azure-key-vault/#1-crear-secreto-con-fecha-de-expiracion_1">1. Crear secreto con fecha de expiraciÃ³n</a></h4>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-12-1"><a href="#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="c1"># Variables</span>
</span><span id="__span-12-2"><a href="#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="nv">RG</span><span class="o">=</span><span class="s2">"my-rg"</span>
</span><span id="__span-12-3"><a href="#__codelineno-12-3" id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="nv">KV_NAME</span><span class="o">=</span><span class="s2">"my-keyvault"</span>
</span><span id="__span-12-4"><a href="#__codelineno-12-4" id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="nv">SECRET_NAME</span><span class="o">=</span><span class="s2">"sql-admin-password"</span>
</span><span id="__span-12-5"><a href="#__codelineno-12-5" id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="nv">SQL_SERVER</span><span class="o">=</span><span class="s2">"my-sql-server"</span>
</span><span id="__span-12-6"><a href="#__codelineno-12-6" id="__codelineno-12-6" name="__codelineno-12-6"></a>
</span><span id="__span-12-7"><a href="#__codelineno-12-7" id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="c1"># Crear secreto con expiraciÃ³n 90 dÃ­as</span>
</span><span id="__span-12-8"><a href="#__codelineno-12-8" id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="nv">EXPIRY_DATE</span><span class="o">=</span><span class="k">$(</span>date<span class="w"> </span>-u<span class="w"> </span>-d<span class="w"> </span><span class="s2">"+90 days"</span><span class="w"> </span>+<span class="s1">'%Y-%m-%dT%H:%M:%SZ'</span><span class="k">)</span>
</span><span id="__span-12-9"><a href="#__codelineno-12-9" id="__codelineno-12-9" name="__codelineno-12-9"></a>
</span><span id="__span-12-10"><a href="#__codelineno-12-10" id="__codelineno-12-10" name="__codelineno-12-10"></a>az<span class="w"> </span>keyvault<span class="w"> </span>secret<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-12-11"><a href="#__codelineno-12-11" id="__codelineno-12-11" name="__codelineno-12-11"></a><span class="w">  </span>--vault-name<span class="w"> </span><span class="nv">$KV_NAME</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-12-12"><a href="#__codelineno-12-12" id="__codelineno-12-12" name="__codelineno-12-12"></a><span class="w">  </span>--name<span class="w"> </span><span class="nv">$SECRET_NAME</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-12-13"><a href="#__codelineno-12-13" id="__codelineno-12-13" name="__codelineno-12-13"></a><span class="w">  </span>--value<span class="w"> </span><span class="s2">"InitialP@ssw0rd!"</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-12-14"><a href="#__codelineno-12-14" id="__codelineno-12-14" name="__codelineno-12-14"></a><span class="w">  </span>--expires<span class="w"> </span><span class="nv">$EXPIRY_DATE</span>
</span></code></pre></div>
<h4 id="2-desplegar-function-app-de-rotacion"><a class="toclink" href="../../2025/01/05/rotaci%C3%B3n-autom%C3%A1tica-de-secretos-en-azure-key-vault/#2-desplegar-function-app-de-rotacion">2. Desplegar Function App de rotaciÃ³n</a></h4>
<p>Usar template oficial de Microsoft:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-13-1"><a href="#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="c1"># Deploy ARM template con Function App preconfigurada</span>
</span><span id="__span-13-2"><a href="#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a>az<span class="w"> </span>deployment<span class="w"> </span>group<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-3"><a href="#__codelineno-13-3" id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="w">  </span>--resource-group<span class="w"> </span><span class="nv">$RG</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-4"><a href="#__codelineno-13-4" id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="w">  </span>--template-uri<span class="w"> </span>https://raw.githubusercontent.com/Azure-Samples/KeyVault-Rotation-SQLPassword-Csharp/main/ARM-Templates/Function/azuredeploy.json<span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-5"><a href="#__codelineno-13-5" id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="w">  </span>--parameters<span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-6"><a href="#__codelineno-13-6" id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="w">    </span><span class="nv">sqlServerName</span><span class="o">=</span><span class="nv">$SQL_SERVER</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-7"><a href="#__codelineno-13-7" id="__codelineno-13-7" name="__codelineno-13-7"></a><span class="w">    </span><span class="nv">keyVaultName</span><span class="o">=</span><span class="nv">$KV_NAME</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-8"><a href="#__codelineno-13-8" id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="w">    </span><span class="nv">functionAppName</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">KV_NAME</span><span class="si">}</span><span class="s2">-rotation-func"</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-9"><a href="#__codelineno-13-9" id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="w">    </span><span class="nv">secretName</span><span class="o">=</span><span class="nv">$SECRET_NAME</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-10"><a href="#__codelineno-13-10" id="__codelineno-13-10" name="__codelineno-13-10"></a><span class="w">    </span><span class="nv">repoUrl</span><span class="o">=</span><span class="s2">"https://github.com/Azure-Samples/KeyVault-Rotation-SQLPassword-Csharp.git"</span>
</span></code></pre></div>
<p>Este template despliega:
- Function App con managed identity
- Event Grid subscription a <code>SecretNearExpiry</code>
- Access policy de Key Vault para la funciÃ³n
- CÃ³digo de rotaciÃ³n preconfigura do</p>
<h4 id="3-codigo-de-la-funcion-incluido-en-el-template"><a class="toclink" href="../../2025/01/05/rotaci%C3%B3n-autom%C3%A1tica-de-secretos-en-azure-key-vault/#3-codigo-de-la-funcion-incluido-en-el-template">3. CÃ³digo de la funciÃ³n (incluido en el template)</a></h4>
<h4 id="3-codigo-de-la-funcion-incluido-en-el-template_1"><a class="toclink" href="../../2025/01/05/rotaci%C3%B3n-autom%C3%A1tica-de-secretos-en-azure-key-vault/#3-codigo-de-la-funcion-incluido-en-el-template_1">3. CÃ³digo de la funciÃ³n (incluido en el template)</a></h4>
<p>La funciÃ³n C# incluida en el template maneja:
- Recibe evento <code>SecretNearExpiry</code> de Event Grid
- Extrae nombre del secreto y versiÃ³n
- Genera nuevo password aleatorio
- Actualiza SQL Server con nuevo password
- Crea nueva versiÃ³n del secreto en Key Vault</p>
<div class="language-csharp highlight"><pre><span></span><code><span id="__span-14-1"><a href="#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="c1">// CÃ³digo simplificado (el template incluye implementaciÃ³n completa)</span>
</span><span id="__span-14-2"><a href="#__codelineno-14-2" id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="na">[FunctionName("AKVSQLRotation")]</span>
</span><span id="__span-14-3"><a href="#__codelineno-14-3" id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="k">public</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="k">void</span><span class="w"> </span><span class="nf">Run</span><span class="p">([</span><span class="n">EventGridTrigger</span><span class="p">]</span><span class="n">EventGridEvent</span><span class="w"> </span><span class="n">eventGridEvent</span><span class="p">)</span>
</span><span id="__span-14-4"><a href="#__codelineno-14-4" id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="p">{</span>
</span><span id="__span-14-5"><a href="#__codelineno-14-5" id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">secretName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">eventGridEvent</span><span class="p">.</span><span class="n">Subject</span><span class="p">;</span>
</span><span id="__span-14-6"><a href="#__codelineno-14-6" id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="w">    </span><span class="kt">var</span><span class="w"> </span><span class="n">keyVaultName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ExtractVaultName</span><span class="p">(</span><span class="n">eventGridEvent</span><span class="p">.</span><span class="n">Topic</span><span class="p">);</span>
</span><span id="__span-14-7"><a href="#__codelineno-14-7" id="__codelineno-14-7" name="__codelineno-14-7"></a>
</span><span id="__span-14-8"><a href="#__codelineno-14-8" id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="w">    </span><span class="c1">// Rotar password</span>
</span><span id="__span-14-9"><a href="#__codelineno-14-9" id="__codelineno-14-9" name="__codelineno-14-9"></a><span class="w">    </span><span class="n">SecretRotator</span><span class="p">.</span><span class="n">RotateSecret</span><span class="p">(</span><span class="n">log</span><span class="p">,</span><span class="w"> </span><span class="n">secretName</span><span class="p">,</span><span class="w"> </span><span class="n">keyVaultName</span><span class="p">);</span>
</span><span id="__span-14-10"><a href="#__codelineno-14-10" id="__codelineno-14-10" name="__codelineno-14-10"></a><span class="p">}</span>
</span></code></pre></div>
<h3 id="implementacion-rotar-storage-account-keys"><a class="toclink" href="../../2025/01/05/rotaci%C3%B3n-autom%C3%A1tica-de-secretos-en-azure-key-vault/#implementacion-rotar-storage-account-keys">ImplementaciÃ³n: Rotar Storage Account keys</a></h3>
<p>Para servicios con <strong>dos sets de credenciales</strong> (primary/secondary keys):</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-15-1"><a href="#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="c1"># Deploy template para Storage Account rotation</span>
</span><span id="__span-15-2"><a href="#__codelineno-15-2" id="__codelineno-15-2" name="__codelineno-15-2"></a>az<span class="w"> </span>deployment<span class="w"> </span>group<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
</span><span id="__span-15-3"><a href="#__codelineno-15-3" id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="w">  </span>--resource-group<span class="w"> </span><span class="nv">$RG</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-15-4"><a href="#__codelineno-15-4" id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="w">  </span>--template-uri<span class="w"> </span>https://raw.githubusercontent.com/Azure-Samples/KeyVault-Rotation-StorageAccountKey-PowerShell/master/ARM-Templates/Function/azuredeploy.json<span class="w"> </span><span class="se">\</span>
</span><span id="__span-15-5"><a href="#__codelineno-15-5" id="__codelineno-15-5" name="__codelineno-15-5"></a><span class="w">  </span>--parameters<span class="w"> </span><span class="se">\</span>
</span><span id="__span-15-6"><a href="#__codelineno-15-6" id="__codelineno-15-6" name="__codelineno-15-6"></a><span class="w">    </span><span class="nv">storageAccountName</span><span class="o">=</span><span class="nv">$STORAGE_ACCOUNT</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-15-7"><a href="#__codelineno-15-7" id="__codelineno-15-7" name="__codelineno-15-7"></a><span class="w">    </span><span class="nv">keyVaultName</span><span class="o">=</span><span class="nv">$KV_NAME</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-15-8"><a href="#__codelineno-15-8" id="__codelineno-15-8" name="__codelineno-15-8"></a><span class="w">    </span><span class="nv">functionAppName</span><span class="o">=</span><span class="s2">"</span><span class="si">${</span><span class="nv">KV_NAME</span><span class="si">}</span><span class="s2">-storage-rotation"</span>
</span><span id="__span-15-9"><a href="#__codelineno-15-9" id="__codelineno-15-9" name="__codelineno-15-9"></a>
</span><span id="__span-15-10"><a href="#__codelineno-15-10" id="__codelineno-15-10" name="__codelineno-15-10"></a><span class="c1"># Crear secret con metadata para rotaciÃ³n</span>
</span><span id="__span-15-11"><a href="#__codelineno-15-11" id="__codelineno-15-11" name="__codelineno-15-11"></a><span class="nv">EXPIRY_DATE</span><span class="o">=</span><span class="k">$(</span>date<span class="w"> </span>-u<span class="w"> </span>-d<span class="w"> </span><span class="s2">"+60 days"</span><span class="w"> </span>+<span class="s1">'%Y-%m-%dT%H:%M:%SZ'</span><span class="k">)</span>
</span><span id="__span-15-12"><a href="#__codelineno-15-12" id="__codelineno-15-12" name="__codelineno-15-12"></a><span class="nv">STORAGE_KEY</span><span class="o">=</span><span class="k">$(</span>az<span class="w"> </span>storage<span class="w"> </span>account<span class="w"> </span>keys<span class="w"> </span>list<span class="w"> </span>-n<span class="w"> </span><span class="nv">$STORAGE_ACCOUNT</span><span class="w"> </span>--query<span class="w"> </span><span class="s2">"[0].value"</span><span class="w"> </span>-o<span class="w"> </span>tsv<span class="k">)</span>
</span><span id="__span-15-13"><a href="#__codelineno-15-13" id="__codelineno-15-13" name="__codelineno-15-13"></a>
</span><span id="__span-15-14"><a href="#__codelineno-15-14" id="__codelineno-15-14" name="__codelineno-15-14"></a>az<span class="w"> </span>keyvault<span class="w"> </span>secret<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-15-15"><a href="#__codelineno-15-15" id="__codelineno-15-15" name="__codelineno-15-15"></a><span class="w">  </span>--vault-name<span class="w"> </span><span class="nv">$KV_NAME</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-15-16"><a href="#__codelineno-15-16" id="__codelineno-15-16" name="__codelineno-15-16"></a><span class="w">  </span>--name<span class="w"> </span>storageKey<span class="w"> </span><span class="se">\</span>
</span><span id="__span-15-17"><a href="#__codelineno-15-17" id="__codelineno-15-17" name="__codelineno-15-17"></a><span class="w">  </span>--value<span class="w"> </span><span class="s2">"</span><span class="nv">$STORAGE_KEY</span><span class="s2">"</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-15-18"><a href="#__codelineno-15-18" id="__codelineno-15-18" name="__codelineno-15-18"></a><span class="w">  </span>--tags<span class="w"> </span><span class="nv">CredentialId</span><span class="o">=</span>key1<span class="w"> </span><span class="nv">ProviderAddress</span><span class="o">=</span><span class="s2">"/subscriptions/{sub}/resourceGroups/</span><span class="nv">$RG</span><span class="s2">/providers/Microsoft.Storage/storageAccounts/</span><span class="nv">$STORAGE_ACCOUNT</span><span class="s2">"</span><span class="w"> </span><span class="nv">ValidityPeriodDays</span><span class="o">=</span><span class="m">60</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-15-19"><a href="#__codelineno-15-19" id="__codelineno-15-19" name="__codelineno-15-19"></a><span class="w">  </span>--expires<span class="w"> </span><span class="nv">$EXPIRY_DATE</span>
</span></code></pre></div>
<p><strong>Estrategia dual-key:</strong>
1. Key1 almacenada en Key Vault
2. Evento <code>SecretNearExpiry</code> activa rotaciÃ³n
3. Function regenera Key2 en Storage Account
4. Actualiza secreto en Key Vault con Key2
5. PrÃ³xima rotaciÃ³n alterna a Key1</p>
<h3 id="monitoreo-de-rotaciones"><a class="toclink" href="../../2025/01/05/rotaci%C3%B3n-autom%C3%A1tica-de-secretos-en-azure-key-vault/#monitoreo-de-rotaciones">Monitoreo de rotaciones</a></h3>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-16-1"><a href="#__codelineno-16-1" id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="c1"># Ver versiones de un secreto</span>
</span><span id="__span-16-2"><a href="#__codelineno-16-2" id="__codelineno-16-2" name="__codelineno-16-2"></a>az<span class="w"> </span>keyvault<span class="w"> </span>secret<span class="w"> </span>list-versions<span class="w"> </span><span class="se">\</span>
</span><span id="__span-16-3"><a href="#__codelineno-16-3" id="__codelineno-16-3" name="__codelineno-16-3"></a><span class="w">  </span>--vault-name<span class="w"> </span><span class="nv">$KV_NAME</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-16-4"><a href="#__codelineno-16-4" id="__codelineno-16-4" name="__codelineno-16-4"></a><span class="w">  </span>--name<span class="w"> </span><span class="nv">$SECRET_NAME</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-16-5"><a href="#__codelineno-16-5" id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="w">  </span>--query<span class="w"> </span><span class="s2">"[].{Version:id, Created:attributes.created, Expires:attributes.expires}"</span>
</span><span id="__span-16-6"><a href="#__codelineno-16-6" id="__codelineno-16-6" name="__codelineno-16-6"></a>
</span><span id="__span-16-7"><a href="#__codelineno-16-7" id="__codelineno-16-7" name="__codelineno-16-7"></a><span class="c1"># Ver Ãºltima actualizaciÃ³n</span>
</span><span id="__span-16-8"><a href="#__codelineno-16-8" id="__codelineno-16-8" name="__codelineno-16-8"></a>az<span class="w"> </span>keyvault<span class="w"> </span>secret<span class="w"> </span>show<span class="w"> </span><span class="se">\</span>
</span><span id="__span-16-9"><a href="#__codelineno-16-9" id="__codelineno-16-9" name="__codelineno-16-9"></a><span class="w">  </span>--vault-name<span class="w"> </span><span class="nv">$KV_NAME</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-16-10"><a href="#__codelineno-16-10" id="__codelineno-16-10" name="__codelineno-16-10"></a><span class="w">  </span>--name<span class="w"> </span><span class="nv">$SECRET_NAME</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-16-11"><a href="#__codelineno-16-11" id="__codelineno-16-11" name="__codelineno-16-11"></a><span class="w">  </span>--query<span class="w"> </span><span class="s2">"attributes.{Updated:updated, Expires:expires, Enabled:enabled}"</span>
</span><span id="__span-16-12"><a href="#__codelineno-16-12" id="__codelineno-16-12" name="__codelineno-16-12"></a>
</span><span id="__span-16-13"><a href="#__codelineno-16-13" id="__codelineno-16-13" name="__codelineno-16-13"></a><span class="c1"># Ver logs de rotaciÃ³n en Function App</span>
</span><span id="__span-16-14"><a href="#__codelineno-16-14" id="__codelineno-16-14" name="__codelineno-16-14"></a>az<span class="w"> </span>monitor<span class="w"> </span>app-insights<span class="w"> </span>query<span class="w"> </span><span class="se">\</span>
</span><span id="__span-16-15"><a href="#__codelineno-16-15" id="__codelineno-16-15" name="__codelineno-16-15"></a><span class="w">  </span>--app<span class="w"> </span><span class="si">${</span><span class="nv">KV_NAME</span><span class="si">}</span>-rotation-func<span class="w"> </span><span class="se">\</span>
</span><span id="__span-16-16"><a href="#__codelineno-16-16" id="__codelineno-16-16" name="__codelineno-16-16"></a><span class="w">  </span>--analytics-query<span class="w"> </span><span class="s2">"traces | where message contains 'Rotation' | top 10 by timestamp desc"</span>
</span></code></pre></div>
<h3 id="notificaciones-por-email"><a class="toclink" href="../../2025/01/05/rotaci%C3%B3n-autom%C3%A1tica-de-secretos-en-azure-key-vault/#notificaciones-por-email">Notificaciones por email</a></h3>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-17-1"><a href="#__codelineno-17-1" id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="c1"># Action Group para alertas</span>
</span><span id="__span-17-2"><a href="#__codelineno-17-2" id="__codelineno-17-2" name="__codelineno-17-2"></a>az<span class="w"> </span>monitor<span class="w"> </span>action-group<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
</span><span id="__span-17-3"><a href="#__codelineno-17-3" id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="w">  </span>--resource-group<span class="w"> </span><span class="nv">$RG</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-17-4"><a href="#__codelineno-17-4" id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="w">  </span>--name<span class="w"> </span>secret-rotation-alerts<span class="w"> </span><span class="se">\</span>
</span><span id="__span-17-5"><a href="#__codelineno-17-5" id="__codelineno-17-5" name="__codelineno-17-5"></a><span class="w">  </span>--short-name<span class="w"> </span>SecRot<span class="w"> </span><span class="se">\</span>
</span><span id="__span-17-6"><a href="#__codelineno-17-6" id="__codelineno-17-6" name="__codelineno-17-6"></a><span class="w">  </span>--email-receiver<span class="w"> </span>EmailAdmin<span class="w"> </span>admin@company.com
</span><span id="__span-17-7"><a href="#__codelineno-17-7" id="__codelineno-17-7" name="__codelineno-17-7"></a>
</span><span id="__span-17-8"><a href="#__codelineno-17-8" id="__codelineno-17-8" name="__codelineno-17-8"></a><span class="c1"># Alert rule</span>
</span><span id="__span-17-9"><a href="#__codelineno-17-9" id="__codelineno-17-9" name="__codelineno-17-9"></a>az<span class="w"> </span>monitor<span class="w"> </span>metrics<span class="w"> </span>alert<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
</span><span id="__span-17-10"><a href="#__codelineno-17-10" id="__codelineno-17-10" name="__codelineno-17-10"></a><span class="w">  </span>--resource-group<span class="w"> </span><span class="nv">$RG</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-17-11"><a href="#__codelineno-17-11" id="__codelineno-17-11" name="__codelineno-17-11"></a><span class="w">  </span>--name<span class="w"> </span>secret-rotation-failed<span class="w"> </span><span class="se">\</span>
</span><span id="__span-17-12"><a href="#__codelineno-17-12" id="__codelineno-17-12" name="__codelineno-17-12"></a><span class="w">  </span>--scopes<span class="w"> </span>/subscriptions/<span class="o">{</span>sub-id<span class="o">}</span>/resourceGroups/<span class="nv">$RG</span>/providers/Microsoft.KeyVault/vaults/<span class="nv">$KV_NAME</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-17-13"><a href="#__codelineno-17-13" id="__codelineno-17-13" name="__codelineno-17-13"></a><span class="w">  </span>--condition<span class="w"> </span><span class="s2">"count SecretRotationFailed &gt; 0"</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-17-14"><a href="#__codelineno-17-14" id="__codelineno-17-14" name="__codelineno-17-14"></a><span class="w">  </span>--action<span class="w"> </span>secret-rotation-alerts
</span></code></pre></div>
<h3 id="buenas-practicas"><a class="toclink" href="../../2025/01/05/rotaci%C3%B3n-autom%C3%A1tica-de-secretos-en-azure-key-vault/#buenas-practicas">Buenas prÃ¡cticas</a></h3>
<ul>
<li><strong>Overlap period</strong>: MantÃ©n versiÃ³n anterior vÃ¡lida 7-30 dÃ­as</li>
<li><strong>Testing</strong>: Rota primero en entorno de dev/staging</li>
<li><strong>DocumentaciÃ³n</strong>: Registra quÃ© servicios usan cada secreto</li>
<li><strong>Backup</strong>: Exporta secretos crÃ­ticos a offline storage encriptado</li>
<li><strong>Notificaciones</strong>: Configura alertas para rotaciones fallidas</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Secretos hardcodeados</p>
<p>La rotaciÃ³n no sirve de nada si tienes secretos hardcodeados en cÃ³digo o config files. Usa referencias a Key Vault (<code>@Microsoft.KeyVault(SecretUri=...)</code> en App Settings).</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Templates oficiales</p>
<p>Microsoft proporciona templates ARM completos para diferentes escenarios:
- <a href="https://github.com/Azure-Samples/KeyVault-Rotation-SQLPassword-Csharp">SQL password rotation</a>
- <a href="https://github.com/Azure-Samples/KeyVault-Rotation-StorageAccountKey-PowerShell">Storage Account keys rotation</a>
- Adaptables para otros servicios (Cosmos DB, Redis, APIs externas)</p>
</div>
<h3 id="referencias"><a class="toclink" href="../../2025/01/05/rotaci%C3%B3n-autom%C3%A1tica-de-secretos-en-azure-key-vault/#referencias">Referencias</a></h3>
<ul>
<li><a href="https://learn.microsoft.com/en-us/azure/key-vault/secrets/tutorial-rotation">Automate secret rotation (single credential)</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/key-vault/secrets/tutorial-rotation-dual">Automate secret rotation (dual credentials)</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/key-vault/general/autorotation">Understanding autorotation in Key Vault</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/key-vault/general/event-grid-overview">Key Vault Event Grid integration</a></li>
</ul>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<nav class="md-post__authors md-typeset">
<span class="md-author">
<img alt="Rafael FernÃ¡ndez" src="https://avatars.githubusercontent.com/u/39990341">
</span>
</nav>
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2025-01-02 00:00:00+00:00">January 2, 2025</time></li>
<li class="md-meta__item">
            in
            
              <a class="md-meta__link" href="../../category/azure-services/">Azure Services</a></li>
<li class="md-meta__item">
            
              3 min read
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="azure-app-service-deployment-slots-despliegues-sin-downtime"><a class="toclink" href="../../2025/01/02/azure-app-service-deployment-slots-despliegues-sin-downtime/">Azure App Service Deployment Slots: Despliegues sin downtime</a></h2>
<h3 id="resumen"><a class="toclink" href="../../2025/01/02/azure-app-service-deployment-slots-despliegues-sin-downtime/#resumen">Resumen</a></h3>
<p>Los Deployment Slots en Azure App Service te permiten desplegar nuevas versiones de tu aplicaciÃ³n sin tiempo de inactividad. es la forma mÃ¡s sencilla de implementar blue-green deployments en Azure.</p>
<h3 id="que-son-los-deployment-slots"><a class="toclink" href="../../2025/01/02/azure-app-service-deployment-slots-despliegues-sin-downtime/#que-son-los-deployment-slots">Â¿QuÃ© son los Deployment Slots?</a></h3>
<p>Los Deployment Slots son entornos en vivo dentro de tu App Service donde puedes desplegar diferentes versiones de tu aplicaciÃ³n. Cada slot:</p>
<ul>
<li>Tiene su propia URL</li>
<li>Puede tener configuraciÃ³n independiente</li>
<li>Permite swap instantÃ¡neo entre slots</li>
<li>Comparte el mismo plan de App Service</li>
</ul>
<h3 id="caso-de-uso-tipico"><a class="toclink" href="../../2025/01/02/azure-app-service-deployment-slots-despliegues-sin-downtime/#caso-de-uso-tipico">Caso de uso tÃ­pico</a></h3>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-7-1"><a href="#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="c1"># Variables</span>
</span><span id="__span-7-2"><a href="#__codelineno-7-2" id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="nv">RG</span><span class="o">=</span><span class="s2">"my-rg"</span>
</span><span id="__span-7-3"><a href="#__codelineno-7-3" id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="nv">APP_NAME</span><span class="o">=</span><span class="s2">"my-webapp"</span>
</span><span id="__span-7-4"><a href="#__codelineno-7-4" id="__codelineno-7-4" name="__codelineno-7-4"></a><span class="nv">LOCATION</span><span class="o">=</span><span class="s2">"westeurope"</span>
</span><span id="__span-7-5"><a href="#__codelineno-7-5" id="__codelineno-7-5" name="__codelineno-7-5"></a>
</span><span id="__span-7-6"><a href="#__codelineno-7-6" id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="c1"># Crear App Service Plan (mÃ­nimo Standard)</span>
</span><span id="__span-7-7"><a href="#__codelineno-7-7" id="__codelineno-7-7" name="__codelineno-7-7"></a>az<span class="w"> </span>appservice<span class="w"> </span>plan<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-8"><a href="#__codelineno-7-8" id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="w">  </span>--name<span class="w"> </span><span class="si">${</span><span class="nv">APP_NAME</span><span class="si">}</span>-plan<span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-9"><a href="#__codelineno-7-9" id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="w">  </span>--resource-group<span class="w"> </span><span class="nv">$RG</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-10"><a href="#__codelineno-7-10" id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="w">  </span>--location<span class="w"> </span><span class="nv">$LOCATION</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-11"><a href="#__codelineno-7-11" id="__codelineno-7-11" name="__codelineno-7-11"></a><span class="w">  </span>--sku<span class="w"> </span>S1
</span><span id="__span-7-12"><a href="#__codelineno-7-12" id="__codelineno-7-12" name="__codelineno-7-12"></a>
</span><span id="__span-7-13"><a href="#__codelineno-7-13" id="__codelineno-7-13" name="__codelineno-7-13"></a><span class="c1"># Crear App Service</span>
</span><span id="__span-7-14"><a href="#__codelineno-7-14" id="__codelineno-7-14" name="__codelineno-7-14"></a>az<span class="w"> </span>webapp<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-15"><a href="#__codelineno-7-15" id="__codelineno-7-15" name="__codelineno-7-15"></a><span class="w">  </span>--name<span class="w"> </span><span class="nv">$APP_NAME</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-16"><a href="#__codelineno-7-16" id="__codelineno-7-16" name="__codelineno-7-16"></a><span class="w">  </span>--resource-group<span class="w"> </span><span class="nv">$RG</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-17"><a href="#__codelineno-7-17" id="__codelineno-7-17" name="__codelineno-7-17"></a><span class="w">  </span>--plan<span class="w"> </span><span class="si">${</span><span class="nv">APP_NAME</span><span class="si">}</span>-plan
</span><span id="__span-7-18"><a href="#__codelineno-7-18" id="__codelineno-7-18" name="__codelineno-7-18"></a>
</span><span id="__span-7-19"><a href="#__codelineno-7-19" id="__codelineno-7-19" name="__codelineno-7-19"></a><span class="c1"># Crear slot de staging</span>
</span><span id="__span-7-20"><a href="#__codelineno-7-20" id="__codelineno-7-20" name="__codelineno-7-20"></a>az<span class="w"> </span>webapp<span class="w"> </span>deployment<span class="w"> </span>slot<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-21"><a href="#__codelineno-7-21" id="__codelineno-7-21" name="__codelineno-7-21"></a><span class="w">  </span>--name<span class="w"> </span><span class="nv">$APP_NAME</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-22"><a href="#__codelineno-7-22" id="__codelineno-7-22" name="__codelineno-7-22"></a><span class="w">  </span>--resource-group<span class="w"> </span><span class="nv">$RG</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-7-23"><a href="#__codelineno-7-23" id="__codelineno-7-23" name="__codelineno-7-23"></a><span class="w">  </span>--slot<span class="w"> </span>staging
</span></code></pre></div>
<h3 id="workflow-de-despliegue"><a class="toclink" href="../../2025/01/02/azure-app-service-deployment-slots-despliegues-sin-downtime/#workflow-de-despliegue">Workflow de despliegue</a></h3>
<p><strong>1. Desplegar a staging:</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-8-1"><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="c1"># Desplegar cÃ³digo al slot staging</span>
</span><span id="__span-8-2"><a href="#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a>az<span class="w"> </span>webapp<span class="w"> </span>deployment<span class="w"> </span><span class="nb">source</span><span class="w"> </span>config-zip<span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-3"><a href="#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="w">  </span>--resource-group<span class="w"> </span><span class="nv">$RG</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-4"><a href="#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="w">  </span>--name<span class="w"> </span><span class="nv">$APP_NAME</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-5"><a href="#__codelineno-8-5" id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="w">  </span>--slot<span class="w"> </span>staging<span class="w"> </span><span class="se">\</span>
</span><span id="__span-8-6"><a href="#__codelineno-8-6" id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="w">  </span>--src<span class="w"> </span>app.zip
</span></code></pre></div>
<p><strong>2. Validar en staging:</strong></p>
<p>URL del slot: <code>https://{app-name}-staging.azurewebsites.net</code></p>
<p><strong>3. Hacer swap a producciÃ³n:</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-9-1"><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="c1"># Swap directo staging -&gt; production</span>
</span><span id="__span-9-2"><a href="#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a>az<span class="w"> </span>webapp<span class="w"> </span>deployment<span class="w"> </span>slot<span class="w"> </span>swap<span class="w"> </span><span class="se">\</span>
</span><span id="__span-9-3"><a href="#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="w">  </span>--resource-group<span class="w"> </span><span class="nv">$RG</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-9-4"><a href="#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="w">  </span>--name<span class="w"> </span><span class="nv">$APP_NAME</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-9-5"><a href="#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="w">  </span>--slot<span class="w"> </span>staging<span class="w"> </span><span class="se">\</span>
</span><span id="__span-9-6"><a href="#__codelineno-9-6" id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="w">  </span>--target-slot<span class="w"> </span>production
</span><span id="__span-9-7"><a href="#__codelineno-9-7" id="__codelineno-9-7" name="__codelineno-9-7"></a>
</span><span id="__span-9-8"><a href="#__codelineno-9-8" id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="c1"># Swap con preview (recomendado)</span>
</span><span id="__span-9-9"><a href="#__codelineno-9-9" id="__codelineno-9-9" name="__codelineno-9-9"></a>az<span class="w"> </span>webapp<span class="w"> </span>deployment<span class="w"> </span>slot<span class="w"> </span>swap<span class="w"> </span><span class="se">\</span>
</span><span id="__span-9-10"><a href="#__codelineno-9-10" id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="w">  </span>--resource-group<span class="w"> </span><span class="nv">$RG</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-9-11"><a href="#__codelineno-9-11" id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="w">  </span>--name<span class="w"> </span><span class="nv">$APP_NAME</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-9-12"><a href="#__codelineno-9-12" id="__codelineno-9-12" name="__codelineno-9-12"></a><span class="w">  </span>--slot<span class="w"> </span>staging<span class="w"> </span><span class="se">\</span>
</span><span id="__span-9-13"><a href="#__codelineno-9-13" id="__codelineno-9-13" name="__codelineno-9-13"></a><span class="w">  </span>--target-slot<span class="w"> </span>production<span class="w"> </span><span class="se">\</span>
</span><span id="__span-9-14"><a href="#__codelineno-9-14" id="__codelineno-9-14" name="__codelineno-9-14"></a><span class="w">  </span>--action<span class="w"> </span>preview
</span><span id="__span-9-15"><a href="#__codelineno-9-15" id="__codelineno-9-15" name="__codelineno-9-15"></a>
</span><span id="__span-9-16"><a href="#__codelineno-9-16" id="__codelineno-9-16" name="__codelineno-9-16"></a><span class="c1"># DespuÃ©s de validar, completar swap</span>
</span><span id="__span-9-17"><a href="#__codelineno-9-17" id="__codelineno-9-17" name="__codelineno-9-17"></a>az<span class="w"> </span>webapp<span class="w"> </span>deployment<span class="w"> </span>slot<span class="w"> </span>swap<span class="w"> </span><span class="se">\</span>
</span><span id="__span-9-18"><a href="#__codelineno-9-18" id="__codelineno-9-18" name="__codelineno-9-18"></a><span class="w">  </span>--resource-group<span class="w"> </span><span class="nv">$RG</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-9-19"><a href="#__codelineno-9-19" id="__codelineno-9-19" name="__codelineno-9-19"></a><span class="w">  </span>--name<span class="w"> </span><span class="nv">$APP_NAME</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-9-20"><a href="#__codelineno-9-20" id="__codelineno-9-20" name="__codelineno-9-20"></a><span class="w">  </span>--slot<span class="w"> </span>staging<span class="w"> </span><span class="se">\</span>
</span><span id="__span-9-21"><a href="#__codelineno-9-21" id="__codelineno-9-21" name="__codelineno-9-21"></a><span class="w">  </span>--target-slot<span class="w"> </span>production<span class="w"> </span><span class="se">\</span>
</span><span id="__span-9-22"><a href="#__codelineno-9-22" id="__codelineno-9-22" name="__codelineno-9-22"></a><span class="w">  </span>--action<span class="w"> </span>swap
</span></code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Proceso de swap</p>
<p>Durante el swap, Azure sigue este proceso:
1. Aplica settings del target slot al source slot
2. Espera a que todas las instancias se reinicien y calienten
3. Si todas las instancias estÃ¡n healthy, intercambia el routing
4. El target slot (production) queda con la nueva app sin downtime</p>
<p>Tiempo total: 1-5 minutos dependiendo de warmup. La producciÃ³n NO sufre downtime.</p>
</div>
<h3 id="configuracion-sticky-vs-swappable"><a class="toclink" href="../../2025/01/02/azure-app-service-deployment-slots-despliegues-sin-downtime/#configuracion-sticky-vs-swappable">ConfiguraciÃ³n sticky vs swappable</a></h3>
<p>No toda la configuraciÃ³n se intercambia en el swap:</p>
<p><strong>Sticky (no se mueve con el cÃ³digo):</strong>
- App settings marcadas como "Deployment slot setting"
- Connection strings marcadas como "Deployment slot setting"
- Custom domains
- Nonpublic certificates y TLS/SSL settings
- Scale settings
- IP restrictions
- Always On, Diagnostic settings, CORS</p>
<p><strong>Swappable (se mueve con el cÃ³digo):</strong>
- General settings (framework version, 32/64-bit)
- App settings no marcadas
- Handler mappings
- Public certificates
- WebJobs content
- Hybrid connections
- Virtual network integration</p>
<p><strong>Configurar sticky settings:</strong></p>
<p>Desde el portal Azure:
1. Ir a <strong>Configuration</strong> â <strong>Application settings</strong> del slot
2. AÃ±adir/editar app setting
3. Marcar checkbox <strong>Deployment slot setting</strong>
4. Apply</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-10-1"><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="c1"># Crear app setting en slot staging</span>
</span><span id="__span-10-2"><a href="#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a>az<span class="w"> </span>webapp<span class="w"> </span>config<span class="w"> </span>appsettings<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-10-3"><a href="#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="w">  </span>--resource-group<span class="w"> </span><span class="nv">$RG</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-10-4"><a href="#__codelineno-10-4" id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="w">  </span>--name<span class="w"> </span><span class="nv">$APP_NAME</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-10-5"><a href="#__codelineno-10-5" id="__codelineno-10-5" name="__codelineno-10-5"></a><span class="w">  </span>--slot<span class="w"> </span>staging<span class="w"> </span><span class="se">\</span>
</span><span id="__span-10-6"><a href="#__codelineno-10-6" id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="w">  </span>--settings<span class="w"> </span><span class="nv">DATABASE_URL</span><span class="o">=</span><span class="s2">"staging-connection-string"</span>
</span><span id="__span-10-7"><a href="#__codelineno-10-7" id="__codelineno-10-7" name="__codelineno-10-7"></a>
</span><span id="__span-10-8"><a href="#__codelineno-10-8" id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="c1"># Para hacerla sticky: usar portal o ARM template</span>
</span><span id="__span-10-9"><a href="#__codelineno-10-9" id="__codelineno-10-9" name="__codelineno-10-9"></a><span class="c1"># No hay flag CLI directo para marcar como slot-specific</span>
</span></code></pre></div>
<h3 id="auto-swap-para-cicd"><a class="toclink" href="../../2025/01/02/azure-app-service-deployment-slots-despliegues-sin-downtime/#auto-swap-para-cicd">Auto-swap para CI/CD</a></h3>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-11-1"><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="c1"># Configurar auto-swap desde staging a production</span>
</span><span id="__span-11-2"><a href="#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a>az<span class="w"> </span>webapp<span class="w"> </span>deployment<span class="w"> </span>slot<span class="w"> </span>auto-swap<span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-3"><a href="#__codelineno-11-3" id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="w">  </span>--resource-group<span class="w"> </span><span class="nv">$RG</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-4"><a href="#__codelineno-11-4" id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="w">  </span>--name<span class="w"> </span><span class="nv">$APP_NAME</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-5"><a href="#__codelineno-11-5" id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="w">  </span>--slot<span class="w"> </span>staging<span class="w"> </span><span class="se">\</span>
</span><span id="__span-11-6"><a href="#__codelineno-11-6" id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="w">  </span>--auto-swap-slot<span class="w"> </span>production
</span></code></pre></div>
<p>Con auto-swap habilitado:
1. Push a staging â despliegue automÃ¡tico
2. Warmup automÃ¡tico del slot
3. Swap a producciÃ³n sin intervenciÃ³n manual</p>
<p><strong>Customizar warmup path:</strong></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-12-1"><a href="#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="c1"># Configurar URL de warmup personalizada</span>
</span><span id="__span-12-2"><a href="#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a>az<span class="w"> </span>webapp<span class="w"> </span>config<span class="w"> </span>appsettings<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-12-3"><a href="#__codelineno-12-3" id="__codelineno-12-3" name="__codelineno-12-3"></a><span class="w">  </span>--resource-group<span class="w"> </span><span class="nv">$RG</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-12-4"><a href="#__codelineno-12-4" id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="w">  </span>--name<span class="w"> </span><span class="nv">$APP_NAME</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-12-5"><a href="#__codelineno-12-5" id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="w">  </span>--slot<span class="w"> </span>staging<span class="w"> </span><span class="se">\</span>
</span><span id="__span-12-6"><a href="#__codelineno-12-6" id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="w">  </span>--settings<span class="w"> </span><span class="nv">WEBSITE_SWAP_WARMUP_PING_PATH</span><span class="o">=</span><span class="s2">"/health/ready"</span>
</span><span id="__span-12-7"><a href="#__codelineno-12-7" id="__codelineno-12-7" name="__codelineno-12-7"></a>
</span><span id="__span-12-8"><a href="#__codelineno-12-8" id="__codelineno-12-8" name="__codelineno-12-8"></a><span class="c1"># Validar solo cÃ³digos HTTP especÃ­ficos</span>
</span><span id="__span-12-9"><a href="#__codelineno-12-9" id="__codelineno-12-9" name="__codelineno-12-9"></a>az<span class="w"> </span>webapp<span class="w"> </span>config<span class="w"> </span>appsettings<span class="w"> </span><span class="nb">set</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-12-10"><a href="#__codelineno-12-10" id="__codelineno-12-10" name="__codelineno-12-10"></a><span class="w">  </span>--resource-group<span class="w"> </span><span class="nv">$RG</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-12-11"><a href="#__codelineno-12-11" id="__codelineno-12-11" name="__codelineno-12-11"></a><span class="w">  </span>--name<span class="w"> </span><span class="nv">$APP_NAME</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-12-12"><a href="#__codelineno-12-12" id="__codelineno-12-12" name="__codelineno-12-12"></a><span class="w">  </span>--slot<span class="w"> </span>staging<span class="w"> </span><span class="se">\</span>
</span><span id="__span-12-13"><a href="#__codelineno-12-13" id="__codelineno-12-13" name="__codelineno-12-13"></a><span class="w">  </span>--settings<span class="w"> </span><span class="nv">WEBSITE_SWAP_WARMUP_PING_STATUSES</span><span class="o">=</span><span class="s2">"200,202"</span>
</span></code></pre></div>
<h3 id="buenas-practicas"><a class="toclink" href="../../2025/01/02/azure-app-service-deployment-slots-despliegues-sin-downtime/#buenas-practicas">Buenas prÃ¡cticas</a></h3>
<ul>
<li><strong>Usar staging para testing</strong>: Siempre valida en staging antes del swap</li>
<li><strong>Configurar health checks</strong>: Azure verifica el slot antes de hacer swap</li>
<li><strong>Mantener paridad</strong>: Staging debe replicar producciÃ³n (misma configuraciÃ³n, DB de test similar)</li>
<li><strong>Rollback rÃ¡pido</strong>: Si falla, haz swap inverso inmediatamente</li>
<li><strong>Limitar slots</strong>: MÃ¡ximo 2-3 slots por app (staging, pre-production)</li>
</ul>
<div class="admonition tip">
<p class="admonition-title">Ahorro de costos</p>
<p>Los slots comparten recursos del App Service Plan. No pagas mÃ¡s por tener staging, pero requieres tier Standard o superior.</p>
</div>
<h3 id="monitoring-del-swap"><a class="toclink" href="../../2025/01/02/azure-app-service-deployment-slots-despliegues-sin-downtime/#monitoring-del-swap">Monitoring del swap</a></h3>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-13-1"><a href="#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="c1"># Ver historial de swaps</span>
</span><span id="__span-13-2"><a href="#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a>az<span class="w"> </span>webapp<span class="w"> </span>deployment<span class="w"> </span>slot<span class="w"> </span>list<span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-3"><a href="#__codelineno-13-3" id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="w">  </span>--resource-group<span class="w"> </span><span class="nv">$RG</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-4"><a href="#__codelineno-13-4" id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="w">  </span>--name<span class="w"> </span><span class="nv">$APP_NAME</span>
</span><span id="__span-13-5"><a href="#__codelineno-13-5" id="__codelineno-13-5" name="__codelineno-13-5"></a>
</span><span id="__span-13-6"><a href="#__codelineno-13-6" id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="c1"># Logs durante el swap</span>
</span><span id="__span-13-7"><a href="#__codelineno-13-7" id="__codelineno-13-7" name="__codelineno-13-7"></a>az<span class="w"> </span>webapp<span class="w"> </span>log<span class="w"> </span>tail<span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-8"><a href="#__codelineno-13-8" id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="w">  </span>--resource-group<span class="w"> </span><span class="nv">$RG</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-9"><a href="#__codelineno-13-9" id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="w">  </span>--name<span class="w"> </span><span class="nv">$APP_NAME</span><span class="w"> </span><span class="se">\</span>
</span><span id="__span-13-10"><a href="#__codelineno-13-10" id="__codelineno-13-10" name="__codelineno-13-10"></a><span class="w">  </span>--slot<span class="w"> </span>staging
</span></code></pre></div>
<h3 id="referencias"><a class="toclink" href="../../2025/01/02/azure-app-service-deployment-slots-despliegues-sin-downtime/#referencias">Referencias</a></h3>
<ul>
<li><a href="https://learn.microsoft.com/en-us/azure/app-service/deploy-staging-slots">Set up staging environments - Azure App Service</a></li>
<li><a href="https://learn.microsoft.com/en-us/cli/azure/webapp/deployment/slot">Azure CLI - webapp deployment slot</a></li>
</ul>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<nav class="md-post__authors md-typeset">
<span class="md-author">
<img alt="Rafael FernÃ¡ndez" src="https://avatars.githubusercontent.com/u/39990341">
</span>
</nav>
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2025-01-01 00:00:00+00:00">January 1, 2025</time></li>
<li class="md-meta__item">
            in
            
              <a class="md-meta__link" href="../../category/azure-services/">Azure Services</a></li>
<li class="md-meta__item">
            
              6 min read
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="azure-cost-management-planifica-tu-presupuesto-2025"><a class="toclink" href="../../2025/01/01/azure-cost-management-planifica-tu-presupuesto-2025/">Azure Cost Management: planifica tu presupuesto 2025</a></h2>
<h3 id="resumen"><a class="toclink" href="../../2025/01/01/azure-cost-management-planifica-tu-presupuesto-2025/#resumen">Resumen</a></h3>
<p>enero es el mes para configurar <strong>presupuestos y alertas de costes</strong> en Azure. Con Azure Cost Management puedes establecer lÃ­mites, recibir notificaciones y evitar sorpresas en la factura. En este post verÃ¡s cÃ³mo crear presupuestos, configurar alertas automÃ¡ticas y usar Azure Advisor para optimizar gastos desde el primer dÃ­a del aÃ±o.</p>
<nav class="md-post__action">
<a href="../../2025/01/01/azure-cost-management-planifica-tu-presupuesto-2025/">
          Continue reading
        </a>
</nav>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<nav class="md-post__authors md-typeset">
<span class="md-author">
<img alt="Rafael FernÃ¡ndez" src="https://avatars.githubusercontent.com/u/39990341">
</span>
</nav>
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2024-12-22 00:00:00+00:00">December 22, 2024</time></li>
<li class="md-meta__item">
            in
            
              <a class="md-meta__link" href="../../category/outlook/">Outlook</a></li>
<li class="md-meta__item">
            
              5 min read
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="gtd-in-outlook-with-microsoft-to-do"><a class="toclink" href="../../2024/12/22/gtd-in-outlook-with-microsoft-to-do/">GTD in Outlook with Microsoft To Do</a></h2>
<p>In this post, we will see how to use GTD in Outlook.</p>
<p>Firs of all, let's define what GTD is. GTD stands for Getting Things Done, a productivity method created by David Allen. The GTD method is based on the idea that you should get things out of your head and into a trusted system, so you can focus on what you need to do.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The GTD method is not about doing more things faster. It's about doing the right things at the right time.
This method needs to be aligned with your purpose, objectives, and goals, so you can focus on what really matters to you.</p>
</div>
<h3 id="the-gtd-workflow"><a class="toclink" href="../../2024/12/22/gtd-in-outlook-with-microsoft-to-do/#the-gtd-workflow">The GTD workflow</a></h3>
<p>The GTD workflow consists of five steps:</p>
<ol>
<li>Capture: Collect everything that has your attention.</li>
<li>Clarify: Process what you've captured.</li>
<li>Organize: Put everything in its place.</li>
<li>Reflect: Review your system regularly.</li>
<li>Engage: Choose what to do and do it.</li>
</ol>
<p>The detailed flowchart of the GTD method is shown below:</p>
<pre class="mermaid"><code>graph TD;
    subgraph Capture    
    subgraph for_each_item_not_in_Inbox
    AA[Collect everything that has your attention in the Inbox];
    end    
    A[Inbox]
    AA--&gt;A
    end
    subgraph Clarify        
    subgraph for_each_item_in_Inbox
    BB[  What is this?
            What should I do?
            Is this really worth doing?
            How does it fit in with all the other things I have to do?
            Is there any action that needs to be done about it or because of it?]
    end
    end
    A --&gt; BB
    subgraph Organize
    BB --&gt; B{Is it actionable?}
    B -- no --&gt; C{Is it reference material?}
    C -- yes --&gt; D[Archive]
    C -- no --&gt; E{Is it trash?}
    E -- yes --&gt; FF[Trash it]
    E -- no --&gt; GG[Incubate it]
    GG --&gt; HH[Review it weekly]
    B -- yes --&gt; F{Can it be done in one step?}
    F -- no --&gt; G[Project]
    G --&gt; HHH[Define a next action at least]
    HHH --&gt; H[Project Actions]    
    end
    subgraph Engage
    H --&gt; I
    F -- yes --&gt; I{Does it take more than 2 minutes?}
    I -- no --&gt; J[DO IT]
    I -- yes --&gt; K{Is it my responsibility?}
    K -- no --&gt; L[Delegate]
    L --&gt; M[Waiting For]    
    K -- yes --&gt; N{Does it have a specific date?}
    N -- yes --&gt; O[Add to Calendar]
    N -- no --&gt; P[Next Actions]
    O --&gt; Q[Schedule. Do it at a specific time]
    P --&gt; R[Do it as soon as possible]
    end
</code></pre>
<pre class="mermaid"><code>graph TD;
subgraph Reflect
    S[**Daily Review**
            - Review your tasks daily
            - Calendar
            - Next  actions
            - Urgent tasks]
    T[**Weekly Review**
            - Review your projects weekly, make sure you're making progress
            - Next actions
            - Waiting for
            - Someday/Maybe
            - Calendar]
    U[**Monthly Review**
            - Focus on your goals
            - Reference archive
            - Someday/Maybe
            - Completed projects]
    V[**Review your purpose annually**
            - Goals and purposes
            - Big projects
            - Historical archive]
    end

</code></pre>
<p>It's important to note that the GTD method is not a one-size-fits-all solution. You can adapt it to your needs and preferences. The key is to find a system that works for you and stick to it.</p>
<p>And now, let's see how to use GTD in Outlook and Microsoft To Do.</p>
<h3 id="how-to-use-gtd-in-outlook-with-microsoft-to-do"><a class="toclink" href="../../2024/12/22/gtd-in-outlook-with-microsoft-to-do/#how-to-use-gtd-in-outlook-with-microsoft-to-do">How to use GTD in Outlook with Microsoft To Do</a></h3>
<p>When it comes to implementing the GTD method in Outlook, the key is to use the right tools and techniques. Microsoft To Do is a great tool for managing your tasks and projects, and it integrates seamlessly with Outlook.</p>
<p>You can use Outlook to implement the GTD method by following these steps:</p>
<ol>
<li>Capture:<ul>
<li>emails: Use the Inbox to collect everything that has your attention.</li>
<li>Other Things: Use Microsoft To Do Taks default list to capture tasks and projects.</li>
</ul>
</li>
<li>Clarify: Process what you've captured by asking yourself the following questions:<ul>
<li>What is this?</li>
<li>What should I do?</li>
<li>Is this really worth doing?</li>
<li>How does it fit in with all the other things I have to do?</li>
<li>Is there any action that needs to be done about it or because of it?</li>
</ul>
</li>
<li>Organize: Put everything in its place by following these steps:<ul>
<li>Inbox:<ul>
<li>Move emails to the appropriate folder or delete them.</li>
<li>Categories: Use categories to organize your emails by context and folder to organize your emails by project or client.</li>
<li>Use search folders to find emails quickly by category or categories, you can clear categories after processing.</li>
<li>Flags emails to add to To Do.</li>
<li>Create rules to automate repetitive tasks when clarifying one type of email has allways the same action.</li>
</ul>
</li>
<li>Tasks: Organize your tasks and projects in Microsoft To Do.<ul>
<li>Lists: Create lists for different types of tasks, one by context or use #tags for that in one lists. For example:<ul>
<li>In the case of lists: Agendas, Anywhere, Calls, Computed, Errands, Home, Office, Waiting For, Someday/Maybe.</li>
<li>In the case of tags, one list with: #Agendas, #Anywhere, #Calls, #Computed, #Errands, #Home, #Office, #WaitingFor, #SomedayMaybe.</li>
</ul>
</li>
<li>Use tag #nextaction to identify the next task to do.</li>
<li>Use tag #urgent to identify urgent tasks.</li>
</ul>
</li>
<li>Projects<ul>
<li>Group Lists: Group lists by category of projects or client.</li>
<li>One list per project: Create a list for each project and add tasks to it.</li>
<li>Use #nextaction tag to identify the next task in each project.</li>
</ul>
</li>
<li>Reference Material:<ul>
<li>Store reference material in folders, better in OneDrive or SharePoint.</li>
<li>Use a folder structure to organize your reference material</li>
<li>Use search folders to find it quickly.</li>
<li>Use tags to identify the context of the reference material. You can use <a href="https://github.com/Dijji/FileMeta?tab=readme-ov-file">FileMeta</a> to add tags to files in Windows for non-taggeable files.</li>
</ul>
</li>
</ul>
</li>
<li>Reflect: Review your system regularly to make sure it's up to date.<ul>
<li>Daily Review</li>
<li>Weekly Review</li>
<li>Monthly Review</li>
<li>Annual Review</li>
</ul>
</li>
<li>Engage: Choose what to do and do it.<ul>
<li>Use the My Day Bar to see your tasks and events at a glance or in search bar type #nextaction to see all your next actions.</li>
</ul>
</li>
</ol>
<p>These are just some ideas to get you started. You can adapt the GTD method to your needs and preferences. The key is to find a system that works for you and stick to it.</p>
<p>My example of GTD in Outlook with Microsoft To Do:</p>
<p>Outlook:</p>
<p><img alt="alt text" src="../../2024/12/image-1.png"></p>
<p>To Do:</p>
<p><img alt="alt text" src="../../2024/12/image.png"></p>
<p>I'm using a mix of lists and tags with the same name to organize my tasks and projects. I have lists for different types of tasks, such as Agendas, Anywhere, Calls, Computed, Errands, Home, Office, Waiting For, and Someday/Maybe. I also use tags to identify the next action, urgent tasks and context of the task in projects.</p>
<p>In the case of emails, I use categories to organize them by context and folders to organize them by project or client. I also use search folders to find emails quickly by category or categories and filter by unreads. The reason for this is that I can clear categories after processing and in the mayorie of cases, I only need a quick review of the emails without the need to convert them into tasks.</p>
<p>By following these steps, you can implement the GTD method in Outlook and Microsoft To Do and improve your productivity and focus.</p>
<p>Good luck! ð</p>
<h3 id="references"><a class="toclink" href="../../2024/12/22/gtd-in-outlook-with-microsoft-to-do/#references">References</a></h3>
<ul>
<li><a href="https://youtu.be/Nob50sN4be0">How to use Microsoft To Do for Getting Things Done (GTD)</a></li>
<li><a href="https://gettingthingsdone.com/">Getting Things Done: The Art of Stress-Free Productivity</a></li>
<li><a href="https://support.microsoft.com/en-us/office/manage-email-messages-by-using-rules-in-outlook-c24f5dea-9465-4df4-ad17-a50704d66c59">Manage email messages by using rules in Outlook</a></li>
<li><a href="https://github.com/Dijji/FileMeta?tab=readme-ov-file">FileMeta</a></li>
</ul>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<nav class="md-post__authors md-typeset">
<span class="md-author">
<img alt="Rafael FernÃ¡ndez" src="https://avatars.githubusercontent.com/u/39990341">
</span>
</nav>
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2024-12-21 00:00:00+00:00">December 21, 2024</time></li>
<li class="md-meta__item">
            in
            
              <a class="md-meta__link" href="../../category/visual-studio-code/">Visual Studio Code</a></li>
<li class="md-meta__item">
            
              3 min read
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="how-to-sign-git-commits-in-visual-studio-code-in-windows-subsystem-for-linux-wsl"><a class="toclink" href="../../2024/12/21/how-to-sign-git-commits-in-visual-studio-code-in-windows-subsystem-for-linux-wsl/">How to sign Git commits in Visual Studio Code in Windows Subsystem for Linux (WSL)</a></h2>
<p>In this post, we will see how to sign Git commits in Visual Studio Code.</p>
<h3 id="prerequisites"><a class="toclink" href="../../2024/12/21/how-to-sign-git-commits-in-visual-studio-code-in-windows-subsystem-for-linux-wsl/#prerequisites">Prerequisites</a></h3>
<ul>
<li>Visual Studio Code</li>
<li>Git</li>
<li>gpg</li>
<li>gpg-agent</li>
<li>gpgconf</li>
<li>pinentry-gtk-2</li>
<li>Windows Subsystem for Linux (WSL) with Ubuntu 20.04</li>
</ul>
<h3 id="steps"><a class="toclink" href="../../2024/12/21/how-to-sign-git-commits-in-visual-studio-code-in-windows-subsystem-for-linux-wsl/#steps">Steps</a></h3>
<h4 id="1-install-gpg"><a class="toclink" href="../../2024/12/21/how-to-sign-git-commits-in-visual-studio-code-in-windows-subsystem-for-linux-wsl/#1-install-gpg">1. Install GPG</a></h4>
<p>First, you need to install GPG ans agents. You can do this by running the following command:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-36-1"><a href="#__codelineno-36-1" id="__codelineno-36-1" name="__codelineno-36-1"></a>sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>gpg<span class="w"> </span>gpg-agent<span class="w"> </span>gpgconf<span class="w"> </span>pinentry-gtk2<span class="w"> </span>-y
</span></code></pre></div>
<h4 id="2-generate-a-gpg-key"><a class="toclink" href="../../2024/12/21/how-to-sign-git-commits-in-visual-studio-code-in-windows-subsystem-for-linux-wsl/#2-generate-a-gpg-key">2. Generate a GPG key</a></h4>
<p>To generate a GPG key, run the following command:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-37-1"><a href="#__codelineno-37-1" id="__codelineno-37-1" name="__codelineno-37-1"></a>gpg<span class="w"> </span>--full-generate-key
</span></code></pre></div>
<p>You will be asked to enter your name, email, and passphrase. After that, the key will be generated.</p>
<h4 id="3-list-your-gpg-keys"><a class="toclink" href="../../2024/12/21/how-to-sign-git-commits-in-visual-studio-code-in-windows-subsystem-for-linux-wsl/#3-list-your-gpg-keys">3. List your GPG keys</a></h4>
<p>To list your GPG keys, run the following command:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-38-1"><a href="#__codelineno-38-1" id="__codelineno-38-1" name="__codelineno-38-1"></a>gpg<span class="w"> </span>--list-secret-keys<span class="w"> </span>--keyid-format<span class="w"> </span>LONG
</span></code></pre></div>
<p>You will see a list of your GPG keys. Copy the key ID of the key you want to use.</p>
<h4 id="4-configure-git-to-use-your-gpg-key"><a class="toclink" href="../../2024/12/21/how-to-sign-git-commits-in-visual-studio-code-in-windows-subsystem-for-linux-wsl/#4-configure-git-to-use-your-gpg-key">4. Configure Git to use your GPG key</a></h4>
<p>To configure Git to use your GPG key, run the following command:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-39-1"><a href="#__codelineno-39-1" id="__codelineno-39-1" name="__codelineno-39-1"></a>git<span class="w"> </span>config<span class="w"> </span>--global<span class="w"> </span>user.signingkey<span class="w"> </span>YOUR_KEY_ID
</span></code></pre></div>
<p>Replace <code>YOUR_KEY_ID</code> with the key ID you copied in the previous step.</p>
<h4 id="5-configure-git-to-sign-commits-by-default"><a class="toclink" href="../../2024/12/21/how-to-sign-git-commits-in-visual-studio-code-in-windows-subsystem-for-linux-wsl/#5-configure-git-to-sign-commits-by-default">5. Configure Git to sign commits by default</a></h4>
<p>To configure Git to sign commits by default, run the following command:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-40-1"><a href="#__codelineno-40-1" id="__codelineno-40-1" name="__codelineno-40-1"></a>git<span class="w"> </span>config<span class="w"> </span>--global<span class="w"> </span>commit.gpgsign<span class="w"> </span><span class="nb">true</span>
</span><span id="__span-40-2"><a href="#__codelineno-40-2" id="__codelineno-40-2" name="__codelineno-40-2"></a>git<span class="w"> </span>config<span class="w"> </span>--global<span class="w"> </span>gpg.program<span class="w"> </span><span class="o">(</span>which<span class="w"> </span>gpg<span class="o">)</span>
</span></code></pre></div>
<h4 id="6-export-the-gpg-key"><a class="toclink" href="../../2024/12/21/how-to-sign-git-commits-in-visual-studio-code-in-windows-subsystem-for-linux-wsl/#6-export-the-gpg-key">6. EXport the GPG key</a></h4>
<p>To export the GPG key, run the following command:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-41-1"><a href="#__codelineno-41-1" id="__codelineno-41-1" name="__codelineno-41-1"></a>gpg<span class="w"> </span>--armor<span class="w"> </span>--export<span class="w"> </span>YOUR_KEY_ID
</span></code></pre></div>
<p>Replace <code>YOUR_KEY_ID</code> with the key ID you copied in the previous step.</p>
<h4 id="7-import-to-github"><a class="toclink" href="../../2024/12/21/how-to-sign-git-commits-in-visual-studio-code-in-windows-subsystem-for-linux-wsl/#7-import-to-github">7. Import to github</a></h4>
<p>Go to your <a href="https://github.com/settings/keys">github account</a> and add the exported GPG key in GPG keys section, create a new GPG key and paste the exported key.</p>
<h4 id="configure-visual-studio-code-to-use-gpg"><a class="toclink" href="../../2024/12/21/how-to-sign-git-commits-in-visual-studio-code-in-windows-subsystem-for-linux-wsl/#configure-visual-studio-code-to-use-gpg">Configure Visual Studio Code to use GPG</a></h4>
<h5 id="1-configure-gpg-agent"><a class="toclink" href="../../2024/12/21/how-to-sign-git-commits-in-visual-studio-code-in-windows-subsystem-for-linux-wsl/#1-configure-gpg-agent">1. Configure gpg-agent</a></h5>
<p>To configure gpg-agent, run the following command:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-42-1"><a href="#__codelineno-42-1" id="__codelineno-42-1" name="__codelineno-42-1"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">"default-cache-ttl"</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>~/.gnupg/gpg-agent.conf
</span><span id="__span-42-2"><a href="#__codelineno-42-2" id="__codelineno-42-2" name="__codelineno-42-2"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">"pinentry-program /usr/bin/pinentry-gtk-2"</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>~/.gnupg/gpg-agent.conf
</span><span id="__span-42-3"><a href="#__codelineno-42-3" id="__codelineno-42-3" name="__codelineno-42-3"></a><span class="nb">echo</span><span class="w"> </span><span class="s2">"allow-preset-passphrase"</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>~/.gnupg/gpg-agent.conf
</span></code></pre></div>
<h4 id="2-restart-the-gpg-agent"><a class="toclink" href="../../2024/12/21/how-to-sign-git-commits-in-visual-studio-code-in-windows-subsystem-for-linux-wsl/#2-restart-the-gpg-agent">2. Restart the gpg-agent</a></h4>
<p>To restart the gpg-agent, run the following command:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-43-1"><a href="#__codelineno-43-1" id="__codelineno-43-1" name="__codelineno-43-1"></a>gpgconf<span class="w"> </span>--kill<span class="w"> </span>gpg-agent
</span><span id="__span-43-2"><a href="#__codelineno-43-2" id="__codelineno-43-2" name="__codelineno-43-2"></a>gpgconf<span class="w"> </span>--launch<span class="w"> </span>gpg-agent
</span></code></pre></div>
<h4 id="3-sign-a-commit"><a class="toclink" href="../../2024/12/21/how-to-sign-git-commits-in-visual-studio-code-in-windows-subsystem-for-linux-wsl/#3-sign-a-commit">3. Sign a commit</a></h4>
<p>To sign a commit, run the following command:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-44-1"><a href="#__codelineno-44-1" id="__codelineno-44-1" name="__codelineno-44-1"></a>git<span class="w"> </span>commit<span class="w"> </span>-S<span class="w"> </span>-m<span class="w"> </span><span class="s2">"Your commit message"</span>
</span></code></pre></div>
<h4 id="4-verify-the-signature"><a class="toclink" href="../../2024/12/21/how-to-sign-git-commits-in-visual-studio-code-in-windows-subsystem-for-linux-wsl/#4-verify-the-signature">4. Verify the signature</a></h4>
<p>To verify the signature of a commit, run the following command:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-45-1"><a href="#__codelineno-45-1" id="__codelineno-45-1" name="__codelineno-45-1"></a>git<span class="w"> </span>verify-commit<span class="w"> </span>HEAD
</span></code></pre></div>
<h4 id="5-configure-visual-studio-code-to-use-gpg"><a class="toclink" href="../../2024/12/21/how-to-sign-git-commits-in-visual-studio-code-in-windows-subsystem-for-linux-wsl/#5-configure-visual-studio-code-to-use-gpg">5. Configure Visual Studio Code to use GPG</a></h4>
<p>To configure Visual Studio Code to use GPG, open the settings by pressing <code>Ctrl + ,</code> and search for <code>git.enableCommitSigning</code>. Set the value to <code>true</code>.</p>
<h4 id="6-sign-a-commit"><a class="toclink" href="../../2024/12/21/how-to-sign-git-commits-in-visual-studio-code-in-windows-subsystem-for-linux-wsl/#6-sign-a-commit">6. Sign a commit</a></h4>
<p>Make a commit in Visual Studio Code, and you will see a prompt asking you introduce your GPG passphrase. Enter your passphrase, and the commit will be signed.</p>
<p>That's it! Now you know how to sign Git commits in Visual Studio Code.</p>
<h3 id="some-tips"><a class="toclink" href="../../2024/12/21/how-to-sign-git-commits-in-visual-studio-code-in-windows-subsystem-for-linux-wsl/#some-tips">Some tips</a></h3>
<h3 id="for-all-repositories"><a class="toclink" href="../../2024/12/21/how-to-sign-git-commits-in-visual-studio-code-in-windows-subsystem-for-linux-wsl/#for-all-repositories">For all repositories</a></h3>
<ul>
<li>Establish your email in git configuration:</li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-46-1"><a href="#__codelineno-46-1" id="__codelineno-46-1" name="__codelineno-46-1"></a>git<span class="w"> </span>config<span class="w"> </span>--global<span class="w"> </span>user.email<span class="w"> </span><span class="s2">"petete@something.es"</span>
</span></code></pre></div>
<ul>
<li>Establish your name in git configuration:</li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-47-1"><a href="#__codelineno-47-1" id="__codelineno-47-1" name="__codelineno-47-1"></a>git<span class="w"> </span>config<span class="w"> </span>--global<span class="w"> </span>user.name<span class="w"> </span><span class="s2">"Petete"</span>
</span></code></pre></div>
<ul>
<li>Establish your GPG key in git configuration:</li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-48-1"><a href="#__codelineno-48-1" id="__codelineno-48-1" name="__codelineno-48-1"></a>git<span class="w"> </span>config<span class="w"> </span>--global<span class="w"> </span>user.signingkey<span class="w"> </span>YOUR_KEY_ID
</span></code></pre></div>
<ul>
<li>Establish your GPG program in git configuration:</li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-49-1"><a href="#__codelineno-49-1" id="__codelineno-49-1" name="__codelineno-49-1"></a>git<span class="w"> </span>config<span class="w"> </span>--global<span class="w"> </span>gpg.program<span class="w"> </span><span class="o">(</span>which<span class="w"> </span>gpg<span class="o">)</span>
</span></code></pre></div>
<h3 id="for-a-specific-repository"><a class="toclink" href="../../2024/12/21/how-to-sign-git-commits-in-visual-studio-code-in-windows-subsystem-for-linux-wsl/#for-a-specific-repository">For a specific repository</a></h3>
<ul>
<li>Establish your email in git configuration:</li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-50-1"><a href="#__codelineno-50-1" id="__codelineno-50-1" name="__codelineno-50-1"></a>git<span class="w"> </span>config<span class="w"> </span>user.email<span class="w"> </span><span class="s2">"petete@something.es"</span>
</span></code></pre></div>
<ul>
<li>Establish your name in git configuration:</li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-51-1"><a href="#__codelineno-51-1" id="__codelineno-51-1" name="__codelineno-51-1"></a>git<span class="w"> </span>config<span class="w"> </span>user.name<span class="w"> </span><span class="s2">"Petete"</span>
</span></code></pre></div>
<ul>
<li>Establish your GPG key in git configuration:</li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-52-1"><a href="#__codelineno-52-1" id="__codelineno-52-1" name="__codelineno-52-1"></a>git<span class="w"> </span>config<span class="w"> </span>user.signingkey<span class="w"> </span>YOUR_KEY_ID
</span></code></pre></div>
<ul>
<li>Establish your GPG program in git configuration:</li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-53-1"><a href="#__codelineno-53-1" id="__codelineno-53-1" name="__codelineno-53-1"></a>git<span class="w"> </span>config<span class="w"> </span>gpg.program<span class="w"> </span><span class="o">(</span>which<span class="w"> </span>gpg<span class="o">)</span>
</span></code></pre></div>
<h3 id="conclusion"><a class="toclink" href="../../2024/12/21/how-to-sign-git-commits-in-visual-studio-code-in-windows-subsystem-for-linux-wsl/#conclusion">Conclusion</a></h3>
<p>In this post, we saw how to sign Git commits in Visual Studio Code. This is useful if you want to verify the authenticity of your commits. I hope you found this post helpful. If you have any questions or comments, please let me know. Thank you for reading!</p>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<nav class="md-post__authors md-typeset">
<span class="md-author">
<img alt="Rafael FernÃ¡ndez" src="https://avatars.githubusercontent.com/u/39990341">
</span>
</nav>
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2024-12-12 00:00:00+00:00">December 12, 2024</time></li>
<li class="md-meta__item">
            in
            
              <a class="md-meta__link" href="../../category/hashicorp/">HashiCorp</a></li>
<li class="md-meta__item">
            
              4 min read
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="ejecutar-terraform-con-archivos-de-variables"><a class="toclink" href="../../2024/12/12/ejecutar-terraform-con-archivos-de-variables/">Ejecutar Terraform con archivos de variables</a></h2>
<p>En ocasiones, cuando trabajamos con Terraform, necesitamos gestionar mÃºltiples archivos de variables para diferentes entornos o configuraciones. En este post, os muestro cÃ³mo ejecutar Terraform con archivos de variables de forma sencilla.</p>
<h3 id="terraform-y-archivos-de-variables"><a class="toclink" href="../../2024/12/12/ejecutar-terraform-con-archivos-de-variables/#terraform-y-archivos-de-variables">Terraform y archivos de variables</a></h3>
<p>Terraform permite cargar variables desde archivos <code>.tfvars</code> mediante la opciÃ³n <code>--var-file</code>. Por ejemplo, si tenemos un archivo <code>variables.tf</code> con la siguiente definiciÃ³n:</p>
<div class="language-hcl highlight"><pre><span></span><code><span id="__span-10-1"><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">"region"</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-2"><a href="#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a><span class="w">  </span><span class="na">type</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
</span><span id="__span-10-3"><a href="#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a><span class="w">  </span><span class="na">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"westeurope"</span>
</span><span id="__span-10-4"><a href="#__codelineno-10-4" id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="p">}</span>
</span><span id="__span-10-5"><a href="#__codelineno-10-5" id="__codelineno-10-5" name="__codelineno-10-5"></a>
</span><span id="__span-10-6"><a href="#__codelineno-10-6" id="__codelineno-10-6" name="__codelineno-10-6"></a><span class="kr">variable</span><span class="w"> </span><span class="nv">"resource_group_name"</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-7"><a href="#__codelineno-10-7" id="__codelineno-10-7" name="__codelineno-10-7"></a><span class="w">  </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">string</span>
</span><span id="__span-10-8"><a href="#__codelineno-10-8" id="__codelineno-10-8" name="__codelineno-10-8"></a><span class="p">}</span>
</span></code></pre></div>
<p>Podemos crear un archivo <code>variables.tfvars</code> con los valores de las variables:</p>
<div class="language-hcl highlight"><pre><span></span><code><span id="__span-11-1"><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="na">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"westeurope"</span>
</span><span id="__span-11-2"><a href="#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="na">resource_group_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"my-rg"</span>
</span></code></pre></div>
<p>Y ejecutar Terraform con el archivo de variables:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-12-1"><a href="#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a>terraform<span class="w"> </span>plan<span class="w"> </span>--var-file<span class="w"> </span>variables.tfvars
</span></code></pre></div>
<h3 id="ejecutar-terraform-con-multiples-archivos-de-variables"><a class="toclink" href="../../2024/12/12/ejecutar-terraform-con-archivos-de-variables/#ejecutar-terraform-con-multiples-archivos-de-variables">Ejecutar Terraform con mÃºltiples archivos de variables</a></h3>
<p>Si tenemos mÃºltiples archivos de variables, podemos ejecutar Terraform con todos ellos de forma sencilla. Para ello, podemos crear un script que busque los archivos <code>.tfvars</code> en un directorio y ejecute Terraform con ellos.</p>
<p>El problema de ejecutar Terraform con mÃºltiples archivos de variables es que la opciÃ³n <code>--var-file</code> no admite un array de archivos. Por lo tanto, necesitamos construir el comando de Terraform con todos los archivos de variables, lo cual puede ser un poco tedioso.</p>
<p>A continuaciÃ³n, os muestro un ejemplo de cÃ³mo crear una funciÃ³n en Bash/pwsh que ejecuta Terraform con archivos de variables:</p>
<div class="admonition example">
<p class="admonition-title">Example</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio"><input id="__tabbed_3_2" name="__tabbed_3" type="radio"><div class="tabbed-labels"><label for="__tabbed_3_1">bash</label><label for="__tabbed_3_2">pwsh</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="language-bash highlight"><span class="filename">terraform_with_var_files.sh</span><pre><span></span><code><span id="__span-13-1"><a href="#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a><span class="w">  </span><span class="k">function</span><span class="w"> </span>terraform_with_var_files<span class="o">()</span><span class="w"> </span><span class="o">{</span>
</span><span id="__span-13-2"><a href="#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"--help"</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"-h"</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-13-3"><a href="#__codelineno-13-3" id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Usage: terraform_with_var_files [OPTIONS]"</span>
</span><span id="__span-13-4"><a href="#__codelineno-13-4" id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Options:"</span>
</span><span id="__span-13-5"><a href="#__codelineno-13-5" id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"  --dir DIR                Specify the directory containing .tfvars files"</span>
</span><span id="__span-13-6"><a href="#__codelineno-13-6" id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"  --action ACTION          Specify the Terraform action (plan, apply, destroy, import)"</span>
</span><span id="__span-13-7"><a href="#__codelineno-13-7" id="__codelineno-13-7" name="__codelineno-13-7"></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"  --auto AUTO              Specify 'auto' for auto-approve (optional)"</span>
</span><span id="__span-13-8"><a href="#__codelineno-13-8" id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"  --resource_address ADDR  Specify the resource address for import action (optional)"</span>
</span><span id="__span-13-9"><a href="#__codelineno-13-9" id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"  --resource_id ID         Specify the resource ID for import action (optional)"</span>
</span><span id="__span-13-10"><a href="#__codelineno-13-10" id="__codelineno-13-10" name="__codelineno-13-10"></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"  --workspace WORKSPACE    Specify the Terraform workspace (default: default)"</span>
</span><span id="__span-13-11"><a href="#__codelineno-13-11" id="__codelineno-13-11" name="__codelineno-13-11"></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"  --help, -h               Show this help message"</span>
</span><span id="__span-13-12"><a href="#__codelineno-13-12" id="__codelineno-13-12" name="__codelineno-13-12"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="m">0</span>
</span><span id="__span-13-13"><a href="#__codelineno-13-13" id="__codelineno-13-13" name="__codelineno-13-13"></a><span class="w">  </span><span class="k">fi</span>
</span><span id="__span-13-14"><a href="#__codelineno-13-14" id="__codelineno-13-14" name="__codelineno-13-14"></a>
</span><span id="__span-13-15"><a href="#__codelineno-13-15" id="__codelineno-13-15" name="__codelineno-13-15"></a><span class="w">  </span><span class="nb">local</span><span class="w"> </span><span class="nv">dir</span><span class="o">=</span><span class="s2">""</span>
</span><span id="__span-13-16"><a href="#__codelineno-13-16" id="__codelineno-13-16" name="__codelineno-13-16"></a><span class="w">  </span><span class="nb">local</span><span class="w"> </span><span class="nv">action</span><span class="o">=</span><span class="s2">""</span>
</span><span id="__span-13-17"><a href="#__codelineno-13-17" id="__codelineno-13-17" name="__codelineno-13-17"></a><span class="w">  </span><span class="nb">local</span><span class="w"> </span><span class="nv">auto</span><span class="o">=</span><span class="s2">""</span>
</span><span id="__span-13-18"><a href="#__codelineno-13-18" id="__codelineno-13-18" name="__codelineno-13-18"></a><span class="w">  </span><span class="nb">local</span><span class="w"> </span><span class="nv">resource_address</span><span class="o">=</span><span class="s2">""</span>
</span><span id="__span-13-19"><a href="#__codelineno-13-19" id="__codelineno-13-19" name="__codelineno-13-19"></a><span class="w">  </span><span class="nb">local</span><span class="w"> </span><span class="nv">resource_id</span><span class="o">=</span><span class="s2">""</span>
</span><span id="__span-13-20"><a href="#__codelineno-13-20" id="__codelineno-13-20" name="__codelineno-13-20"></a><span class="w">  </span><span class="nb">local</span><span class="w"> </span><span class="nv">workspace</span><span class="o">=</span><span class="s2">"default"</span>
</span><span id="__span-13-21"><a href="#__codelineno-13-21" id="__codelineno-13-21" name="__codelineno-13-21"></a>
</span><span id="__span-13-22"><a href="#__codelineno-13-22" id="__codelineno-13-22" name="__codelineno-13-22"></a><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">"</span><span class="nv">$#</span><span class="s2">"</span><span class="w"> </span>-gt<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-13-23"><a href="#__codelineno-13-23" id="__codelineno-13-23" name="__codelineno-13-23"></a><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span><span class="w"> </span><span class="k">in</span>
</span><span id="__span-13-24"><a href="#__codelineno-13-24" id="__codelineno-13-24" name="__codelineno-13-24"></a><span class="w">      </span>--dir<span class="o">)</span><span class="w"> </span><span class="nv">dir</span><span class="o">=</span><span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span><span class="p">;</span><span class="w"> </span><span class="nb">shift</span><span class="w"> </span><span class="p">;;</span>
</span><span id="__span-13-25"><a href="#__codelineno-13-25" id="__codelineno-13-25" name="__codelineno-13-25"></a><span class="w">      </span>--action<span class="o">)</span><span class="w"> </span><span class="nv">action</span><span class="o">=</span><span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span><span class="p">;</span><span class="w"> </span><span class="nb">shift</span><span class="w"> </span><span class="p">;;</span>
</span><span id="__span-13-26"><a href="#__codelineno-13-26" id="__codelineno-13-26" name="__codelineno-13-26"></a><span class="w">      </span>--auto<span class="o">)</span><span class="w"> </span><span class="nv">auto</span><span class="o">=</span><span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span><span class="p">;</span><span class="w"> </span><span class="nb">shift</span><span class="w"> </span><span class="p">;;</span>
</span><span id="__span-13-27"><a href="#__codelineno-13-27" id="__codelineno-13-27" name="__codelineno-13-27"></a><span class="w">      </span>--resource_address<span class="o">)</span><span class="w"> </span><span class="nv">resource_address</span><span class="o">=</span><span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span><span class="p">;</span><span class="w"> </span><span class="nb">shift</span><span class="w"> </span><span class="p">;;</span>
</span><span id="__span-13-28"><a href="#__codelineno-13-28" id="__codelineno-13-28" name="__codelineno-13-28"></a><span class="w">      </span>--resource_id<span class="o">)</span><span class="w"> </span><span class="nv">resource_id</span><span class="o">=</span><span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span><span class="p">;</span><span class="w"> </span><span class="nb">shift</span><span class="w"> </span><span class="p">;;</span>
</span><span id="__span-13-29"><a href="#__codelineno-13-29" id="__codelineno-13-29" name="__codelineno-13-29"></a><span class="w">      </span>--workspace<span class="o">)</span><span class="w"> </span><span class="nv">workspace</span><span class="o">=</span><span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span><span class="p">;</span><span class="w"> </span><span class="nb">shift</span><span class="w"> </span><span class="p">;;</span>
</span><span id="__span-13-30"><a href="#__codelineno-13-30" id="__codelineno-13-30" name="__codelineno-13-30"></a><span class="w">      </span>*<span class="o">)</span><span class="w"> </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Unknown parameter passed: </span><span class="nv">$1</span><span class="s2">"</span><span class="p">;</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">;;</span>
</span><span id="__span-13-31"><a href="#__codelineno-13-31" id="__codelineno-13-31" name="__codelineno-13-31"></a><span class="w">    </span><span class="k">esac</span>
</span><span id="__span-13-32"><a href="#__codelineno-13-32" id="__codelineno-13-32" name="__codelineno-13-32"></a><span class="w">    </span><span class="nb">shift</span>
</span><span id="__span-13-33"><a href="#__codelineno-13-33" id="__codelineno-13-33" name="__codelineno-13-33"></a><span class="w">  </span><span class="k">done</span>
</span><span id="__span-13-34"><a href="#__codelineno-13-34" id="__codelineno-13-34" name="__codelineno-13-34"></a>
</span><span id="__span-13-35"><a href="#__codelineno-13-35" id="__codelineno-13-35" name="__codelineno-13-35"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>!<span class="w"> </span>-d<span class="w"> </span><span class="s2">"</span><span class="nv">$dir</span><span class="s2">"</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-13-36"><a href="#__codelineno-13-36" id="__codelineno-13-36" name="__codelineno-13-36"></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"El directorio especificado no existe."</span>
</span><span id="__span-13-37"><a href="#__codelineno-13-37" id="__codelineno-13-37" name="__codelineno-13-37"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
</span><span id="__span-13-38"><a href="#__codelineno-13-38" id="__codelineno-13-38" name="__codelineno-13-38"></a><span class="w">  </span><span class="k">fi</span>
</span><span id="__span-13-39"><a href="#__codelineno-13-39" id="__codelineno-13-39" name="__codelineno-13-39"></a>
</span><span id="__span-13-40"><a href="#__codelineno-13-40" id="__codelineno-13-40" name="__codelineno-13-40"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">"</span><span class="nv">$action</span><span class="s2">"</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">"plan"</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s2">"</span><span class="nv">$action</span><span class="s2">"</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">"apply"</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s2">"</span><span class="nv">$action</span><span class="s2">"</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">"destroy"</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="s2">"</span><span class="nv">$action</span><span class="s2">"</span><span class="w"> </span>!<span class="o">=</span><span class="w"> </span><span class="s2">"import"</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-13-41"><a href="#__codelineno-13-41" id="__codelineno-13-41" name="__codelineno-13-41"></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"AcciÃ³n no vÃ¡lida. Usa 'plan', 'apply', 'destroy' o 'import'."</span>
</span><span id="__span-13-42"><a href="#__codelineno-13-42" id="__codelineno-13-42" name="__codelineno-13-42"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
</span><span id="__span-13-43"><a href="#__codelineno-13-43" id="__codelineno-13-43" name="__codelineno-13-43"></a><span class="w">  </span><span class="k">fi</span>
</span><span id="__span-13-44"><a href="#__codelineno-13-44" id="__codelineno-13-44" name="__codelineno-13-44"></a>
</span><span id="__span-13-45"><a href="#__codelineno-13-45" id="__codelineno-13-45" name="__codelineno-13-45"></a><span class="w">  </span><span class="nb">local</span><span class="w"> </span><span class="nv">var_files</span><span class="o">=()</span>
</span><span id="__span-13-46"><a href="#__codelineno-13-46" id="__codelineno-13-46" name="__codelineno-13-46"></a><span class="w">  </span><span class="k">for</span><span class="w"> </span>file<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="s2">"</span><span class="nv">$dir</span><span class="s2">"</span>/*.tfvars<span class="p">;</span><span class="w"> </span><span class="k">do</span>
</span><span id="__span-13-47"><a href="#__codelineno-13-47" id="__codelineno-13-47" name="__codelineno-13-47"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-f<span class="w"> </span><span class="s2">"</span><span class="nv">$file</span><span class="s2">"</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-13-48"><a href="#__codelineno-13-48" id="__codelineno-13-48" name="__codelineno-13-48"></a><span class="w">      </span><span class="nv">var_files</span><span class="o">+=(</span><span class="s2">"--var-file </span><span class="nv">$file</span><span class="s2">"</span><span class="o">)</span>
</span><span id="__span-13-49"><a href="#__codelineno-13-49" id="__codelineno-13-49" name="__codelineno-13-49"></a><span class="w">    </span><span class="k">fi</span>
</span><span id="__span-13-50"><a href="#__codelineno-13-50" id="__codelineno-13-50" name="__codelineno-13-50"></a><span class="w">  </span><span class="k">done</span>
</span><span id="__span-13-51"><a href="#__codelineno-13-51" id="__codelineno-13-51" name="__codelineno-13-51"></a>
</span><span id="__span-13-52"><a href="#__codelineno-13-52" id="__codelineno-13-52" name="__codelineno-13-52"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="si">${#</span><span class="nv">var_files</span><span class="p">[@]</span><span class="si">}</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-13-53"><a href="#__codelineno-13-53" id="__codelineno-13-53" name="__codelineno-13-53"></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"No se encontraron archivos .tfvars en el directorio especificado."</span>
</span><span id="__span-13-54"><a href="#__codelineno-13-54" id="__codelineno-13-54" name="__codelineno-13-54"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
</span><span id="__span-13-55"><a href="#__codelineno-13-55" id="__codelineno-13-55" name="__codelineno-13-55"></a><span class="w">  </span><span class="k">fi</span>
</span><span id="__span-13-56"><a href="#__codelineno-13-56" id="__codelineno-13-56" name="__codelineno-13-56"></a>
</span><span id="__span-13-57"><a href="#__codelineno-13-57" id="__codelineno-13-57" name="__codelineno-13-57"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Inicializando Terraform..."</span>
</span><span id="__span-13-58"><a href="#__codelineno-13-58" id="__codelineno-13-58" name="__codelineno-13-58"></a><span class="w">  </span><span class="nb">eval</span><span class="w"> </span>terraform<span class="w"> </span>init
</span><span id="__span-13-59"><a href="#__codelineno-13-59" id="__codelineno-13-59" name="__codelineno-13-59"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="nv">$?</span><span class="w"> </span>-ne<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-13-60"><a href="#__codelineno-13-60" id="__codelineno-13-60" name="__codelineno-13-60"></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"La inicializaciÃ³n de Terraform fallÃ³."</span>
</span><span id="__span-13-61"><a href="#__codelineno-13-61" id="__codelineno-13-61" name="__codelineno-13-61"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
</span><span id="__span-13-62"><a href="#__codelineno-13-62" id="__codelineno-13-62" name="__codelineno-13-62"></a><span class="w">  </span><span class="k">fi</span>
</span><span id="__span-13-63"><a href="#__codelineno-13-63" id="__codelineno-13-63" name="__codelineno-13-63"></a>
</span><span id="__span-13-64"><a href="#__codelineno-13-64" id="__codelineno-13-64" name="__codelineno-13-64"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Seleccionando el workspace: </span><span class="nv">$workspace</span><span class="s2">"</span>
</span><span id="__span-13-65"><a href="#__codelineno-13-65" id="__codelineno-13-65" name="__codelineno-13-65"></a><span class="w">  </span><span class="nb">eval</span><span class="w"> </span>terraform<span class="w"> </span>workspace<span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="s2">"</span><span class="nv">$workspace</span><span class="s2">"</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">eval</span><span class="w"> </span>terraform<span class="w"> </span>workspace<span class="w"> </span>new<span class="w"> </span><span class="s2">"</span><span class="nv">$workspace</span><span class="s2">"</span>
</span><span id="__span-13-66"><a href="#__codelineno-13-66" id="__codelineno-13-66" name="__codelineno-13-66"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="nv">$?</span><span class="w"> </span>-ne<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-13-67"><a href="#__codelineno-13-67" id="__codelineno-13-67" name="__codelineno-13-67"></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"La selecciÃ³n del workspace fallÃ³."</span>
</span><span id="__span-13-68"><a href="#__codelineno-13-68" id="__codelineno-13-68" name="__codelineno-13-68"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
</span><span id="__span-13-69"><a href="#__codelineno-13-69" id="__codelineno-13-69" name="__codelineno-13-69"></a><span class="w">  </span><span class="k">fi</span>
</span><span id="__span-13-70"><a href="#__codelineno-13-70" id="__codelineno-13-70" name="__codelineno-13-70"></a>
</span><span id="__span-13-71"><a href="#__codelineno-13-71" id="__codelineno-13-71" name="__codelineno-13-71"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Validando la configuraciÃ³n de Terraform..."</span>
</span><span id="__span-13-72"><a href="#__codelineno-13-72" id="__codelineno-13-72" name="__codelineno-13-72"></a><span class="w">  </span><span class="nb">eval</span><span class="w"> </span>terraform<span class="w"> </span>validate
</span><span id="__span-13-73"><a href="#__codelineno-13-73" id="__codelineno-13-73" name="__codelineno-13-73"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="nv">$?</span><span class="w"> </span>-ne<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-13-74"><a href="#__codelineno-13-74" id="__codelineno-13-74" name="__codelineno-13-74"></a><span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"La validaciÃ³n de Terraform fallÃ³."</span>
</span><span id="__span-13-75"><a href="#__codelineno-13-75" id="__codelineno-13-75" name="__codelineno-13-75"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
</span><span id="__span-13-76"><a href="#__codelineno-13-76" id="__codelineno-13-76" name="__codelineno-13-76"></a><span class="w">  </span><span class="k">fi</span>
</span><span id="__span-13-77"><a href="#__codelineno-13-77" id="__codelineno-13-77" name="__codelineno-13-77"></a>
</span><span id="__span-13-78"><a href="#__codelineno-13-78" id="__codelineno-13-78" name="__codelineno-13-78"></a><span class="w">  </span><span class="nb">local</span><span class="w"> </span><span class="nv">command</span><span class="o">=</span><span class="s2">"terraform </span><span class="nv">$action</span><span class="s2"> </span><span class="si">${</span><span class="nv">var_files</span><span class="p">[@]</span><span class="si">}</span><span class="s2">"</span>
</span><span id="__span-13-79"><a href="#__codelineno-13-79" id="__codelineno-13-79" name="__codelineno-13-79"></a>
</span><span id="__span-13-80"><a href="#__codelineno-13-80" id="__codelineno-13-80" name="__codelineno-13-80"></a><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">"</span><span class="nv">$action</span><span class="s2">"</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"import"</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-13-81"><a href="#__codelineno-13-81" id="__codelineno-13-81" name="__codelineno-13-81"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">"</span><span class="nv">$resource_address</span><span class="s2">"</span><span class="w"> </span><span class="o">||</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">"</span><span class="nv">$resource_id</span><span class="s2">"</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-13-82"><a href="#__codelineno-13-82" id="__codelineno-13-82" name="__codelineno-13-82"></a><span class="w">      </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Para la acciÃ³n 'import', se deben proporcionar la direcciÃ³n del recurso y el ID del recurso."</span>
</span><span id="__span-13-83"><a href="#__codelineno-13-83" id="__codelineno-13-83" name="__codelineno-13-83"></a><span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="m">1</span>
</span><span id="__span-13-84"><a href="#__codelineno-13-84" id="__codelineno-13-84" name="__codelineno-13-84"></a><span class="w">    </span><span class="k">fi</span>
</span><span id="__span-13-85"><a href="#__codelineno-13-85" id="__codelineno-13-85" name="__codelineno-13-85"></a><span class="w">    </span><span class="nv">command</span><span class="o">=</span><span class="s2">"terraform </span><span class="nv">$action</span><span class="s2"> </span><span class="si">${</span><span class="nv">var_files</span><span class="p">[@]</span><span class="si">}</span><span class="s2"> </span><span class="nv">$resource_address</span><span class="s2"> </span><span class="nv">$resource_id</span><span class="s2">"</span>
</span><span id="__span-13-86"><a href="#__codelineno-13-86" id="__codelineno-13-86" name="__codelineno-13-86"></a><span class="w">  </span><span class="k">elif</span><span class="w"> </span><span class="o">[[</span><span class="w"> </span><span class="s2">"</span><span class="nv">$auto</span><span class="s2">"</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"auto"</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">(</span><span class="w"> </span><span class="s2">"</span><span class="nv">$action</span><span class="s2">"</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"apply"</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s2">"</span><span class="nv">$action</span><span class="s2">"</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"destroy"</span><span class="w"> </span><span class="o">)</span><span class="w"> </span><span class="o">]]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
</span><span id="__span-13-87"><a href="#__codelineno-13-87" id="__codelineno-13-87" name="__codelineno-13-87"></a><span class="w">    </span><span class="nv">command</span><span class="o">=</span><span class="s2">"</span><span class="nv">$command</span><span class="s2"> -auto-approve"</span>
</span><span id="__span-13-88"><a href="#__codelineno-13-88" id="__codelineno-13-88" name="__codelineno-13-88"></a><span class="w">  </span><span class="k">fi</span>
</span><span id="__span-13-89"><a href="#__codelineno-13-89" id="__codelineno-13-89" name="__codelineno-13-89"></a>
</span><span id="__span-13-90"><a href="#__codelineno-13-90" id="__codelineno-13-90" name="__codelineno-13-90"></a><span class="w">  </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Ejecutando: </span><span class="nv">$command</span><span class="s2">"</span>
</span><span id="__span-13-91"><a href="#__codelineno-13-91" id="__codelineno-13-91" name="__codelineno-13-91"></a><span class="w">  </span><span class="nb">eval</span><span class="w"> </span><span class="s2">"</span><span class="nv">$command</span><span class="s2">"</span>
</span><span id="__span-13-92"><a href="#__codelineno-13-92" id="__codelineno-13-92" name="__codelineno-13-92"></a><span class="o">}</span>
</span><span id="__span-13-93"><a href="#__codelineno-13-93" id="__codelineno-13-93" name="__codelineno-13-93"></a>
</span><span id="__span-13-94"><a href="#__codelineno-13-94" id="__codelineno-13-94" name="__codelineno-13-94"></a><span class="c1"># Uso de la funciÃ³n</span>
</span><span id="__span-13-95"><a href="#__codelineno-13-95" id="__codelineno-13-95" name="__codelineno-13-95"></a><span class="c1"># terraform_with_var_files --dir "/ruta/al/directorio" --action "plan" --workspace "workspace"</span>
</span><span id="__span-13-96"><a href="#__codelineno-13-96" id="__codelineno-13-96" name="__codelineno-13-96"></a><span class="c1"># terraform_with_var_files --dir "/ruta/al/directorio" --action "apply" --auto "auto" --workspace "workspace"</span>
</span><span id="__span-13-97"><a href="#__codelineno-13-97" id="__codelineno-13-97" name="__codelineno-13-97"></a><span class="c1"># terraform_with_var_files --dir "/ruta/al/directorio" --action "destroy" --auto "auto" --workspace "workspace"</span>
</span><span id="__span-13-98"><a href="#__codelineno-13-98" id="__codelineno-13-98" name="__codelineno-13-98"></a><span class="c1"># terraform_with_var_files --dir "/ruta/al/directorio" --action "import" --resource_address "resource_address" --resource_id "resource_id" --workspace "workspace"</span>
</span></code></pre></div>
</div>
<div class="tabbed-block">
<div class="language-pwsh highlight"><span class="filename">terraform_with_var_files.ps1</span><pre><span></span><code><span id="__span-14-1"><a href="#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="k">function</span> <span class="n">Terraform-WithVarFiles</span> <span class="p">{</span>
</span><span id="__span-14-2"><a href="#__codelineno-14-2" id="__codelineno-14-2" name="__codelineno-14-2"></a>    <span class="k">param</span> <span class="p">(</span>
</span><span id="__span-14-3"><a href="#__codelineno-14-3" id="__codelineno-14-3" name="__codelineno-14-3"></a>        <span class="p">[</span><span class="k">Parameter</span><span class="p">(</span><span class="k">Mandatory</span><span class="p">=</span><span class="nv">$false</span><span class="p">)]</span>
</span><span id="__span-14-4"><a href="#__codelineno-14-4" id="__codelineno-14-4" name="__codelineno-14-4"></a>        <span class="no">[string]</span><span class="nv">$Dir</span><span class="p">,</span>
</span><span id="__span-14-5"><a href="#__codelineno-14-5" id="__codelineno-14-5" name="__codelineno-14-5"></a>
</span><span id="__span-14-6"><a href="#__codelineno-14-6" id="__codelineno-14-6" name="__codelineno-14-6"></a>        <span class="p">[</span><span class="k">Parameter</span><span class="p">(</span><span class="k">Mandatory</span><span class="p">=</span><span class="nv">$false</span><span class="p">)]</span>
</span><span id="__span-14-7"><a href="#__codelineno-14-7" id="__codelineno-14-7" name="__codelineno-14-7"></a>        <span class="no">[string]</span><span class="nv">$Action</span><span class="p">,</span>
</span><span id="__span-14-8"><a href="#__codelineno-14-8" id="__codelineno-14-8" name="__codelineno-14-8"></a>
</span><span id="__span-14-9"><a href="#__codelineno-14-9" id="__codelineno-14-9" name="__codelineno-14-9"></a>        <span class="p">[</span><span class="k">Parameter</span><span class="p">(</span><span class="k">Mandatory</span><span class="p">=</span><span class="nv">$false</span><span class="p">)]</span>
</span><span id="__span-14-10"><a href="#__codelineno-14-10" id="__codelineno-14-10" name="__codelineno-14-10"></a>        <span class="no">[string]</span><span class="nv">$Auto</span><span class="p">,</span>
</span><span id="__span-14-11"><a href="#__codelineno-14-11" id="__codelineno-14-11" name="__codelineno-14-11"></a>
</span><span id="__span-14-12"><a href="#__codelineno-14-12" id="__codelineno-14-12" name="__codelineno-14-12"></a>        <span class="p">[</span><span class="k">Parameter</span><span class="p">(</span><span class="k">Mandatory</span><span class="p">=</span><span class="nv">$false</span><span class="p">)]</span>
</span><span id="__span-14-13"><a href="#__codelineno-14-13" id="__codelineno-14-13" name="__codelineno-14-13"></a>        <span class="no">[string]</span><span class="nv">$ResourceAddress</span><span class="p">,</span>
</span><span id="__span-14-14"><a href="#__codelineno-14-14" id="__codelineno-14-14" name="__codelineno-14-14"></a>
</span><span id="__span-14-15"><a href="#__codelineno-14-15" id="__codelineno-14-15" name="__codelineno-14-15"></a>        <span class="p">[</span><span class="k">Parameter</span><span class="p">(</span><span class="k">Mandatory</span><span class="p">=</span><span class="nv">$false</span><span class="p">)]</span>
</span><span id="__span-14-16"><a href="#__codelineno-14-16" id="__codelineno-14-16" name="__codelineno-14-16"></a>        <span class="no">[string]</span><span class="nv">$ResourceId</span><span class="p">,</span>
</span><span id="__span-14-17"><a href="#__codelineno-14-17" id="__codelineno-14-17" name="__codelineno-14-17"></a>
</span><span id="__span-14-18"><a href="#__codelineno-14-18" id="__codelineno-14-18" name="__codelineno-14-18"></a>        <span class="p">[</span><span class="k">Parameter</span><span class="p">(</span><span class="k">Mandatory</span><span class="p">=</span><span class="nv">$false</span><span class="p">)]</span>
</span><span id="__span-14-19"><a href="#__codelineno-14-19" id="__codelineno-14-19" name="__codelineno-14-19"></a>        <span class="no">[string]</span><span class="nv">$Workspace</span> <span class="p">=</span> <span class="s2">"default"</span><span class="p">,</span>
</span><span id="__span-14-20"><a href="#__codelineno-14-20" id="__codelineno-14-20" name="__codelineno-14-20"></a>
</span><span id="__span-14-21"><a href="#__codelineno-14-21" id="__codelineno-14-21" name="__codelineno-14-21"></a>        <span class="no">[switch]</span><span class="nv">$Help</span>
</span><span id="__span-14-22"><a href="#__codelineno-14-22" id="__codelineno-14-22" name="__codelineno-14-22"></a>    <span class="p">)</span>
</span><span id="__span-14-23"><a href="#__codelineno-14-23" id="__codelineno-14-23" name="__codelineno-14-23"></a>
</span><span id="__span-14-24"><a href="#__codelineno-14-24" id="__codelineno-14-24" name="__codelineno-14-24"></a>    <span class="k">if</span> <span class="p">(</span><span class="nv">$Help</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-14-25"><a href="#__codelineno-14-25" id="__codelineno-14-25" name="__codelineno-14-25"></a>        <span class="nb">Write-Output</span> <span class="s2">"Usage: Terraform-WithVarFiles [OPTIONS]"</span>
</span><span id="__span-14-26"><a href="#__codelineno-14-26" id="__codelineno-14-26" name="__codelineno-14-26"></a>        <span class="nb">Write-Output</span> <span class="s2">"Options:"</span>
</span><span id="__span-14-27"><a href="#__codelineno-14-27" id="__codelineno-14-27" name="__codelineno-14-27"></a>        <span class="nb">Write-Output</span> <span class="s2">"  -Dir DIR                Specify the directory containing .tfvars files"</span>
</span><span id="__span-14-28"><a href="#__codelineno-14-28" id="__codelineno-14-28" name="__codelineno-14-28"></a>        <span class="nb">Write-Output</span> <span class="s2">"  -Action ACTION          Specify the Terraform action (plan, apply, destroy, import)"</span>
</span><span id="__span-14-29"><a href="#__codelineno-14-29" id="__codelineno-14-29" name="__codelineno-14-29"></a>        <span class="nb">Write-Output</span> <span class="s2">"  -Auto AUTO              Specify 'auto' for auto-approve (optional)"</span>
</span><span id="__span-14-30"><a href="#__codelineno-14-30" id="__codelineno-14-30" name="__codelineno-14-30"></a>        <span class="nb">Write-Output</span> <span class="s2">"  -ResourceAddress ADDR   Specify the resource address for import action (optional)"</span>
</span><span id="__span-14-31"><a href="#__codelineno-14-31" id="__codelineno-14-31" name="__codelineno-14-31"></a>        <span class="nb">Write-Output</span> <span class="s2">"  -ResourceId ID          Specify the resource ID for import action (optional)"</span>
</span><span id="__span-14-32"><a href="#__codelineno-14-32" id="__codelineno-14-32" name="__codelineno-14-32"></a>        <span class="nb">Write-Output</span> <span class="s2">"  -Workspace WORKSPACE    Specify the Terraform workspace (default: default)"</span>
</span><span id="__span-14-33"><a href="#__codelineno-14-33" id="__codelineno-14-33" name="__codelineno-14-33"></a>        <span class="nb">Write-Output</span> <span class="s2">"  -Help                   Show this help message"</span>
</span><span id="__span-14-34"><a href="#__codelineno-14-34" id="__codelineno-14-34" name="__codelineno-14-34"></a>        <span class="k">return</span>
</span><span id="__span-14-35"><a href="#__codelineno-14-35" id="__codelineno-14-35" name="__codelineno-14-35"></a>    <span class="p">}</span>
</span><span id="__span-14-36"><a href="#__codelineno-14-36" id="__codelineno-14-36" name="__codelineno-14-36"></a>
</span><span id="__span-14-37"><a href="#__codelineno-14-37" id="__codelineno-14-37" name="__codelineno-14-37"></a>    <span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="p">(</span><span class="nb">Test-Path</span> <span class="n">-Path</span> <span class="nv">$Dir</span> <span class="n">-PathType</span> <span class="n">Container</span><span class="p">))</span> <span class="p">{</span>
</span><span id="__span-14-38"><a href="#__codelineno-14-38" id="__codelineno-14-38" name="__codelineno-14-38"></a>        <span class="nb">Write-Error</span> <span class="s2">"The specified directory does not exist."</span>
</span><span id="__span-14-39"><a href="#__codelineno-14-39" id="__codelineno-14-39" name="__codelineno-14-39"></a>        <span class="k">return</span>
</span><span id="__span-14-40"><a href="#__codelineno-14-40" id="__codelineno-14-40" name="__codelineno-14-40"></a>    <span class="p">}</span>
</span><span id="__span-14-41"><a href="#__codelineno-14-41" id="__codelineno-14-41" name="__codelineno-14-41"></a>
</span><span id="__span-14-42"><a href="#__codelineno-14-42" id="__codelineno-14-42" name="__codelineno-14-42"></a>    <span class="k">if</span> <span class="p">(</span><span class="nv">$Action</span> <span class="n">-notin</span> <span class="p">@(</span><span class="s2">"plan"</span><span class="p">,</span> <span class="s2">"apply"</span><span class="p">,</span> <span class="s2">"destroy"</span><span class="p">,</span> <span class="s2">"import"</span><span class="p">))</span> <span class="p">{</span>
</span><span id="__span-14-43"><a href="#__codelineno-14-43" id="__codelineno-14-43" name="__codelineno-14-43"></a>        <span class="nb">Write-Error</span> <span class="s2">"Invalid action. Use 'plan', 'apply', 'destroy', or 'import'."</span>
</span><span id="__span-14-44"><a href="#__codelineno-14-44" id="__codelineno-14-44" name="__codelineno-14-44"></a>        <span class="k">return</span>
</span><span id="__span-14-45"><a href="#__codelineno-14-45" id="__codelineno-14-45" name="__codelineno-14-45"></a>    <span class="p">}</span>
</span><span id="__span-14-46"><a href="#__codelineno-14-46" id="__codelineno-14-46" name="__codelineno-14-46"></a>
</span><span id="__span-14-47"><a href="#__codelineno-14-47" id="__codelineno-14-47" name="__codelineno-14-47"></a>    <span class="nv">$varFiles</span> <span class="p">=</span> <span class="nb">Get-ChildItem</span> <span class="n">-Path</span> <span class="nv">$Dir</span> <span class="n">-Filter</span> <span class="p">*.</span><span class="n">tfvars</span> <span class="p">|</span> <span class="k">ForEach</span><span class="n">-Object</span> <span class="p">{</span> <span class="s2">"--var-file $_.FullName"</span> <span class="p">}</span>
</span><span id="__span-14-48"><a href="#__codelineno-14-48" id="__codelineno-14-48" name="__codelineno-14-48"></a>
</span><span id="__span-14-49"><a href="#__codelineno-14-49" id="__codelineno-14-49" name="__codelineno-14-49"></a>    <span class="k">if</span> <span class="p">(</span><span class="nv">$varFiles</span><span class="p">.</span><span class="n">Count</span> <span class="o">-eq</span> <span class="n">0</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-14-50"><a href="#__codelineno-14-50" id="__codelineno-14-50" name="__codelineno-14-50"></a>        <span class="nb">Write-Error</span> <span class="s2">"No .tfvars files found in the specified directory."</span>
</span><span id="__span-14-51"><a href="#__codelineno-14-51" id="__codelineno-14-51" name="__codelineno-14-51"></a>        <span class="k">return</span>
</span><span id="__span-14-52"><a href="#__codelineno-14-52" id="__codelineno-14-52" name="__codelineno-14-52"></a>    <span class="p">}</span>
</span><span id="__span-14-53"><a href="#__codelineno-14-53" id="__codelineno-14-53" name="__codelineno-14-53"></a>
</span><span id="__span-14-54"><a href="#__codelineno-14-54" id="__codelineno-14-54" name="__codelineno-14-54"></a>    <span class="nb">Write-Output</span> <span class="s2">"Initializing Terraform..."</span>
</span><span id="__span-14-55"><a href="#__codelineno-14-55" id="__codelineno-14-55" name="__codelineno-14-55"></a>    <span class="n">terraform</span> <span class="n">init</span>
</span><span id="__span-14-56"><a href="#__codelineno-14-56" id="__codelineno-14-56" name="__codelineno-14-56"></a>    <span class="k">if</span> <span class="p">(</span><span class="nv">$LASTEXITCODE</span> <span class="o">-ne</span> <span class="n">0</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-14-57"><a href="#__codelineno-14-57" id="__codelineno-14-57" name="__codelineno-14-57"></a>        <span class="nb">Write-Error</span> <span class="s2">"Terraform initialization failed."</span>
</span><span id="__span-14-58"><a href="#__codelineno-14-58" id="__codelineno-14-58" name="__codelineno-14-58"></a>        <span class="k">return</span>
</span><span id="__span-14-59"><a href="#__codelineno-14-59" id="__codelineno-14-59" name="__codelineno-14-59"></a>    <span class="p">}</span>
</span><span id="__span-14-60"><a href="#__codelineno-14-60" id="__codelineno-14-60" name="__codelineno-14-60"></a>
</span><span id="__span-14-61"><a href="#__codelineno-14-61" id="__codelineno-14-61" name="__codelineno-14-61"></a>    <span class="nb">Write-Output</span> <span class="s2">"Selecting the workspace: $Workspace"</span>
</span><span id="__span-14-62"><a href="#__codelineno-14-62" id="__codelineno-14-62" name="__codelineno-14-62"></a>    <span class="n">terraform</span> <span class="n">workspace</span> <span class="nb">select </span><span class="o">-or</span><span class="n">-create</span> <span class="nv">$Workspace</span>
</span><span id="__span-14-63"><a href="#__codelineno-14-63" id="__codelineno-14-63" name="__codelineno-14-63"></a>    <span class="k">if</span> <span class="p">(</span><span class="nv">$LASTEXITCODE</span> <span class="o">-ne</span> <span class="n">0</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-14-64"><a href="#__codelineno-14-64" id="__codelineno-14-64" name="__codelineno-14-64"></a>        <span class="nb">Write-Error</span> <span class="s2">"Workspace selection failed."</span>
</span><span id="__span-14-65"><a href="#__codelineno-14-65" id="__codelineno-14-65" name="__codelineno-14-65"></a>        <span class="k">return</span>
</span><span id="__span-14-66"><a href="#__codelineno-14-66" id="__codelineno-14-66" name="__codelineno-14-66"></a>    <span class="p">}</span>
</span><span id="__span-14-67"><a href="#__codelineno-14-67" id="__codelineno-14-67" name="__codelineno-14-67"></a>
</span><span id="__span-14-68"><a href="#__codelineno-14-68" id="__codelineno-14-68" name="__codelineno-14-68"></a>    <span class="nb">Write-Output</span> <span class="s2">"Validating Terraform configuration..."</span>
</span><span id="__span-14-69"><a href="#__codelineno-14-69" id="__codelineno-14-69" name="__codelineno-14-69"></a>    <span class="n">terraform</span> <span class="n">validate</span>
</span><span id="__span-14-70"><a href="#__codelineno-14-70" id="__codelineno-14-70" name="__codelineno-14-70"></a>    <span class="k">if</span> <span class="p">(</span><span class="nv">$LASTEXITCODE</span> <span class="o">-ne</span> <span class="n">0</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-14-71"><a href="#__codelineno-14-71" id="__codelineno-14-71" name="__codelineno-14-71"></a>        <span class="nb">Write-Error</span> <span class="s2">"Terraform validation failed."</span>
</span><span id="__span-14-72"><a href="#__codelineno-14-72" id="__codelineno-14-72" name="__codelineno-14-72"></a>        <span class="k">return</span>
</span><span id="__span-14-73"><a href="#__codelineno-14-73" id="__codelineno-14-73" name="__codelineno-14-73"></a>    <span class="p">}</span>
</span><span id="__span-14-74"><a href="#__codelineno-14-74" id="__codelineno-14-74" name="__codelineno-14-74"></a>
</span><span id="__span-14-75"><a href="#__codelineno-14-75" id="__codelineno-14-75" name="__codelineno-14-75"></a>    <span class="nv">$command</span> <span class="p">=</span> <span class="s2">"terraform $Action </span><span class="p">$(</span><span class="nv">$varFiles</span> <span class="n">-join</span> <span class="s1">' '</span><span class="p">)</span><span class="s2">"</span>
</span><span id="__span-14-76"><a href="#__codelineno-14-76" id="__codelineno-14-76" name="__codelineno-14-76"></a>
</span><span id="__span-14-77"><a href="#__codelineno-14-77" id="__codelineno-14-77" name="__codelineno-14-77"></a>    <span class="k">if</span> <span class="p">(</span><span class="nv">$Action</span> <span class="o">-eq</span> <span class="s2">"import"</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-14-78"><a href="#__codelineno-14-78" id="__codelineno-14-78" name="__codelineno-14-78"></a>        <span class="k">if</span> <span class="p">(</span><span class="o">-not</span> <span class="nv">$ResourceAddress</span> <span class="o">-or</span> <span class="o">-not</span> <span class="nv">$ResourceId</span><span class="p">)</span> <span class="p">{</span>
</span><span id="__span-14-79"><a href="#__codelineno-14-79" id="__codelineno-14-79" name="__codelineno-14-79"></a>            <span class="nb">Write-Error</span> <span class="s2">"For 'import' action, both resource address and resource ID must be provided."</span>
</span><span id="__span-14-80"><a href="#__codelineno-14-80" id="__codelineno-14-80" name="__codelineno-14-80"></a>            <span class="k">return</span>
</span><span id="__span-14-81"><a href="#__codelineno-14-81" id="__codelineno-14-81" name="__codelineno-14-81"></a>        <span class="p">}</span>
</span><span id="__span-14-82"><a href="#__codelineno-14-82" id="__codelineno-14-82" name="__codelineno-14-82"></a>        <span class="nv">$command</span> <span class="p">=</span> <span class="s2">"$command $ResourceAddress $ResourceId"</span>
</span><span id="__span-14-83"><a href="#__codelineno-14-83" id="__codelineno-14-83" name="__codelineno-14-83"></a>    <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$Auto</span> <span class="o">-eq</span> <span class="s2">"auto"</span> <span class="o">-and</span> <span class="p">(</span><span class="nv">$Action</span> <span class="o">-eq</span> <span class="s2">"apply"</span> <span class="o">-or</span> <span class="nv">$Action</span> <span class="o">-eq</span> <span class="s2">"destroy"</span><span class="p">))</span> <span class="p">{</span>
</span><span id="__span-14-84"><a href="#__codelineno-14-84" id="__codelineno-14-84" name="__codelineno-14-84"></a>        <span class="nv">$command</span> <span class="p">=</span> <span class="s2">"$command -auto-approve"</span>
</span><span id="__span-14-85"><a href="#__codelineno-14-85" id="__codelineno-14-85" name="__codelineno-14-85"></a>    <span class="p">}</span>
</span><span id="__span-14-86"><a href="#__codelineno-14-86" id="__codelineno-14-86" name="__codelineno-14-86"></a>
</span><span id="__span-14-87"><a href="#__codelineno-14-87" id="__codelineno-14-87" name="__codelineno-14-87"></a>    <span class="nb">Write-Output</span> <span class="s2">"Executing: $command"</span>
</span><span id="__span-14-88"><a href="#__codelineno-14-88" id="__codelineno-14-88" name="__codelineno-14-88"></a>    <span class="nb">Invoke-Expression</span> <span class="nv">$command</span>
</span><span id="__span-14-89"><a href="#__codelineno-14-89" id="__codelineno-14-89" name="__codelineno-14-89"></a><span class="p">}</span>
</span><span id="__span-14-90"><a href="#__codelineno-14-90" id="__codelineno-14-90" name="__codelineno-14-90"></a>
</span><span id="__span-14-91"><a href="#__codelineno-14-91" id="__codelineno-14-91" name="__codelineno-14-91"></a><span class="c"># Usage examples:</span>
</span><span id="__span-14-92"><a href="#__codelineno-14-92" id="__codelineno-14-92" name="__codelineno-14-92"></a><span class="c"># Terraform-WithVarFiles -Dir "/path/to/directory" -Action "plan" -Workspace "workspace"</span>
</span><span id="__span-14-93"><a href="#__codelineno-14-93" id="__codelineno-14-93" name="__codelineno-14-93"></a><span class="c"># Terraform-WithVarFiles -Dir "/path/to/directory" -Action "apply" -Auto "auto" -Workspace "workspace"</span>
</span><span id="__span-14-94"><a href="#__codelineno-14-94" id="__codelineno-14-94" name="__codelineno-14-94"></a><span class="c"># Terraform-WithVarFiles -Dir "/path/to/directory" -Action "destroy" -Auto "auto" -Workspace "workspace"</span>
</span><span id="__span-14-95"><a href="#__codelineno-14-95" id="__codelineno-14-95" name="__codelineno-14-95"></a><span class="c"># Terraform-WithVarFiles -Dir "/path/to/directory" -Action "import" -ResourceAddress "resource_address" -ResourceId "resource_id" -Workspace "workspace"</span>
</span></code></pre></div>
</div>
</div>
</div>
</div>
<p>Para cargar la funciÃ³n en tu terminal bash, copia y pega el script en tu archivo <code>.bashrc</code>, <code>.zshrc</code> o el que toque y recarga tu terminal.</p>
<p>Para cargar la funciÃ³n en tu terminal pwsh, sigue este artÃ­culo: <a href="https://learn.microsoft.com/es-es/powershell/scripting/learn/shell/creating-profiles?view=powershell-7.4#adding-customizations-to-your-profile">PersonalizaciÃ³n del entorno de shell</a></p>
<p>Espero que os sea de utilidad. Â¡Saludos!</p>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<nav class="md-post__authors md-typeset">
<span class="md-author">
<img alt="Rafael FernÃ¡ndez" src="https://avatars.githubusercontent.com/u/39990341">
</span>
</nav>
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2024-11-20 00:00:00+00:00">November 20, 2024</time></li>
<li class="md-meta__item">
            in
            
              <a class="md-meta__link" href="../../category/azure-services/">Azure Services</a></li>
<li class="md-meta__item">
            
              2 min read
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="develop-my-firts-policy-for-kubernetes-with-minikube-and-gatekeeper"><a class="toclink" href="../../2024/11/20/develop-my-firts-policy-for-kubernetes-with-minikube-and-gatekeeper/">Develop my firts policy for Kubernetes with minikube and gatekeeper</a></h2>
<p>Now that we have our <a href="../../2024/11/19/how-to-create-a-local-environment-to-write-policies-for-kubernetes-with-minikube-and-gatekeeper/">development environment</a>, we can start developing our first policy for Kubernetes with minikube and gatekeeper.</p>
<p>First at all, we need some visual code editor to write our policy. I recommend using Visual Studio Code, but you can use any other editor. Exists a plugin for Visual Studio Code that helps you to write policies for gatekeeper. You can install it from the marketplace: <a href="https://marketplace.visualstudio.com/items?itemName=tsandall.opa">Open Policy Agent</a>.</p>
<p>Once you have your editor ready, you can start writing your policy. In this example, we will create a policy that denies the creation of pods with the image <code>nginx:latest</code>.</p>
<p>For that we need two files:</p>
<ul>
<li><code>constraint.yaml</code>: This file defines the constraint that we want to apply.</li>
<li><code>constraint_template.yaml</code>: This file defines the template that we will use to create the constraint.</li>
</ul>
<p>Let's start with the <code>constraint_template.yaml</code> file:</p>
<div class="language-yaml highlight"><span class="filename">constraint_template.yaml</span><pre><span></span><code><span id="__span-8-1"><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">templates.gatekeeper.sh/v1beta1</span>
</span><span id="__span-8-2"><a href="#__codelineno-8-2" id="__codelineno-8-2" name="__codelineno-8-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConstraintTemplate</span>
</span><span id="__span-8-3"><a href="#__codelineno-8-3" id="__codelineno-8-3" name="__codelineno-8-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-8-4"><a href="#__codelineno-8-4" id="__codelineno-8-4" name="__codelineno-8-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8sdenypodswithnginxlatest</span>
</span><span id="__span-8-5"><a href="#__codelineno-8-5" id="__codelineno-8-5" name="__codelineno-8-5"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-8-6"><a href="#__codelineno-8-6" id="__codelineno-8-6" name="__codelineno-8-6"></a><span class="w">  </span><span class="nt">crd</span><span class="p">:</span>
</span><span id="__span-8-7"><a href="#__codelineno-8-7" id="__codelineno-8-7" name="__codelineno-8-7"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-8-8"><a href="#__codelineno-8-8" id="__codelineno-8-8" name="__codelineno-8-8"></a><span class="w">      </span><span class="nt">names</span><span class="p">:</span>
</span><span id="__span-8-9"><a href="#__codelineno-8-9" id="__codelineno-8-9" name="__codelineno-8-9"></a><span class="w">        </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">K8sDenyPodsWithNginxLatest</span>
</span><span id="__span-8-10"><a href="#__codelineno-8-10" id="__codelineno-8-10" name="__codelineno-8-10"></a><span class="w">  </span><span class="nt">targets</span><span class="p">:</span>
</span><span id="__span-8-11"><a href="#__codelineno-8-11" id="__codelineno-8-11" name="__codelineno-8-11"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admission.k8s.gatekeeper.sh</span>
</span><span id="__span-8-12"><a href="#__codelineno-8-12" id="__codelineno-8-12" name="__codelineno-8-12"></a><span class="w">      </span><span class="nt">rego</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-8-13"><a href="#__codelineno-8-13" id="__codelineno-8-13" name="__codelineno-8-13"></a><span class="w">        </span><span class="no">package k8sdenypodswithnginxlatest</span>
</span><span id="__span-8-14"><a href="#__codelineno-8-14" id="__codelineno-8-14" name="__codelineno-8-14"></a>
</span><span id="__span-8-15"><a href="#__codelineno-8-15" id="__codelineno-8-15" name="__codelineno-8-15"></a><span class="w">        </span><span class="no">violation[{"msg": msg}] {</span>
</span><span id="__span-8-16"><a href="#__codelineno-8-16" id="__codelineno-8-16" name="__codelineno-8-16"></a><span class="w">          </span><span class="no">input.review.object.spec.containers[_].image == "nginx:latest"</span>
</span><span id="__span-8-17"><a href="#__codelineno-8-17" id="__codelineno-8-17" name="__codelineno-8-17"></a><span class="w">          </span><span class="no">msg := "Containers cannot use the nginx:latest image"</span>
</span><span id="__span-8-18"><a href="#__codelineno-8-18" id="__codelineno-8-18" name="__codelineno-8-18"></a><span class="w">        </span><span class="no">}</span>
</span></code></pre></div>
<p>Now, let's create the <code>constraint.yaml</code> file:</p>
<div class="language-yaml highlight"><span class="filename">constraint.yaml</span><pre><span></span><code><span id="__span-9-1"><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">constraints.gatekeeper.sh/v1beta1</span>
</span><span id="__span-9-2"><a href="#__codelineno-9-2" id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">K8sDenyPodsWithNginxLatest</span>
</span><span id="__span-9-3"><a href="#__codelineno-9-3" id="__codelineno-9-3" name="__codelineno-9-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-9-4"><a href="#__codelineno-9-4" id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">deny-pods-with-nginx-latest</span>
</span><span id="__span-9-5"><a href="#__codelineno-9-5" id="__codelineno-9-5" name="__codelineno-9-5"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-9-6"><a href="#__codelineno-9-6" id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="w">  </span><span class="nt">match</span><span class="p">:</span>
</span><span id="__span-9-7"><a href="#__codelineno-9-7" id="__codelineno-9-7" name="__codelineno-9-7"></a><span class="w">    </span><span class="nt">kinds</span><span class="p">:</span>
</span><span id="__span-9-8"><a href="#__codelineno-9-8" id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">apiGroups</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">""</span><span class="p p-Indicator">]</span>
</span><span id="__span-9-9"><a href="#__codelineno-9-9" id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="w">        </span><span class="nt">kinds</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">"Pod"</span><span class="p p-Indicator">]</span>
</span><span id="__span-9-10"><a href="#__codelineno-9-10" id="__codelineno-9-10" name="__codelineno-9-10"></a><span class="w">  </span><span class="nt">parameters</span><span class="p">:</span>
</span><span id="__span-9-11"><a href="#__codelineno-9-11" id="__codelineno-9-11" name="__codelineno-9-11"></a><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s">"Containers</span><span class="nv"> </span><span class="s">cannot</span><span class="nv"> </span><span class="s">use</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">nginx:latest</span><span class="nv"> </span><span class="s">image"</span>
</span></code></pre></div>
<p>Now, we can apply the files to our cluster:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-10-1"><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a><span class="c1"># Create the constraint template</span>
</span><span id="__span-10-2"><a href="#__codelineno-10-2" id="__codelineno-10-2" name="__codelineno-10-2"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>constraint_template.yaml
</span><span id="__span-10-3"><a href="#__codelineno-10-3" id="__codelineno-10-3" name="__codelineno-10-3"></a>
</span><span id="__span-10-4"><a href="#__codelineno-10-4" id="__codelineno-10-4" name="__codelineno-10-4"></a><span class="c1"># Create the constraint</span>
</span><span id="__span-10-5"><a href="#__codelineno-10-5" id="__codelineno-10-5" name="__codelineno-10-5"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>constraint.yaml
</span></code></pre></div>
<p>Now, we can test the constraint. Let's create a pod with the image <code>nginx:latest</code>:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-11-1"><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a>cat<span class="w"> </span><span class="s">&lt;&lt;EOF | kubectl apply -f -</span>
</span><span id="__span-11-2"><a href="#__codelineno-11-2" id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="s">apiVersion: v1</span>
</span><span id="__span-11-3"><a href="#__codelineno-11-3" id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="s">kind: Pod</span>
</span><span id="__span-11-4"><a href="#__codelineno-11-4" id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="s">metadata:</span>
</span><span id="__span-11-5"><a href="#__codelineno-11-5" id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="s">  name: nginx-pod</span>
</span><span id="__span-11-6"><a href="#__codelineno-11-6" id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="s">spec:</span>
</span><span id="__span-11-7"><a href="#__codelineno-11-7" id="__codelineno-11-7" name="__codelineno-11-7"></a><span class="s">  containers:</span>
</span><span id="__span-11-8"><a href="#__codelineno-11-8" id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="s">  - name: nginx</span>
</span><span id="__span-11-9"><a href="#__codelineno-11-9" id="__codelineno-11-9" name="__codelineno-11-9"></a><span class="s">    image: nginx:latest</span>
</span><span id="__span-11-10"><a href="#__codelineno-11-10" id="__codelineno-11-10" name="__codelineno-11-10"></a><span class="s">EOF</span>
</span></code></pre></div>
<p>We must see an error message like this:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-12-1"><a href="#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a>Error<span class="w"> </span>from<span class="w"> </span>server<span class="w"> </span><span class="o">(</span>Forbidden<span class="o">)</span>:<span class="w"> </span>error<span class="w"> </span>when<span class="w"> </span>creating<span class="w"> </span><span class="s2">"STDIN"</span>:<span class="w"> </span>admission<span class="w"> </span>webhook<span class="w"> </span><span class="s2">"validation.gatekeeper.sh"</span><span class="w"> </span>denied<span class="w"> </span>the<span class="w"> </span>request:<span class="w"> </span><span class="o">[</span>k8sdenypodswithnginxlatest<span class="o">]</span><span class="w"> </span>Containers<span class="w"> </span>cannot<span class="w"> </span>use<span class="w"> </span>the<span class="w"> </span>nginx:latest<span class="w"> </span>image
</span></code></pre></div>
<p>Now, let's create a pod with a different image:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-13-1"><a href="#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a>cat<span class="w"> </span><span class="s">&lt;&lt;EOF | kubectl apply -f -</span>
</span><span id="__span-13-2"><a href="#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a><span class="s">apiVersion: v1</span>
</span><span id="__span-13-3"><a href="#__codelineno-13-3" id="__codelineno-13-3" name="__codelineno-13-3"></a><span class="s">kind: Pod</span>
</span><span id="__span-13-4"><a href="#__codelineno-13-4" id="__codelineno-13-4" name="__codelineno-13-4"></a><span class="s">metadata:</span>
</span><span id="__span-13-5"><a href="#__codelineno-13-5" id="__codelineno-13-5" name="__codelineno-13-5"></a><span class="s">  name: nginx-pod</span>
</span><span id="__span-13-6"><a href="#__codelineno-13-6" id="__codelineno-13-6" name="__codelineno-13-6"></a><span class="s">spec:</span>
</span><span id="__span-13-7"><a href="#__codelineno-13-7" id="__codelineno-13-7" name="__codelineno-13-7"></a><span class="s">  containers:</span>
</span><span id="__span-13-8"><a href="#__codelineno-13-8" id="__codelineno-13-8" name="__codelineno-13-8"></a><span class="s">  - name: nginx</span>
</span><span id="__span-13-9"><a href="#__codelineno-13-9" id="__codelineno-13-9" name="__codelineno-13-9"></a><span class="s">    image: nginx:1.25.5</span>
</span><span id="__span-13-10"><a href="#__codelineno-13-10" id="__codelineno-13-10" name="__codelineno-13-10"></a><span class="s">EOF</span>
</span></code></pre></div>
<p>We must see a message like this:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-14-1"><a href="#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a>pod/nginx-pod<span class="w"> </span>created
</span></code></pre></div>
<p>For cleaning up, you can delete pod,the constraint and the constraint template:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-15-1"><a href="#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="c1"># Delete the pod</span>
</span><span id="__span-15-2"><a href="#__codelineno-15-2" id="__codelineno-15-2" name="__codelineno-15-2"></a>kubectl<span class="w"> </span>delete<span class="w"> </span>pod<span class="w"> </span>nginx-pod
</span><span id="__span-15-3"><a href="#__codelineno-15-3" id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="c1"># Delete the constraint</span>
</span><span id="__span-15-4"><a href="#__codelineno-15-4" id="__codelineno-15-4" name="__codelineno-15-4"></a>kubectl<span class="w"> </span>delete<span class="w"> </span>-f<span class="w"> </span>constraint.yaml
</span><span id="__span-15-5"><a href="#__codelineno-15-5" id="__codelineno-15-5" name="__codelineno-15-5"></a>
</span><span id="__span-15-6"><a href="#__codelineno-15-6" id="__codelineno-15-6" name="__codelineno-15-6"></a><span class="c1"># Delete the constraint template</span>
</span><span id="__span-15-7"><a href="#__codelineno-15-7" id="__codelineno-15-7" name="__codelineno-15-7"></a>kubectl<span class="w"> </span>delete<span class="w"> </span>-f<span class="w"> </span>constraint_template.yaml
</span></code></pre></div>
<p>And that's it! We have developed our first policy for Kubernetes with minikube and gatekeeper. Now you can start developing more complex policies and test them in your cluster.</p>
<p>Happy coding!</p>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<nav class="md-post__authors md-typeset">
<span class="md-author">
<img alt="Rafael FernÃ¡ndez" src="https://avatars.githubusercontent.com/u/39990341">
</span>
</nav>
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2024-11-19 00:00:00+00:00">November 19, 2024</time></li>
<li class="md-meta__item">
            in
            
              <a class="md-meta__link" href="../../category/azure-services/">Azure Services</a></li>
<li class="md-meta__item">
            
              2 min read
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="how-to-create-a-local-environment-to-write-policies-for-kubernetes-with-minikube-and-gatekeeper"><a class="toclink" href="../../2024/11/19/how-to-create-a-local-environment-to-write-policies-for-kubernetes-with-minikube-and-gatekeeper/">How to create a local environment to write policies for Kubernetes with minikube and gatekeeper</a></h2>
<h3 id="minikube-in-wsl2"><a class="toclink" href="../../2024/11/19/how-to-create-a-local-environment-to-write-policies-for-kubernetes-with-minikube-and-gatekeeper/#minikube-in-wsl2">minikube in wsl2</a></h3>
<h4 id="enable-systemd-in-wsl2"><a class="toclink" href="../../2024/11/19/how-to-create-a-local-environment-to-write-policies-for-kubernetes-with-minikube-and-gatekeeper/#enable-systemd-in-wsl2">Enable systemd in WSL2</a></h4>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-11-1"><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a>sudo<span class="w"> </span>nano<span class="w"> </span>/etc/wsl.conf
</span></code></pre></div>
<p>Add the following:</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-12-1"><a href="#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="o">[</span>boot<span class="o">]</span>
</span><span id="__span-12-2"><a href="#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="nv">systemd</span><span class="o">=</span><span class="nb">true</span>
</span></code></pre></div>
<p>Restart WSL2 in command:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-13-1"><a href="#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a>wsl --shutdown
</span><span id="__span-13-2"><a href="#__codelineno-13-2" id="__codelineno-13-2" name="__codelineno-13-2"></a>wsl
</span></code></pre></div>
<h4 id="install-docker"><a class="toclink" href="../../2024/11/19/how-to-create-a-local-environment-to-write-policies-for-kubernetes-with-minikube-and-gatekeeper/#install-docker">Install docker</a></h4>
<p><a href="https://docs.docker.com/engine/install/ubuntu/#install-using-the-repository">Install docker using repository</a></p>
<h3 id="minikube"><a class="toclink" href="../../2024/11/19/how-to-create-a-local-environment-to-write-policies-for-kubernetes-with-minikube-and-gatekeeper/#minikube">Minikube</a></h3>
<h4 id="install-minikube"><a class="toclink" href="../../2024/11/19/how-to-create-a-local-environment-to-write-policies-for-kubernetes-with-minikube-and-gatekeeper/#install-minikube">Install minikube</a></h4>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-14-1"><a href="#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="c1"># Download the latest Minikube</span>
</span><span id="__span-14-2"><a href="#__codelineno-14-2" id="__codelineno-14-2" name="__codelineno-14-2"></a>curl<span class="w"> </span>-Lo<span class="w"> </span>minikube<span class="w"> </span>https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
</span><span id="__span-14-3"><a href="#__codelineno-14-3" id="__codelineno-14-3" name="__codelineno-14-3"></a>
</span><span id="__span-14-4"><a href="#__codelineno-14-4" id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="c1"># Make it executable</span>
</span><span id="__span-14-5"><a href="#__codelineno-14-5" id="__codelineno-14-5" name="__codelineno-14-5"></a>chmod<span class="w"> </span>+x<span class="w"> </span>./minikube
</span><span id="__span-14-6"><a href="#__codelineno-14-6" id="__codelineno-14-6" name="__codelineno-14-6"></a>
</span><span id="__span-14-7"><a href="#__codelineno-14-7" id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="c1"># Move it to your user's executable PATH</span>
</span><span id="__span-14-8"><a href="#__codelineno-14-8" id="__codelineno-14-8" name="__codelineno-14-8"></a>sudo<span class="w"> </span>mv<span class="w"> </span>./minikube<span class="w"> </span>/usr/local/bin/
</span><span id="__span-14-9"><a href="#__codelineno-14-9" id="__codelineno-14-9" name="__codelineno-14-9"></a>
</span><span id="__span-14-10"><a href="#__codelineno-14-10" id="__codelineno-14-10" name="__codelineno-14-10"></a><span class="c1">#Set the driver version to Docker</span>
</span><span id="__span-14-11"><a href="#__codelineno-14-11" id="__codelineno-14-11" name="__codelineno-14-11"></a>minikube<span class="w"> </span>config<span class="w"> </span><span class="nb">set</span><span class="w"> </span>driver<span class="w"> </span>docker
</span></code></pre></div>
<h4 id="test-minikube"><a class="toclink" href="../../2024/11/19/how-to-create-a-local-environment-to-write-policies-for-kubernetes-with-minikube-and-gatekeeper/#test-minikube">Test minikube</a></h4>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-15-1"><a href="#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="c1"># Enable completion</span>
</span><span id="__span-15-2"><a href="#__codelineno-15-2" id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="nb">source</span><span class="w"> </span>&lt;<span class="o">(</span>minikube<span class="w"> </span>completion<span class="w"> </span>bash<span class="o">)</span>
</span><span id="__span-15-3"><a href="#__codelineno-15-3" id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="c1"># Start minikube</span>
</span><span id="__span-15-4"><a href="#__codelineno-15-4" id="__codelineno-15-4" name="__codelineno-15-4"></a>minikube<span class="w"> </span>start
</span><span id="__span-15-5"><a href="#__codelineno-15-5" id="__codelineno-15-5" name="__codelineno-15-5"></a><span class="c1"># Check the status</span>
</span><span id="__span-15-6"><a href="#__codelineno-15-6" id="__codelineno-15-6" name="__codelineno-15-6"></a>minikube<span class="w"> </span>status
</span><span id="__span-15-7"><a href="#__codelineno-15-7" id="__codelineno-15-7" name="__codelineno-15-7"></a><span class="c1"># set context</span>
</span><span id="__span-15-8"><a href="#__codelineno-15-8" id="__codelineno-15-8" name="__codelineno-15-8"></a>kubectl<span class="w"> </span>config<span class="w"> </span>use-context<span class="w"> </span>minikube
</span><span id="__span-15-9"><a href="#__codelineno-15-9" id="__codelineno-15-9" name="__codelineno-15-9"></a><span class="c1"># get pods</span>
</span><span id="__span-15-10"><a href="#__codelineno-15-10" id="__codelineno-15-10" name="__codelineno-15-10"></a>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>--all-namespaces
</span></code></pre></div>
<h3 id="install-opa-gatekeeper"><a class="toclink" href="../../2024/11/19/how-to-create-a-local-environment-to-write-policies-for-kubernetes-with-minikube-and-gatekeeper/#install-opa-gatekeeper">Install OPA Gatekeeper</a></h3>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-16-1"><a href="#__codelineno-16-1" id="__codelineno-16-1" name="__codelineno-16-1"></a><span class="c1"># Install OPA Gatekeeper</span>
</span><span id="__span-16-2"><a href="#__codelineno-16-2" id="__codelineno-16-2" name="__codelineno-16-2"></a><span class="c1"># check version in https://open-policy-agent.github.io/gatekeeper/website/docs/install#deploying-a-release-using-prebuilt-image</span>
</span><span id="__span-16-3"><a href="#__codelineno-16-3" id="__codelineno-16-3" name="__codelineno-16-3"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/open-policy-agent/gatekeeper/v3.17.1/deploy/gatekeeper.yaml
</span><span id="__span-16-4"><a href="#__codelineno-16-4" id="__codelineno-16-4" name="__codelineno-16-4"></a>
</span><span id="__span-16-5"><a href="#__codelineno-16-5" id="__codelineno-16-5" name="__codelineno-16-5"></a><span class="c1"># wait and check the status</span>
</span><span id="__span-16-6"><a href="#__codelineno-16-6" id="__codelineno-16-6" name="__codelineno-16-6"></a>sleep<span class="w"> </span><span class="m">60</span>
</span><span id="__span-16-7"><a href="#__codelineno-16-7" id="__codelineno-16-7" name="__codelineno-16-7"></a>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>gatekeeper-system
</span></code></pre></div>
<h3 id="test-constraints"><a class="toclink" href="../../2024/11/19/how-to-create-a-local-environment-to-write-policies-for-kubernetes-with-minikube-and-gatekeeper/#test-constraints">Test constraints</a></h3>
<p>First, we need to create a constraint template and a constraint.</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-17-1"><a href="#__codelineno-17-1" id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="c1"># Create a constraint template</span>
</span><span id="__span-17-2"><a href="#__codelineno-17-2" id="__codelineno-17-2" name="__codelineno-17-2"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/open-policy-agent/gatekeeper/v3.17.1/demo/basic/templates/k8srequiredlabels_template.yaml
</span><span id="__span-17-3"><a href="#__codelineno-17-3" id="__codelineno-17-3" name="__codelineno-17-3"></a>
</span><span id="__span-17-4"><a href="#__codelineno-17-4" id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="c1"># Create a constraint</span>
</span><span id="__span-17-5"><a href="#__codelineno-17-5" id="__codelineno-17-5" name="__codelineno-17-5"></a>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>https://raw.githubusercontent.com/open-policy-agent/gatekeeper/v3.17.1/demo/basic/constraints/k8srequiredlabels_constraint.yaml
</span></code></pre></div>
<p>Now, we can test the constraint.</p>
<p></p><div class="language-bash highlight"><pre><span></span><code><span id="__span-18-1"><a href="#__codelineno-18-1" id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="c1"># Create a deployment without the required label</span>
</span><span id="__span-18-2"><a href="#__codelineno-18-2" id="__codelineno-18-2" name="__codelineno-18-2"></a>kubectl<span class="w"> </span>create<span class="w"> </span>namespace<span class="w"> </span>petete<span class="w"> </span>
</span></code></pre></div>
We must see an error message like this:<p></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-19-1"><a href="#__codelineno-19-1" id="__codelineno-19-1" name="__codelineno-19-1"></a>Error<span class="w"> </span>from<span class="w"> </span>server<span class="w"> </span><span class="o">(</span>Forbidden<span class="o">)</span>:<span class="w"> </span>admission<span class="w"> </span>webhook<span class="w"> </span><span class="s2">"validation.gatekeeper.sh"</span><span class="w"> </span>denied<span class="w"> </span>the<span class="w"> </span>request:<span class="w"> </span><span class="o">[</span>ns-must-have-gk<span class="o">]</span><span class="w"> </span>you<span class="w"> </span>must<span class="w"> </span>provide<span class="w"> </span>labels:<span class="w"> </span><span class="o">{</span><span class="s2">"gatekeeper"</span><span class="o">}</span>
</span></code></pre></div>
<p></p><div class="language-bash highlight"><pre><span></span><code><span id="__span-20-1"><a href="#__codelineno-20-1" id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="c1"># Create a deployment with the required label</span>
</span><span id="__span-20-2"><a href="#__codelineno-20-2" id="__codelineno-20-2" name="__codelineno-20-2"></a>cat<span class="w"> </span><span class="s">&lt;&lt;EOF | kubectl apply -f -</span>
</span><span id="__span-20-3"><a href="#__codelineno-20-3" id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="s">apiVersion: v1</span>
</span><span id="__span-20-4"><a href="#__codelineno-20-4" id="__codelineno-20-4" name="__codelineno-20-4"></a><span class="s">kind: Namespace</span>
</span><span id="__span-20-5"><a href="#__codelineno-20-5" id="__codelineno-20-5" name="__codelineno-20-5"></a><span class="s">metadata:</span>
</span><span id="__span-20-6"><a href="#__codelineno-20-6" id="__codelineno-20-6" name="__codelineno-20-6"></a><span class="s">  name: petete</span>
</span><span id="__span-20-7"><a href="#__codelineno-20-7" id="__codelineno-20-7" name="__codelineno-20-7"></a><span class="s">  labels:</span>
</span><span id="__span-20-8"><a href="#__codelineno-20-8" id="__codelineno-20-8" name="__codelineno-20-8"></a><span class="s">    gatekeeper: "true"</span>
</span><span id="__span-20-9"><a href="#__codelineno-20-9" id="__codelineno-20-9" name="__codelineno-20-9"></a><span class="s">EOF</span>
</span><span id="__span-20-10"><a href="#__codelineno-20-10" id="__codelineno-20-10" name="__codelineno-20-10"></a>kubectl<span class="w"> </span>get<span class="w"> </span>namespaces<span class="w"> </span>petete
</span></code></pre></div>
We must see a message like this:<p></p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-21-1"><a href="#__codelineno-21-1" id="__codelineno-21-1" name="__codelineno-21-1"></a>NAME<span class="w">     </span>STATUS<span class="w">   </span>AGE
</span><span id="__span-21-2"><a href="#__codelineno-21-2" id="__codelineno-21-2" name="__codelineno-21-2"></a>petete<span class="w">   </span>Active<span class="w">   </span>3s
</span></code></pre></div>
<h3 id="conclusion"><a class="toclink" href="../../2024/11/19/how-to-create-a-local-environment-to-write-policies-for-kubernetes-with-minikube-and-gatekeeper/#conclusion">Conclusion</a></h3>
<p>We have created a local environment to write policies for Kubernetes with minikube and gatekeeper. We have tested the environment with a simple constraint. Now we can write our own policies and test them in our local environment.</p>
<h3 id="references"><a class="toclink" href="../../2024/11/19/how-to-create-a-local-environment-to-write-policies-for-kubernetes-with-minikube-and-gatekeeper/#references">References</a></h3>
<ul>
<li><a href="https://minikube.sigs.k8s.io/docs/">Minikube</a></li>
<li><a href="https://open-policy-agent.github.io/gatekeeper/website/docs/install">OPA Gatekeeper</a></li>
<li><a href="https://open-policy-agent.github.io/gatekeeper/website/docs/howto/">How to use Gatekeeper</a></li>
<li><a href="https://docs.microsoft.com/en-us/windows/wsl/install">WSL2</a></li>
<li><a href="https://docs.docker.com/engine/install/ubuntu/">Docker</a></li>
</ul>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<nav class="md-post__authors md-typeset">
<span class="md-author">
<img alt="Rafael FernÃ¡ndez" src="https://avatars.githubusercontent.com/u/39990341">
</span>
</nav>
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2024-11-06 00:00:00+00:00">November 6, 2024</time></li>
<li class="md-meta__item">
            in
            
              <a class="md-meta__link" href="../../category/azure-services/">Azure Services</a></li>
<li class="md-meta__item">
            
              2 min read
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="trigger-an-on-demand-azure-policy-compliance-evaluation-scan"><a class="toclink" href="../../2024/11/06/trigger-an-on-demand-azure-policy-compliance-evaluation-scan/">Trigger an on-demand Azure Policy compliance evaluation scan</a></h2>
<p>Azure Policy is a service in Azure that you can use to create, assign, and manage policies that enforce different rules and effects over your resources. These policies can help you stay compliant with your corporate standards and service-level agreements. In this article, we will discuss how to trigger a scan with Azure Policy.</p>
<h3 id="what-is-a-scan-in-azure-policy"><a class="toclink" href="../../2024/11/06/trigger-an-on-demand-azure-policy-compliance-evaluation-scan/#what-is-a-scan-in-azure-policy">What is a scan in Azure Policy</a></h3>
<p>A scan in Azure Policy is a process that evaluates your resources against a set of policies to determine if they are compliant. When you trigger a scan, Azure Policy evaluates your resources and generates a compliance report that shows the results of the evaluation. The compliance report includes information about the policies that were evaluated, the resources that were scanned, and the compliance status of each resource.</p>
<p>You can trigger a scan in Azure Policy using the Azure CLI, PowerShell, or the Azure portal. When you trigger a scan, you can specify the scope of the scan, the policies to evaluate, and other parameters that control the behavior of the scan.</p>
<h3 id="trigger-a-scan-with-the-azure-cli"><a class="toclink" href="../../2024/11/06/trigger-an-on-demand-azure-policy-compliance-evaluation-scan/#trigger-a-scan-with-the-azure-cli">Trigger a scan with the Azure CLI</a></h3>
<p>To trigger a scan with the Azure CLI, you can use the <code>az policy state trigger-scan</code> command. This command triggers a policy compliance evaluation for a scope</p>
<p>How to trigger a scan with the Azure CLI for active subscription:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-5-1"><a href="#__codelineno-5-1" id="__codelineno-5-1" name="__codelineno-5-1"></a>az policy state trigger-scan 
</span></code></pre></div>
<p>How to trigger a scan with the Azure CLI for a specific resource group:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-6-1"><a href="#__codelineno-6-1" id="__codelineno-6-1" name="__codelineno-6-1"></a>az policy state trigger-scan --resource-group myResourceGroup
</span></code></pre></div>
<h3 id="trigger-a-scan-with-powershell"><a class="toclink" href="../../2024/11/06/trigger-an-on-demand-azure-policy-compliance-evaluation-scan/#trigger-a-scan-with-powershell">Trigger a scan with PowerShell</a></h3>
<p>To trigger a scan with PowerShell, you can use the <code>Start-AzPolicyComplianceScan</code> cmdlet. This cmdlet triggers a policy compliance evaluation for a scope.</p>
<p>How to trigger a scan with PowerShell for active subscription:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-7-1"><a href="#__codelineno-7-1" id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="nb">Start-AzPolicyComplianceScan</span>
</span></code></pre></div>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-8-1"><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a><span class="nv">$job</span> <span class="p">=</span> <span class="nb">Start-AzPolicyComplianceScan</span> <span class="n">-AsJob</span>
</span></code></pre></div>
<p>How to trigger a scan with PowerShell for a specific resource group:</p>
<div class="language-powershell highlight"><pre><span></span><code><span id="__span-9-1"><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="nb">Start-AzPolicyComplianceScan</span> <span class="n">-ResourceGroupName</span> <span class="s1">'MyRG'</span>
</span></code></pre></div>
<h3 id="conclusion"><a class="toclink" href="../../2024/11/06/trigger-an-on-demand-azure-policy-compliance-evaluation-scan/#conclusion">Conclusion</a></h3>
<p>In this article, we discussed how to trigger a scan with Azure Policy. We covered how to trigger a scan using the Azure CLI and PowerShell. By triggering a scan, you can evaluate your resources against a set of policies to determine if they are compliant. This can help you ensure that your resources are compliant with your organization's standards and best practices.</p>
<h3 id="references"><a class="toclink" href="../../2024/11/06/trigger-an-on-demand-azure-policy-compliance-evaluation-scan/#references">References</a></h3>
<ul>
<li><a href="https://learn.microsoft.com/en-us/azure/governance/policy/how-to/get-compliance-data#on-demand-evaluation-scan">On-demand evaluation scan</a> </li>
</ul>
</div>
</article>
<article class="md-post md-post--excerpt">
<header class="md-post__header">
<nav class="md-post__authors md-typeset">
<span class="md-author">
<img alt="Rafael FernÃ¡ndez" src="https://avatars.githubusercontent.com/u/39990341">
</span>
</nav>
<div class="md-post__meta md-meta">
<ul class="md-meta__list">
<li class="md-meta__item">
<time datetime="2024-11-05 00:00:00+00:00">November 5, 2024</time></li>
<li class="md-meta__item">
            in
            
              <a class="md-meta__link" href="../../category/azure-services/">Azure Services</a></li>
<li class="md-meta__item">
            
              8 min read
            
          </li>
</ul>
</div>
</header>
<div class="md-post__content md-typeset">
<h2 id="custom-azure-policy-for-kubernetes"><a class="toclink" href="../../2024/11/05/custom-azure-policy-for-kubernetes/">Custom Azure Policy for Kubernetes</a></h2>
<p>Azure Policy is a service in Azure that you can use to create, assign, and manage policies that enforce different rules and effects over your resources. These policies can help you stay compliant with your corporate standards and service-level agreements. In this article, we will discuss how to create a custom Azure Policy for Kubernetes.</p>
<h3 id="how-azure-policy-works-in-kubernetes"><a class="toclink" href="../../2024/11/05/custom-azure-policy-for-kubernetes/#how-azure-policy-works-in-kubernetes">How Azure Policy works in kubernetes</a></h3>
<p>Azure Policy for Kubernetes is an extension of Azure Policy that allows you to enforce policies on your Kubernetes clusters. You can use Azure Policy to define policies that apply to your Kubernetes resources, such as pods, deployments, and services. These policies can help you ensure that your Kubernetes clusters are compliant with your organization's standards and best practices.</p>
<p>Azure Policy for Kubernetes uses Gatekeeper, an open-source policy controller for Kubernetes, to enforce policies on your clusters. Gatekeeper uses the Open Policy Agent (OPA) policy language to define policies and evaluate them against your Kubernetes resources. You can use Gatekeeper to create custom policies that enforce specific rules and effects on your clusters.</p>
<pre class="mermaid"><code>graph TD
    A[Azure Policy] --&gt;|Enforce policies| B["add-on azure-policy(Gatekeeper)"]
    B --&gt;|Evaluate policies| C[Kubernetes resources]
</code></pre>
<p>Azure Policy for Kubernetes supports the following cluster environments:</p>
<ul>
<li>Azure Kubernetes Service (AKS), through Azure Policy's Add-on for AKS</li>
<li>Azure Arc enabled Kubernetes, through Azure Policy's Extension for Arc</li>
</ul>
<h3 id="prepare-your-environment"><a class="toclink" href="../../2024/11/05/custom-azure-policy-for-kubernetes/#prepare-your-environment">Prepare your environment</a></h3>
<p>Before you can create custom Azure Policy for Kubernetes, you need to set up your environment. You will need an Azure Kubernetes Service (AKS) cluster with the Azure Policy add-on enabled. You will also need the Azure CLI and the <a href="https://learn.microsoft.com/en-us/azure/governance/policy/how-to/extension-for-vscode">Azure Policy extension</a> for Visual Studio Code.</p>
<p>To set up your environment, follow these steps:</p>
<ol>
<li>
<p>Create a resource group</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-8-1"><a href="#__codelineno-8-1" id="__codelineno-8-1" name="__codelineno-8-1"></a>az group create --name myResourceGroup --location spaincentral
</span></code></pre></div>
</li>
<li>
<p>Create an Azure Kubernetes Service (AKS) cluster with default settings and one node:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a href="#__codelineno-9-1" id="__codelineno-9-1" name="__codelineno-9-1"></a>az aks create --resource-group myResourceGroup --name myAKSCluster --node-count 1
</span></code></pre></div>
</li>
<li>
<p>Enable Azure Policies for the cluster:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-10-1"><a href="#__codelineno-10-1" id="__codelineno-10-1" name="__codelineno-10-1"></a>az aks enable-addons --resource-group myResourceGroup --name myAKSCluster --addons azure-policy
</span></code></pre></div>
</li>
<li>
<p>Check the status of the add-on:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-11-1"><a href="#__codelineno-11-1" id="__codelineno-11-1" name="__codelineno-11-1"></a>az aks show --resource-group myResourceGroup --name myAKSCluster --query addonProfiles.azurepolicy.enabled
</span></code></pre></div>
</li>
<li>
<p>Check the status of gatekeeper:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-12-1"><a href="#__codelineno-12-1" id="__codelineno-12-1" name="__codelineno-12-1"></a># Install kubectl and kubelogin
</span><span id="__span-12-2"><a href="#__codelineno-12-2" id="__codelineno-12-2" name="__codelineno-12-2"></a>az aks install-cli --install-location .local/bin/kubectl --kubelogin-install-location .local/bin/kubelogin
</span><span id="__span-12-3"><a href="#__codelineno-12-3" id="__codelineno-12-3" name="__codelineno-12-3"></a># Get the credentials for the AKS cluster
</span><span id="__span-12-4"><a href="#__codelineno-12-4" id="__codelineno-12-4" name="__codelineno-12-4"></a>az aks get-credentials --resource-group myResourceGroup --name myAKSCluster --overwrite-existing
</span><span id="__span-12-5"><a href="#__codelineno-12-5" id="__codelineno-12-5" name="__codelineno-12-5"></a># azure-policy pod is installed in kube-system namespace
</span><span id="__span-12-6"><a href="#__codelineno-12-6" id="__codelineno-12-6" name="__codelineno-12-6"></a>kubectl get pods -n kube-system
</span><span id="__span-12-7"><a href="#__codelineno-12-7" id="__codelineno-12-7" name="__codelineno-12-7"></a># gatekeeper pod is installed in gatekeeper-system namespace
</span><span id="__span-12-8"><a href="#__codelineno-12-8" id="__codelineno-12-8" name="__codelineno-12-8"></a>kubectl get pods -n gatekeeper-system
</span></code></pre></div>
</li>
<li>
<p>Install vscode and the Azure Policy extension</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-13-1"><a href="#__codelineno-13-1" id="__codelineno-13-1" name="__codelineno-13-1"></a>code<span class="w"> </span>--install-extension<span class="w"> </span>ms-azuretools.vscode-azurepolicy
</span></code></pre></div>
</li>
</ol>
<p>Once you have set up your environment, you can create custom Azure Policy for Kubernetes.</p>
<h3 id="how-to-create-a-custom-azure-policy-for-kubernetes"><a class="toclink" href="../../2024/11/05/custom-azure-policy-for-kubernetes/#how-to-create-a-custom-azure-policy-for-kubernetes">How to create a custom Azure Policy for Kubernetes</a></h3>
<p>To create a custom Azure Policy for Kubernetes, you need to define a policy in the Open Policy Agent (OPA) policy language and apply it to your Kubernetes cluster. You can define policies that enforce specific rules and effects on your Kubernetes resources, such as pods, deployments, and services.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>It`s recommended to review Constraint Templates in <a href="https://open-policy-agent.github.io/gatekeeper/website/docs/howto/">How to use Gatekeeper</a></p>
</div>
<p>To create a custom Azure Policy for Kubernetes, follow these steps:</p>
<ol>
<li>
<p>Define a constraint template for the policy, I will use an existing constraint template from the Gatekeeper library that requires Ingress resources to be HTTPS only:</p>
<div class="language-yaml highlight"><span class="filename">gatekeeper-library/library/general/httpsonly/template.yaml</span><pre><span></span><code><span id="__span-14-1"><a href="#__codelineno-14-1" id="__codelineno-14-1" name="__codelineno-14-1"></a><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">templates.gatekeeper.sh/v1</span>
</span><span id="__span-14-2"><a href="#__codelineno-14-2" id="__codelineno-14-2" name="__codelineno-14-2"></a><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ConstraintTemplate</span>
</span><span id="__span-14-3"><a href="#__codelineno-14-3" id="__codelineno-14-3" name="__codelineno-14-3"></a><span class="nt">metadata</span><span class="p">:</span>
</span><span id="__span-14-4"><a href="#__codelineno-14-4" id="__codelineno-14-4" name="__codelineno-14-4"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8shttpsonly</span>
</span><span id="__span-14-5"><a href="#__codelineno-14-5" id="__codelineno-14-5" name="__codelineno-14-5"></a><span class="w">    </span><span class="nt">annotations</span><span class="p">:</span>
</span><span id="__span-14-6"><a href="#__codelineno-14-6" id="__codelineno-14-6" name="__codelineno-14-6"></a><span class="w">        </span><span class="nt">metadata.gatekeeper.sh/title</span><span class="p">:</span><span class="w"> </span><span class="s">"HTTPS</span><span class="nv"> </span><span class="s">Only"</span>
</span><span id="__span-14-7"><a href="#__codelineno-14-7" id="__codelineno-14-7" name="__codelineno-14-7"></a><span class="w">        </span><span class="nt">metadata.gatekeeper.sh/version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0.2</span>
</span><span id="__span-14-8"><a href="#__codelineno-14-8" id="__codelineno-14-8" name="__codelineno-14-8"></a><span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
</span><span id="__span-14-9"><a href="#__codelineno-14-9" id="__codelineno-14-9" name="__codelineno-14-9"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">Requires Ingress resources to be HTTPS only.  Ingress resources must</span>
</span><span id="__span-14-10"><a href="#__codelineno-14-10" id="__codelineno-14-10" name="__codelineno-14-10"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">include the `kubernetes.io/ingress.allow-http` annotation, set to `false`.</span>
</span><span id="__span-14-11"><a href="#__codelineno-14-11" id="__codelineno-14-11" name="__codelineno-14-11"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">By default a valid TLS {} configuration is required, this can be made</span>
</span><span id="__span-14-12"><a href="#__codelineno-14-12" id="__codelineno-14-12" name="__codelineno-14-12"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">optional by setting the `tlsOptional` parameter to `true`.</span>
</span><span id="__span-14-13"><a href="#__codelineno-14-13" id="__codelineno-14-13" name="__codelineno-14-13"></a>
</span><span id="__span-14-14"><a href="#__codelineno-14-14" id="__codelineno-14-14" name="__codelineno-14-14"></a><span class="w">        </span><span class="l l-Scalar l-Scalar-Plain">https://kubernetes.io/docs/concepts/services-networking/ingress/#tls</span>
</span><span id="__span-14-15"><a href="#__codelineno-14-15" id="__codelineno-14-15" name="__codelineno-14-15"></a><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-14-16"><a href="#__codelineno-14-16" id="__codelineno-14-16" name="__codelineno-14-16"></a><span class="nt">crd</span><span class="p">:</span>
</span><span id="__span-14-17"><a href="#__codelineno-14-17" id="__codelineno-14-17" name="__codelineno-14-17"></a><span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
</span><span id="__span-14-18"><a href="#__codelineno-14-18" id="__codelineno-14-18" name="__codelineno-14-18"></a><span class="w">    </span><span class="nt">names</span><span class="p">:</span>
</span><span id="__span-14-19"><a href="#__codelineno-14-19" id="__codelineno-14-19" name="__codelineno-14-19"></a><span class="w">        </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">K8sHttpsOnly</span>
</span><span id="__span-14-20"><a href="#__codelineno-14-20" id="__codelineno-14-20" name="__codelineno-14-20"></a><span class="w">    </span><span class="nt">validation</span><span class="p">:</span>
</span><span id="__span-14-21"><a href="#__codelineno-14-21" id="__codelineno-14-21" name="__codelineno-14-21"></a><span class="w">        </span><span class="c1"># Schema for the `parameters` field</span>
</span><span id="__span-14-22"><a href="#__codelineno-14-22" id="__codelineno-14-22" name="__codelineno-14-22"></a><span class="w">        </span><span class="nt">openAPIV3Schema</span><span class="p">:</span>
</span><span id="__span-14-23"><a href="#__codelineno-14-23" id="__codelineno-14-23" name="__codelineno-14-23"></a><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">object</span>
</span><span id="__span-14-24"><a href="#__codelineno-14-24" id="__codelineno-14-24" name="__codelineno-14-24"></a><span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">&gt;-</span>
</span><span id="__span-14-25"><a href="#__codelineno-14-25" id="__codelineno-14-25" name="__codelineno-14-25"></a><span class="w">            </span><span class="no">Requires Ingress resources to be HTTPS only.  Ingress resources must</span>
</span><span id="__span-14-26"><a href="#__codelineno-14-26" id="__codelineno-14-26" name="__codelineno-14-26"></a><span class="w">            </span><span class="no">include the `kubernetes.io/ingress.allow-http` annotation, set to</span>
</span><span id="__span-14-27"><a href="#__codelineno-14-27" id="__codelineno-14-27" name="__codelineno-14-27"></a><span class="w">            </span><span class="no">`false`. By default a valid TLS {} configuration is required, this</span>
</span><span id="__span-14-28"><a href="#__codelineno-14-28" id="__codelineno-14-28" name="__codelineno-14-28"></a><span class="w">            </span><span class="no">can be made optional by setting the `tlsOptional` parameter to</span>
</span><span id="__span-14-29"><a href="#__codelineno-14-29" id="__codelineno-14-29" name="__codelineno-14-29"></a><span class="w">            </span><span class="no">`true`.</span>
</span><span id="__span-14-30"><a href="#__codelineno-14-30" id="__codelineno-14-30" name="__codelineno-14-30"></a><span class="w">        </span><span class="nt">properties</span><span class="p">:</span>
</span><span id="__span-14-31"><a href="#__codelineno-14-31" id="__codelineno-14-31" name="__codelineno-14-31"></a><span class="w">            </span><span class="nt">tlsOptional</span><span class="p">:</span>
</span><span id="__span-14-32"><a href="#__codelineno-14-32" id="__codelineno-14-32" name="__codelineno-14-32"></a><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">boolean</span>
</span><span id="__span-14-33"><a href="#__codelineno-14-33" id="__codelineno-14-33" name="__codelineno-14-33"></a><span class="w">            </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">"When</span><span class="nv"> </span><span class="s">set</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">`true`</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">TLS</span><span class="nv"> </span><span class="s">{}</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">optional,</span><span class="nv"> </span><span class="s">defaults</span><span class="w"> </span>
</span><span id="__span-14-34"><a href="#__codelineno-14-34" id="__codelineno-14-34" name="__codelineno-14-34"></a><span class="w">            </span><span class="s">to</span><span class="nv"> </span><span class="s">false."</span>
</span><span id="__span-14-35"><a href="#__codelineno-14-35" id="__codelineno-14-35" name="__codelineno-14-35"></a><span class="nt">targets</span><span class="p">:</span>
</span><span id="__span-14-36"><a href="#__codelineno-14-36" id="__codelineno-14-36" name="__codelineno-14-36"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">target</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admission.k8s.gatekeeper.sh</span>
</span><span id="__span-14-37"><a href="#__codelineno-14-37" id="__codelineno-14-37" name="__codelineno-14-37"></a><span class="w">    </span><span class="nt">rego</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
</span><span id="__span-14-38"><a href="#__codelineno-14-38" id="__codelineno-14-38" name="__codelineno-14-38"></a><span class="w">        </span><span class="no">package k8shttpsonly</span>
</span><span id="__span-14-39"><a href="#__codelineno-14-39" id="__codelineno-14-39" name="__codelineno-14-39"></a>
</span><span id="__span-14-40"><a href="#__codelineno-14-40" id="__codelineno-14-40" name="__codelineno-14-40"></a><span class="w">        </span><span class="no">violation[{"msg": msg}] {</span>
</span><span id="__span-14-41"><a href="#__codelineno-14-41" id="__codelineno-14-41" name="__codelineno-14-41"></a><span class="w">        </span><span class="no">input.review.object.kind == "Ingress"</span>
</span><span id="__span-14-42"><a href="#__codelineno-14-42" id="__codelineno-14-42" name="__codelineno-14-42"></a><span class="w">        </span><span class="no">regex.match("^(extensions|networking.k8s.io)/", input.review.object.apiVersion)</span>
</span><span id="__span-14-43"><a href="#__codelineno-14-43" id="__codelineno-14-43" name="__codelineno-14-43"></a><span class="w">        </span><span class="no">ingress := input.review.object</span>
</span><span id="__span-14-44"><a href="#__codelineno-14-44" id="__codelineno-14-44" name="__codelineno-14-44"></a><span class="w">        </span><span class="no">not https_complete(ingress)</span>
</span><span id="__span-14-45"><a href="#__codelineno-14-45" id="__codelineno-14-45" name="__codelineno-14-45"></a><span class="w">        </span><span class="no">not tls_is_optional</span>
</span><span id="__span-14-46"><a href="#__codelineno-14-46" id="__codelineno-14-46" name="__codelineno-14-46"></a><span class="w">        </span><span class="no">msg := sprintf("Ingress should be https. tls configuration and allow-http=false annotation are required for %v", [ingress.metadata.name])</span>
</span><span id="__span-14-47"><a href="#__codelineno-14-47" id="__codelineno-14-47" name="__codelineno-14-47"></a><span class="w">        </span><span class="no">}</span>
</span><span id="__span-14-48"><a href="#__codelineno-14-48" id="__codelineno-14-48" name="__codelineno-14-48"></a>
</span><span id="__span-14-49"><a href="#__codelineno-14-49" id="__codelineno-14-49" name="__codelineno-14-49"></a><span class="w">        </span><span class="no">violation[{"msg": msg}] {</span>
</span><span id="__span-14-50"><a href="#__codelineno-14-50" id="__codelineno-14-50" name="__codelineno-14-50"></a><span class="w">        </span><span class="no">input.review.object.kind == "Ingress"</span>
</span><span id="__span-14-51"><a href="#__codelineno-14-51" id="__codelineno-14-51" name="__codelineno-14-51"></a><span class="w">        </span><span class="no">regex.match("^(extensions|networking.k8s.io)/", input.review.object.apiVersion)</span>
</span><span id="__span-14-52"><a href="#__codelineno-14-52" id="__codelineno-14-52" name="__codelineno-14-52"></a><span class="w">        </span><span class="no">ingress := input.review.object</span>
</span><span id="__span-14-53"><a href="#__codelineno-14-53" id="__codelineno-14-53" name="__codelineno-14-53"></a><span class="w">        </span><span class="no">not annotation_complete(ingress)</span>
</span><span id="__span-14-54"><a href="#__codelineno-14-54" id="__codelineno-14-54" name="__codelineno-14-54"></a><span class="w">        </span><span class="no">tls_is_optional</span>
</span><span id="__span-14-55"><a href="#__codelineno-14-55" id="__codelineno-14-55" name="__codelineno-14-55"></a><span class="w">        </span><span class="no">msg := sprintf("Ingress should be https. The allow-http=false annotation is required for %v", [ingress.metadata.name])</span>
</span><span id="__span-14-56"><a href="#__codelineno-14-56" id="__codelineno-14-56" name="__codelineno-14-56"></a><span class="w">        </span><span class="no">}</span>
</span><span id="__span-14-57"><a href="#__codelineno-14-57" id="__codelineno-14-57" name="__codelineno-14-57"></a>
</span><span id="__span-14-58"><a href="#__codelineno-14-58" id="__codelineno-14-58" name="__codelineno-14-58"></a><span class="w">        </span><span class="no">https_complete(ingress) = true {</span>
</span><span id="__span-14-59"><a href="#__codelineno-14-59" id="__codelineno-14-59" name="__codelineno-14-59"></a><span class="w">        </span><span class="no">ingress.spec["tls"]</span>
</span><span id="__span-14-60"><a href="#__codelineno-14-60" id="__codelineno-14-60" name="__codelineno-14-60"></a><span class="w">        </span><span class="no">count(ingress.spec.tls) &gt; 0</span>
</span><span id="__span-14-61"><a href="#__codelineno-14-61" id="__codelineno-14-61" name="__codelineno-14-61"></a><span class="w">        </span><span class="no">ingress.metadata.annotations["kubernetes.io/ingress.allow-http"] == "false"</span>
</span><span id="__span-14-62"><a href="#__codelineno-14-62" id="__codelineno-14-62" name="__codelineno-14-62"></a><span class="w">        </span><span class="no">}</span>
</span><span id="__span-14-63"><a href="#__codelineno-14-63" id="__codelineno-14-63" name="__codelineno-14-63"></a>
</span><span id="__span-14-64"><a href="#__codelineno-14-64" id="__codelineno-14-64" name="__codelineno-14-64"></a><span class="w">        </span><span class="no">annotation_complete(ingress) = true {</span>
</span><span id="__span-14-65"><a href="#__codelineno-14-65" id="__codelineno-14-65" name="__codelineno-14-65"></a><span class="w">        </span><span class="no">ingress.metadata.annotations["kubernetes.io/ingress.allow-http"] == "false"</span>
</span><span id="__span-14-66"><a href="#__codelineno-14-66" id="__codelineno-14-66" name="__codelineno-14-66"></a><span class="w">        </span><span class="no">}</span>
</span><span id="__span-14-67"><a href="#__codelineno-14-67" id="__codelineno-14-67" name="__codelineno-14-67"></a>
</span><span id="__span-14-68"><a href="#__codelineno-14-68" id="__codelineno-14-68" name="__codelineno-14-68"></a><span class="w">        </span><span class="no">tls_is_optional {</span>
</span><span id="__span-14-69"><a href="#__codelineno-14-69" id="__codelineno-14-69" name="__codelineno-14-69"></a><span class="w">        </span><span class="no">parameters := object.get(input, "parameters", {})</span>
</span><span id="__span-14-70"><a href="#__codelineno-14-70" id="__codelineno-14-70" name="__codelineno-14-70"></a><span class="w">        </span><span class="no">object.get(parameters, "tlsOptional", false) == true</span>
</span><span id="__span-14-71"><a href="#__codelineno-14-71" id="__codelineno-14-71" name="__codelineno-14-71"></a><span class="w">        </span><span class="no">}</span>
</span></code></pre></div>
</li>
</ol>
<p>This constrains requires Ingress resources to be HTTPS only</p>
<ol>
<li>
<p>Create an Azure Policy for this constraint template</p>
<ol>
<li>Open the restriction template created earlier in Visual Studio Code.</li>
<li>Click on Azure Policy icon in the Activity Bar.</li>
<li>Click on View &gt; Command Palette.</li>
<li>Search for the command "Azure Policy for Kubernetes: Create Policy Definition from Constraint Template or Mutation", select base64, this command will create a policy definition from the constraint template.
<div class="language-json highlight"><span class="filename">Untitled.json</span><pre><span></span><code><span id="__span-15-1"><a href="#__codelineno-15-1" id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="p">{</span>
</span><span id="__span-15-2"><a href="#__codelineno-15-2" id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="nt">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-3"><a href="#__codelineno-15-3" id="__codelineno-15-3" name="__codelineno-15-3"></a><span class="w">    </span><span class="nt">"policyType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Custom"</span><span class="p">,</span>
</span><span id="__span-15-4"><a href="#__codelineno-15-4" id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="w">    </span><span class="nt">"mode"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Microsoft.Kubernetes.Data"</span><span class="p">,</span>
</span><span id="__span-15-5"><a href="#__codelineno-15-5" id="__codelineno-15-5" name="__codelineno-15-5"></a><span class="w">    </span><span class="nt">"displayName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/* EDIT HERE */"</span><span class="p">,</span>
</span><span id="__span-15-6"><a href="#__codelineno-15-6" id="__codelineno-15-6" name="__codelineno-15-6"></a><span class="w">    </span><span class="nt">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/* EDIT HERE */"</span><span class="p">,</span>
</span><span id="__span-15-7"><a href="#__codelineno-15-7" id="__codelineno-15-7" name="__codelineno-15-7"></a><span class="w">    </span><span class="nt">"policyRule"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-8"><a href="#__codelineno-15-8" id="__codelineno-15-8" name="__codelineno-15-8"></a><span class="w">    </span><span class="nt">"if"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-9"><a href="#__codelineno-15-9" id="__codelineno-15-9" name="__codelineno-15-9"></a><span class="w">        </span><span class="nt">"field"</span><span class="p">:</span><span class="w"> </span><span class="s2">"type"</span><span class="p">,</span>
</span><span id="__span-15-10"><a href="#__codelineno-15-10" id="__codelineno-15-10" name="__codelineno-15-10"></a><span class="w">        </span><span class="nt">"in"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-15-11"><a href="#__codelineno-15-11" id="__codelineno-15-11" name="__codelineno-15-11"></a><span class="w">        </span><span class="s2">"Microsoft.ContainerService/managedClusters"</span>
</span><span id="__span-15-12"><a href="#__codelineno-15-12" id="__codelineno-15-12" name="__codelineno-15-12"></a><span class="w">        </span><span class="p">]</span>
</span><span id="__span-15-13"><a href="#__codelineno-15-13" id="__codelineno-15-13" name="__codelineno-15-13"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-15-14"><a href="#__codelineno-15-14" id="__codelineno-15-14" name="__codelineno-15-14"></a><span class="w">    </span><span class="nt">"then"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-15"><a href="#__codelineno-15-15" id="__codelineno-15-15" name="__codelineno-15-15"></a><span class="w">        </span><span class="nt">"effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[parameters('effect')]"</span><span class="p">,</span>
</span><span id="__span-15-16"><a href="#__codelineno-15-16" id="__codelineno-15-16" name="__codelineno-15-16"></a><span class="w">        </span><span class="nt">"details"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-17"><a href="#__codelineno-15-17" id="__codelineno-15-17" name="__codelineno-15-17"></a><span class="w">        </span><span class="nt">"templateInfo"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-18"><a href="#__codelineno-15-18" id="__codelineno-15-18" name="__codelineno-15-18"></a><span class="w">            </span><span class="nt">"sourceType"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Base64Encoded"</span><span class="p">,</span>
</span><span id="__span-15-19"><a href="#__codelineno-15-19" id="__codelineno-15-19" name="__codelineno-15-19"></a><span class="w">            </span><span class="nt">"content"</span><span class="p">:</span><span class="w"> </span><span class="s2">"YXBpVmVyc2lvbjogdGVtcGxhdGVzLmdhdGVrZWVwZXIuc2gvdjEKa2luZDogQ29uc3RyYWludFRlbXBsYXRlCm1ldGFkYXRhOgogIG5hbWU6IGs4c2h0dHBzb25seQogIGFubm90YXRpb25zOgogICAgbWV0YWRhdGEuZ2F0ZWtlZXBlci5zaC90aXRsZTogIkhUVFBTIE9ubHkiCiAgICBtZXRhZGF0YS5nYXRla2VlcGVyLnNoL3ZlcnNpb246IDEuMC4yCiAgICBkZXNjcmlwdGlvbjogPi0KICAgICAgUmVxdWlyZXMgSW5ncmVzcyByZXNvdXJjZXMgdG8gYmUgSFRUUFMgb25seS4gIEluZ3Jlc3MgcmVzb3VyY2VzIG11c3QKICAgICAgaW5jbHVkZSB0aGUgYGt1YmVybmV0ZXMuaW8vaW5ncmVzcy5hbGxvdy1odHRwYCBhbm5vdGF0aW9uLCBzZXQgdG8gYGZhbHNlYC4KICAgICAgQnkgZGVmYXVsdCBhIHZhbGlkIFRMUyB7fSBjb25maWd1cmF0aW9uIGlzIHJlcXVpcmVkLCB0aGlzIGNhbiBiZSBtYWRlCiAgICAgIG9wdGlvbmFsIGJ5IHNldHRpbmcgdGhlIGB0bHNPcHRpb25hbGAgcGFyYW1ldGVyIHRvIGB0cnVlYC4KCiAgICAgIGh0dHBzOi8va3ViZXJuZXRlcy5pby9kb2NzL2NvbmNlcHRzL3NlcnZpY2VzLW5ldHdvcmtpbmcvaW5ncmVzcy8jdGxzCnNwZWM6CiAgY3JkOgogICAgc3BlYzoKICAgICAgbmFtZXM6CiAgICAgICAga2luZDogSzhzSHR0cHNPbmx5CiAgICAgIHZhbGlkYXRpb246CiAgICAgICAgIyBTY2hlbWEgZm9yIHRoZSBgcGFyYW1ldGVyc2AgZmllbGQKICAgICAgICBvcGVuQVBJVjNTY2hlbWE6CiAgICAgICAgICB0eXBlOiBvYmplY3QKICAgICAgICAgIGRlc2NyaXB0aW9uOiA+LQogICAgICAgICAgICBSZXF1aXJlcyBJbmdyZXNzIHJlc291cmNlcyB0byBiZSBIVFRQUyBvbmx5LiAgSW5ncmVzcyByZXNvdXJjZXMgbXVzdAogICAgICAgICAgICBpbmNsdWRlIHRoZSBga3ViZXJuZXRlcy5pby9pbmdyZXNzLmFsbG93LWh0dHBgIGFubm90YXRpb24sIHNldCB0bwogICAgICAgICAgICBgZmFsc2VgLiBCeSBkZWZhdWx0IGEgdmFsaWQgVExTIHt9IGNvbmZpZ3VyYXRpb24gaXMgcmVxdWlyZWQsIHRoaXMKICAgICAgICAgICAgY2FuIGJlIG1hZGUgb3B0aW9uYWwgYnkgc2V0dGluZyB0aGUgYHRsc09wdGlvbmFsYCBwYXJhbWV0ZXIgdG8KICAgICAgICAgICAgYHRydWVgLgogICAgICAgICAgcHJvcGVydGllczoKICAgICAgICAgICAgdGxzT3B0aW9uYWw6CiAgICAgICAgICAgICAgdHlwZTogYm9vbGVhbgogICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAiV2hlbiBzZXQgdG8gYHRydWVgIHRoZSBUTFMge30gaXMgb3B0aW9uYWwsIGRlZmF1bHRzCiAgICAgICAgICAgICAgdG8gZmFsc2UuIgogIHRhcmdldHM6CiAgICAtIHRhcmdldDogYWRtaXNzaW9uLms4cy5nYXRla2VlcGVyLnNoCiAgICAgIHJlZ286IHwKICAgICAgICBwYWNrYWdlIGs4c2h0dHBzb25seQoKICAgICAgICB2aW9sYXRpb25beyJtc2ciOiBtc2d9XSB7CiAgICAgICAgICBpbnB1dC5yZXZpZXcub2JqZWN0LmtpbmQgPT0gIkluZ3Jlc3MiCiAgICAgICAgICByZWdleC5tYXRjaCgiXihleHRlbnNpb25zfG5ldHdvcmtpbmcuazhzLmlvKS8iLCBpbnB1dC5yZXZpZXcub2JqZWN0LmFwaVZlcnNpb24pCiAgICAgICAgICBpbmdyZXNzIDo9IGlucHV0LnJldmlldy5vYmplY3QKICAgICAgICAgIG5vdCBodHRwc19jb21wbGV0ZShpbmdyZXNzKQogICAgICAgICAgbm90IHRsc19pc19vcHRpb25hbAogICAgICAgICAgbXNnIDo9IHNwcmludGYoIkluZ3Jlc3Mgc2hvdWxkIGJlIGh0dHBzLiB0bHMgY29uZmlndXJhdGlvbiBhbmQgYWxsb3ctaHR0cD1mYWxzZSBhbm5vdGF0aW9uIGFyZSByZXF1aXJlZCBmb3IgJXYiLCBbaW5ncmVzcy5tZXRhZGF0YS5uYW1lXSkKICAgICAgICB9CgogICAgICAgIHZpb2xhdGlvblt7Im1zZyI6IG1zZ31dIHsKICAgICAgICAgIGlucHV0LnJldmlldy5vYmplY3Qua2luZCA9PSAiSW5ncmVzcyIKICAgICAgICAgIHJlZ2V4Lm1hdGNoKCJeKGV4dGVuc2lvbnN8bmV0d29ya2luZy5rOHMuaW8pLyIsIGlucHV0LnJldmlldy5vYmplY3QuYXBpVmVyc2lvbikKICAgICAgICAgIGluZ3Jlc3MgOj0gaW5wdXQucmV2aWV3Lm9iamVjdAogICAgICAgICAgbm90IGFubm90YXRpb25fY29tcGxldGUoaW5ncmVzcykKICAgICAgICAgIHRsc19pc19vcHRpb25hbAogICAgICAgICAgbXNnIDo9IHNwcmludGYoIkluZ3Jlc3Mgc2hvdWxkIGJlIGh0dHBzLiBUaGUgYWxsb3ctaHR0cD1mYWxzZSBhbm5vdGF0aW9uIGlzIHJlcXVpcmVkIGZvciAldiIsIFtpbmdyZXNzLm1ldGFkYXRhLm5hbWVdKQogICAgICAgIH0KCiAgICAgICAgaHR0cHNfY29tcGxldGUoaW5ncmVzcykgPSB0cnVlIHsKICAgICAgICAgIGluZ3Jlc3Muc3BlY1sidGxzIl0KICAgICAgICAgIGNvdW50KGluZ3Jlc3Muc3BlYy50bHMpID4gMAogICAgICAgICAgaW5ncmVzcy5tZXRhZGF0YS5hbm5vdGF0aW9uc1sia3ViZXJuZXRlcy5pby9pbmdyZXNzLmFsbG93LWh0dHAiXSA9PSAiZmFsc2UiCiAgICAgICAgfQoKICAgICAgICBhbm5vdGF0aW9uX2NvbXBsZXRlKGluZ3Jlc3MpID0gdHJ1ZSB7CiAgICAgICAgICBpbmdyZXNzLm1ldGFkYXRhLmFubm90YXRpb25zWyJrdWJlcm5ldGVzLmlvL2luZ3Jlc3MuYWxsb3ctaHR0cCJdID09ICJmYWxzZSIKICAgICAgICB9CgogICAgICAgIHRsc19pc19vcHRpb25hbCB7CiAgICAgICAgICBwYXJhbWV0ZXJzIDo9IG9iamVjdC5nZXQoaW5wdXQsICJwYXJhbWV0ZXJzIiwge30pCiAgICAgICAgICBvYmplY3QuZ2V0KHBhcmFtZXRlcnMsICJ0bHNPcHRpb25hbCIsIGZhbHNlKSA9PSB0cnVlCiAgICAgICAgfQ=="</span>
</span><span id="__span-15-20"><a href="#__codelineno-15-20" id="__codelineno-15-20" name="__codelineno-15-20"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-15-21"><a href="#__codelineno-15-21" id="__codelineno-15-21" name="__codelineno-15-21"></a><span class="w">        </span><span class="nt">"apiGroups"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-15-22"><a href="#__codelineno-15-22" id="__codelineno-15-22" name="__codelineno-15-22"></a><span class="w">            </span><span class="s2">"/* EDIT HERE */"</span>
</span><span id="__span-15-23"><a href="#__codelineno-15-23" id="__codelineno-15-23" name="__codelineno-15-23"></a><span class="w">        </span><span class="p">],</span>
</span><span id="__span-15-24"><a href="#__codelineno-15-24" id="__codelineno-15-24" name="__codelineno-15-24"></a><span class="w">        </span><span class="nt">"kinds"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-15-25"><a href="#__codelineno-15-25" id="__codelineno-15-25" name="__codelineno-15-25"></a><span class="w">            </span><span class="s2">"/* EDIT HERE */"</span>
</span><span id="__span-15-26"><a href="#__codelineno-15-26" id="__codelineno-15-26" name="__codelineno-15-26"></a><span class="w">        </span><span class="p">],</span>
</span><span id="__span-15-27"><a href="#__codelineno-15-27" id="__codelineno-15-27" name="__codelineno-15-27"></a><span class="w">        </span><span class="nt">"namespaces"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[parameters('namespaces')]"</span><span class="p">,</span>
</span><span id="__span-15-28"><a href="#__codelineno-15-28" id="__codelineno-15-28" name="__codelineno-15-28"></a><span class="w">        </span><span class="nt">"excludedNamespaces"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[parameters('excludedNamespaces')]"</span><span class="p">,</span>
</span><span id="__span-15-29"><a href="#__codelineno-15-29" id="__codelineno-15-29" name="__codelineno-15-29"></a><span class="w">        </span><span class="nt">"labelSelector"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[parameters('labelSelector')]"</span><span class="p">,</span>
</span><span id="__span-15-30"><a href="#__codelineno-15-30" id="__codelineno-15-30" name="__codelineno-15-30"></a><span class="w">        </span><span class="nt">"values"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-31"><a href="#__codelineno-15-31" id="__codelineno-15-31" name="__codelineno-15-31"></a><span class="w">            </span><span class="nt">"tlsOptional"</span><span class="p">:</span><span class="w"> </span><span class="s2">"[parameters('tlsOptional')]"</span>
</span><span id="__span-15-32"><a href="#__codelineno-15-32" id="__codelineno-15-32" name="__codelineno-15-32"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-15-33"><a href="#__codelineno-15-33" id="__codelineno-15-33" name="__codelineno-15-33"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-15-34"><a href="#__codelineno-15-34" id="__codelineno-15-34" name="__codelineno-15-34"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-15-35"><a href="#__codelineno-15-35" id="__codelineno-15-35" name="__codelineno-15-35"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-15-36"><a href="#__codelineno-15-36" id="__codelineno-15-36" name="__codelineno-15-36"></a><span class="w">    </span><span class="nt">"parameters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-37"><a href="#__codelineno-15-37" id="__codelineno-15-37" name="__codelineno-15-37"></a><span class="w">    </span><span class="nt">"effect"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-38"><a href="#__codelineno-15-38" id="__codelineno-15-38" name="__codelineno-15-38"></a><span class="w">        </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"String"</span><span class="p">,</span>
</span><span id="__span-15-39"><a href="#__codelineno-15-39" id="__codelineno-15-39" name="__codelineno-15-39"></a><span class="w">        </span><span class="nt">"metadata"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-40"><a href="#__codelineno-15-40" id="__codelineno-15-40" name="__codelineno-15-40"></a><span class="w">        </span><span class="nt">"displayName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Effect"</span><span class="p">,</span>
</span><span id="__span-15-41"><a href="#__codelineno-15-41" id="__codelineno-15-41" name="__codelineno-15-41"></a><span class="w">        </span><span class="nt">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"'audit' allows a non-compliant resource to be created or updated, but flags it as non-compliant. 'deny' blocks the non-compliant resource creation or update. 'disabled' turns off the policy."</span>
</span><span id="__span-15-42"><a href="#__codelineno-15-42" id="__codelineno-15-42" name="__codelineno-15-42"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-15-43"><a href="#__codelineno-15-43" id="__codelineno-15-43" name="__codelineno-15-43"></a><span class="w">        </span><span class="nt">"allowedValues"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-15-44"><a href="#__codelineno-15-44" id="__codelineno-15-44" name="__codelineno-15-44"></a><span class="w">        </span><span class="s2">"audit"</span><span class="p">,</span>
</span><span id="__span-15-45"><a href="#__codelineno-15-45" id="__codelineno-15-45" name="__codelineno-15-45"></a><span class="w">        </span><span class="s2">"deny"</span><span class="p">,</span>
</span><span id="__span-15-46"><a href="#__codelineno-15-46" id="__codelineno-15-46" name="__codelineno-15-46"></a><span class="w">        </span><span class="s2">"disabled"</span>
</span><span id="__span-15-47"><a href="#__codelineno-15-47" id="__codelineno-15-47" name="__codelineno-15-47"></a><span class="w">        </span><span class="p">],</span>
</span><span id="__span-15-48"><a href="#__codelineno-15-48" id="__codelineno-15-48" name="__codelineno-15-48"></a><span class="w">        </span><span class="nt">"defaultValue"</span><span class="p">:</span><span class="w"> </span><span class="s2">"audit"</span>
</span><span id="__span-15-49"><a href="#__codelineno-15-49" id="__codelineno-15-49" name="__codelineno-15-49"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-15-50"><a href="#__codelineno-15-50" id="__codelineno-15-50" name="__codelineno-15-50"></a><span class="w">    </span><span class="nt">"excludedNamespaces"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-51"><a href="#__codelineno-15-51" id="__codelineno-15-51" name="__codelineno-15-51"></a><span class="w">        </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Array"</span><span class="p">,</span>
</span><span id="__span-15-52"><a href="#__codelineno-15-52" id="__codelineno-15-52" name="__codelineno-15-52"></a><span class="w">        </span><span class="nt">"metadata"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-53"><a href="#__codelineno-15-53" id="__codelineno-15-53" name="__codelineno-15-53"></a><span class="w">        </span><span class="nt">"displayName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Namespace exclusions"</span><span class="p">,</span>
</span><span id="__span-15-54"><a href="#__codelineno-15-54" id="__codelineno-15-54" name="__codelineno-15-54"></a><span class="w">        </span><span class="nt">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"List of Kubernetes namespaces to exclude from policy evaluation."</span>
</span><span id="__span-15-55"><a href="#__codelineno-15-55" id="__codelineno-15-55" name="__codelineno-15-55"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-15-56"><a href="#__codelineno-15-56" id="__codelineno-15-56" name="__codelineno-15-56"></a><span class="w">        </span><span class="nt">"defaultValue"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-15-57"><a href="#__codelineno-15-57" id="__codelineno-15-57" name="__codelineno-15-57"></a><span class="w">        </span><span class="s2">"kube-system"</span><span class="p">,</span>
</span><span id="__span-15-58"><a href="#__codelineno-15-58" id="__codelineno-15-58" name="__codelineno-15-58"></a><span class="w">        </span><span class="s2">"gatekeeper-system"</span><span class="p">,</span>
</span><span id="__span-15-59"><a href="#__codelineno-15-59" id="__codelineno-15-59" name="__codelineno-15-59"></a><span class="w">        </span><span class="s2">"azure-arc"</span>
</span><span id="__span-15-60"><a href="#__codelineno-15-60" id="__codelineno-15-60" name="__codelineno-15-60"></a><span class="w">        </span><span class="p">]</span>
</span><span id="__span-15-61"><a href="#__codelineno-15-61" id="__codelineno-15-61" name="__codelineno-15-61"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-15-62"><a href="#__codelineno-15-62" id="__codelineno-15-62" name="__codelineno-15-62"></a><span class="w">    </span><span class="nt">"namespaces"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-63"><a href="#__codelineno-15-63" id="__codelineno-15-63" name="__codelineno-15-63"></a><span class="w">        </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Array"</span><span class="p">,</span>
</span><span id="__span-15-64"><a href="#__codelineno-15-64" id="__codelineno-15-64" name="__codelineno-15-64"></a><span class="w">        </span><span class="nt">"metadata"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-65"><a href="#__codelineno-15-65" id="__codelineno-15-65" name="__codelineno-15-65"></a><span class="w">        </span><span class="nt">"displayName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Namespace inclusions"</span><span class="p">,</span>
</span><span id="__span-15-66"><a href="#__codelineno-15-66" id="__codelineno-15-66" name="__codelineno-15-66"></a><span class="w">        </span><span class="nt">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"List of Kubernetes namespaces to only include in policy evaluation. An empty list means the policy is applied to all resources in all namespaces."</span>
</span><span id="__span-15-67"><a href="#__codelineno-15-67" id="__codelineno-15-67" name="__codelineno-15-67"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-15-68"><a href="#__codelineno-15-68" id="__codelineno-15-68" name="__codelineno-15-68"></a><span class="w">        </span><span class="nt">"defaultValue"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span>
</span><span id="__span-15-69"><a href="#__codelineno-15-69" id="__codelineno-15-69" name="__codelineno-15-69"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-15-70"><a href="#__codelineno-15-70" id="__codelineno-15-70" name="__codelineno-15-70"></a><span class="w">    </span><span class="nt">"labelSelector"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-71"><a href="#__codelineno-15-71" id="__codelineno-15-71" name="__codelineno-15-71"></a><span class="w">        </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Object"</span><span class="p">,</span>
</span><span id="__span-15-72"><a href="#__codelineno-15-72" id="__codelineno-15-72" name="__codelineno-15-72"></a><span class="w">        </span><span class="nt">"metadata"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-73"><a href="#__codelineno-15-73" id="__codelineno-15-73" name="__codelineno-15-73"></a><span class="w">        </span><span class="nt">"displayName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Kubernetes label selector"</span><span class="p">,</span>
</span><span id="__span-15-74"><a href="#__codelineno-15-74" id="__codelineno-15-74" name="__codelineno-15-74"></a><span class="w">        </span><span class="nt">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Label query to select Kubernetes resources for policy evaluation. An empty label selector matches all Kubernetes resources."</span>
</span><span id="__span-15-75"><a href="#__codelineno-15-75" id="__codelineno-15-75" name="__codelineno-15-75"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-15-76"><a href="#__codelineno-15-76" id="__codelineno-15-76" name="__codelineno-15-76"></a><span class="w">        </span><span class="nt">"defaultValue"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span>
</span><span id="__span-15-77"><a href="#__codelineno-15-77" id="__codelineno-15-77" name="__codelineno-15-77"></a><span class="w">        </span><span class="nt">"schema"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-78"><a href="#__codelineno-15-78" id="__codelineno-15-78" name="__codelineno-15-78"></a><span class="w">        </span><span class="nt">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"A label selector is a label query over a set of resources. The result of matchLabels and matchExpressions are ANDed. An empty label selector matches all resources."</span><span class="p">,</span>
</span><span id="__span-15-79"><a href="#__codelineno-15-79" id="__codelineno-15-79" name="__codelineno-15-79"></a><span class="w">        </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span>
</span><span id="__span-15-80"><a href="#__codelineno-15-80" id="__codelineno-15-80" name="__codelineno-15-80"></a><span class="w">        </span><span class="nt">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-81"><a href="#__codelineno-15-81" id="__codelineno-15-81" name="__codelineno-15-81"></a><span class="w">            </span><span class="nt">"matchLabels"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-82"><a href="#__codelineno-15-82" id="__codelineno-15-82" name="__codelineno-15-82"></a><span class="w">            </span><span class="nt">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"matchLabels is a map of {key,value} pairs."</span><span class="p">,</span>
</span><span id="__span-15-83"><a href="#__codelineno-15-83" id="__codelineno-15-83" name="__codelineno-15-83"></a><span class="w">            </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span>
</span><span id="__span-15-84"><a href="#__codelineno-15-84" id="__codelineno-15-84" name="__codelineno-15-84"></a><span class="w">            </span><span class="nt">"additionalProperties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-85"><a href="#__codelineno-15-85" id="__codelineno-15-85" name="__codelineno-15-85"></a><span class="w">                </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span>
</span><span id="__span-15-86"><a href="#__codelineno-15-86" id="__codelineno-15-86" name="__codelineno-15-86"></a><span class="w">            </span><span class="p">},</span>
</span><span id="__span-15-87"><a href="#__codelineno-15-87" id="__codelineno-15-87" name="__codelineno-15-87"></a><span class="w">            </span><span class="nt">"minProperties"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-15-88"><a href="#__codelineno-15-88" id="__codelineno-15-88" name="__codelineno-15-88"></a><span class="w">            </span><span class="p">},</span>
</span><span id="__span-15-89"><a href="#__codelineno-15-89" id="__codelineno-15-89" name="__codelineno-15-89"></a><span class="w">            </span><span class="nt">"matchExpressions"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-90"><a href="#__codelineno-15-90" id="__codelineno-15-90" name="__codelineno-15-90"></a><span class="w">            </span><span class="nt">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"matchExpressions is a list of values, a key, and an operator."</span><span class="p">,</span>
</span><span id="__span-15-91"><a href="#__codelineno-15-91" id="__codelineno-15-91" name="__codelineno-15-91"></a><span class="w">            </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span>
</span><span id="__span-15-92"><a href="#__codelineno-15-92" id="__codelineno-15-92" name="__codelineno-15-92"></a><span class="w">            </span><span class="nt">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-93"><a href="#__codelineno-15-93" id="__codelineno-15-93" name="__codelineno-15-93"></a><span class="w">                </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"object"</span><span class="p">,</span>
</span><span id="__span-15-94"><a href="#__codelineno-15-94" id="__codelineno-15-94" name="__codelineno-15-94"></a><span class="w">                </span><span class="nt">"properties"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-95"><a href="#__codelineno-15-95" id="__codelineno-15-95" name="__codelineno-15-95"></a><span class="w">                </span><span class="nt">"key"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-96"><a href="#__codelineno-15-96" id="__codelineno-15-96" name="__codelineno-15-96"></a><span class="w">                    </span><span class="nt">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"key is the label key that the selector applies to."</span><span class="p">,</span>
</span><span id="__span-15-97"><a href="#__codelineno-15-97" id="__codelineno-15-97" name="__codelineno-15-97"></a><span class="w">                    </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span>
</span><span id="__span-15-98"><a href="#__codelineno-15-98" id="__codelineno-15-98" name="__codelineno-15-98"></a><span class="w">                </span><span class="p">},</span>
</span><span id="__span-15-99"><a href="#__codelineno-15-99" id="__codelineno-15-99" name="__codelineno-15-99"></a><span class="w">                </span><span class="nt">"operator"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-100"><a href="#__codelineno-15-100" id="__codelineno-15-100" name="__codelineno-15-100"></a><span class="w">                    </span><span class="nt">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"operator represents a key's relationship to a set of values."</span><span class="p">,</span>
</span><span id="__span-15-101"><a href="#__codelineno-15-101" id="__codelineno-15-101" name="__codelineno-15-101"></a><span class="w">                    </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span><span class="p">,</span>
</span><span id="__span-15-102"><a href="#__codelineno-15-102" id="__codelineno-15-102" name="__codelineno-15-102"></a><span class="w">                    </span><span class="nt">"enum"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-15-103"><a href="#__codelineno-15-103" id="__codelineno-15-103" name="__codelineno-15-103"></a><span class="w">                    </span><span class="s2">"In"</span><span class="p">,</span>
</span><span id="__span-15-104"><a href="#__codelineno-15-104" id="__codelineno-15-104" name="__codelineno-15-104"></a><span class="w">                    </span><span class="s2">"NotIn"</span><span class="p">,</span>
</span><span id="__span-15-105"><a href="#__codelineno-15-105" id="__codelineno-15-105" name="__codelineno-15-105"></a><span class="w">                    </span><span class="s2">"Exists"</span><span class="p">,</span>
</span><span id="__span-15-106"><a href="#__codelineno-15-106" id="__codelineno-15-106" name="__codelineno-15-106"></a><span class="w">                    </span><span class="s2">"DoesNotExist"</span>
</span><span id="__span-15-107"><a href="#__codelineno-15-107" id="__codelineno-15-107" name="__codelineno-15-107"></a><span class="w">                    </span><span class="p">]</span>
</span><span id="__span-15-108"><a href="#__codelineno-15-108" id="__codelineno-15-108" name="__codelineno-15-108"></a><span class="w">                </span><span class="p">},</span>
</span><span id="__span-15-109"><a href="#__codelineno-15-109" id="__codelineno-15-109" name="__codelineno-15-109"></a><span class="w">                </span><span class="nt">"values"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-110"><a href="#__codelineno-15-110" id="__codelineno-15-110" name="__codelineno-15-110"></a><span class="w">                    </span><span class="nt">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"values is an array of string values. If the operator is In or NotIn, the values array must be non-empty. If the operator is Exists or DoesNotExist, the values array must be empty."</span><span class="p">,</span>
</span><span id="__span-15-111"><a href="#__codelineno-15-111" id="__codelineno-15-111" name="__codelineno-15-111"></a><span class="w">                    </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"array"</span><span class="p">,</span>
</span><span id="__span-15-112"><a href="#__codelineno-15-112" id="__codelineno-15-112" name="__codelineno-15-112"></a><span class="w">                    </span><span class="nt">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-113"><a href="#__codelineno-15-113" id="__codelineno-15-113" name="__codelineno-15-113"></a><span class="w">                    </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"string"</span>
</span><span id="__span-15-114"><a href="#__codelineno-15-114" id="__codelineno-15-114" name="__codelineno-15-114"></a><span class="w">                    </span><span class="p">}</span>
</span><span id="__span-15-115"><a href="#__codelineno-15-115" id="__codelineno-15-115" name="__codelineno-15-115"></a><span class="w">                </span><span class="p">}</span>
</span><span id="__span-15-116"><a href="#__codelineno-15-116" id="__codelineno-15-116" name="__codelineno-15-116"></a><span class="w">                </span><span class="p">},</span>
</span><span id="__span-15-117"><a href="#__codelineno-15-117" id="__codelineno-15-117" name="__codelineno-15-117"></a><span class="w">                </span><span class="nt">"required"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
</span><span id="__span-15-118"><a href="#__codelineno-15-118" id="__codelineno-15-118" name="__codelineno-15-118"></a><span class="w">                </span><span class="s2">"key"</span><span class="p">,</span>
</span><span id="__span-15-119"><a href="#__codelineno-15-119" id="__codelineno-15-119" name="__codelineno-15-119"></a><span class="w">                </span><span class="s2">"operator"</span>
</span><span id="__span-15-120"><a href="#__codelineno-15-120" id="__codelineno-15-120" name="__codelineno-15-120"></a><span class="w">                </span><span class="p">],</span>
</span><span id="__span-15-121"><a href="#__codelineno-15-121" id="__codelineno-15-121" name="__codelineno-15-121"></a><span class="w">                </span><span class="nt">"additionalProperties"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>
</span><span id="__span-15-122"><a href="#__codelineno-15-122" id="__codelineno-15-122" name="__codelineno-15-122"></a><span class="w">            </span><span class="p">},</span>
</span><span id="__span-15-123"><a href="#__codelineno-15-123" id="__codelineno-15-123" name="__codelineno-15-123"></a><span class="w">            </span><span class="nt">"minItems"</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
</span><span id="__span-15-124"><a href="#__codelineno-15-124" id="__codelineno-15-124" name="__codelineno-15-124"></a><span class="w">            </span><span class="p">}</span>
</span><span id="__span-15-125"><a href="#__codelineno-15-125" id="__codelineno-15-125" name="__codelineno-15-125"></a><span class="w">        </span><span class="p">},</span>
</span><span id="__span-15-126"><a href="#__codelineno-15-126" id="__codelineno-15-126" name="__codelineno-15-126"></a><span class="w">        </span><span class="nt">"additionalProperties"</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span>
</span><span id="__span-15-127"><a href="#__codelineno-15-127" id="__codelineno-15-127" name="__codelineno-15-127"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-15-128"><a href="#__codelineno-15-128" id="__codelineno-15-128" name="__codelineno-15-128"></a><span class="w">    </span><span class="p">},</span>
</span><span id="__span-15-129"><a href="#__codelineno-15-129" id="__codelineno-15-129" name="__codelineno-15-129"></a><span class="w">    </span><span class="nt">"tlsOptional"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-130"><a href="#__codelineno-15-130" id="__codelineno-15-130" name="__codelineno-15-130"></a><span class="w">        </span><span class="nt">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Boolean"</span><span class="p">,</span>
</span><span id="__span-15-131"><a href="#__codelineno-15-131" id="__codelineno-15-131" name="__codelineno-15-131"></a><span class="w">        </span><span class="nt">"metadata"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-15-132"><a href="#__codelineno-15-132" id="__codelineno-15-132" name="__codelineno-15-132"></a><span class="w">        </span><span class="nt">"displayName"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/* EDIT HERE */"</span><span class="p">,</span>
</span><span id="__span-15-133"><a href="#__codelineno-15-133" id="__codelineno-15-133" name="__codelineno-15-133"></a><span class="w">        </span><span class="nt">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/* EDIT HERE */"</span>
</span><span id="__span-15-134"><a href="#__codelineno-15-134" id="__codelineno-15-134" name="__codelineno-15-134"></a><span class="w">        </span><span class="p">}</span>
</span><span id="__span-15-135"><a href="#__codelineno-15-135" id="__codelineno-15-135" name="__codelineno-15-135"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-15-136"><a href="#__codelineno-15-136" id="__codelineno-15-136" name="__codelineno-15-136"></a><span class="w">    </span><span class="p">}</span>
</span><span id="__span-15-137"><a href="#__codelineno-15-137" id="__codelineno-15-137" name="__codelineno-15-137"></a><span class="p">}</span>
</span><span id="__span-15-138"><a href="#__codelineno-15-138" id="__codelineno-15-138" name="__codelineno-15-138"></a><span class="p">}</span>
</span></code></pre></div></li>
<li>Fill the fields with "/<em> EDIT HERE </em>/" in the policy definition JSON file with the appropriate values, such as the display name, description, API groups, and kinds. For example, in this case you must configure apiGroups:
 ["extensions", "networking.k8s.io"] and kinds: ["Ingress"]</li>
<li>Save the policy definition JSON file.</li>
</ol>
</li>
</ol>
<p>This is the complete policy:</p>
<p><code>json title="https-only.json"
    {
    "properties": {
        "policyType": "Custom",
        "mode": "Microsoft.Kubernetes.Data",
        "displayName": "Require HTTPS for Ingress resources",
        "description": "This policy requires Ingress resources to be HTTPS only. Ingress resources must include the `kubernetes.io/ingress.allow-http` annotation, set to `false`. By default a valid TLS configuration is required, this can be made optional by setting the `tlsOptional` parameter to `true`.",
        "policyRule": {
        "if": {
            "field": "type",
            "in": [
            "Microsoft.ContainerService/managedClusters"
            ]
        },
        "then": {
            "effect": "[parameters('effect')]",
            "details": {
            "templateInfo": {
                "sourceType": "Base64Encoded",
                "content": "YXBpVmVyc2lvbjogdGVtcGxhdGVzLmdhdGVrZWVwZXIuc2gvdjEKa2luZDogQ29uc3RyYWludFRlbXBsYXRlCm1ldGFkYXRhOgogIG5hbWU6IGs4c2h0dHBzb25seQogIGFubm90YXRpb25zOgogICAgbWV0YWRhdGEuZ2F0ZWtlZXBlci5zaC90aXRsZTogIkhUVFBTIE9ubHkiCiAgICBtZXRhZGF0YS5nYXRla2VlcGVyLnNoL3ZlcnNpb246IDEuMC4yCiAgICBkZXNjcmlwdGlvbjogPi0KICAgICAgUmVxdWlyZXMgSW5ncmVzcyByZXNvdXJjZXMgdG8gYmUgSFRUUFMgb25seS4gIEluZ3Jlc3MgcmVzb3VyY2VzIG11c3QKICAgICAgaW5jbHVkZSB0aGUgYGt1YmVybmV0ZXMuaW8vaW5ncmVzcy5hbGxvdy1odHRwYCBhbm5vdGF0aW9uLCBzZXQgdG8gYGZhbHNlYC4KICAgICAgQnkgZGVmYXVsdCBhIHZhbGlkIFRMUyB7fSBjb25maWd1cmF0aW9uIGlzIHJlcXVpcmVkLCB0aGlzIGNhbiBiZSBtYWRlCiAgICAgIG9wdGlvbmFsIGJ5IHNldHRpbmcgdGhlIGB0bHNPcHRpb25hbGAgcGFyYW1ldGVyIHRvIGB0cnVlYC4KCiAgICAgIGh0dHBzOi8va3ViZXJuZXRlcy5pby9kb2NzL2NvbmNlcHRzL3NlcnZpY2VzLW5ldHdvcmtpbmcvaW5ncmVzcy8jdGxzCnNwZWM6CiAgY3JkOgogICAgc3BlYzoKICAgICAgbmFtZXM6CiAgICAgICAga2luZDogSzhzSHR0cHNPbmx5CiAgICAgIHZhbGlkYXRpb246CiAgICAgICAgIyBTY2hlbWEgZm9yIHRoZSBgcGFyYW1ldGVyc2AgZmllbGQKICAgICAgICBvcGVuQVBJVjNTY2hlbWE6CiAgICAgICAgICB0eXBlOiBvYmplY3QKICAgICAgICAgIGRlc2NyaXB0aW9uOiA+LQogICAgICAgICAgICBSZXF1aXJlcyBJbmdyZXNzIHJlc291cmNlcyB0byBiZSBIVFRQUyBvbmx5LiAgSW5ncmVzcyByZXNvdXJjZXMgbXVzdAogICAgICAgICAgICBpbmNsdWRlIHRoZSBga3ViZXJuZXRlcy5pby9pbmdyZXNzLmFsbG93LWh0dHBgIGFubm90YXRpb24sIHNldCB0bwogICAgICAgICAgICBgZmFsc2VgLiBCeSBkZWZhdWx0IGEgdmFsaWQgVExTIHt9IGNvbmZpZ3VyYXRpb24gaXMgcmVxdWlyZWQsIHRoaXMKICAgICAgICAgICAgY2FuIGJlIG1hZGUgb3B0aW9uYWwgYnkgc2V0dGluZyB0aGUgYHRsc09wdGlvbmFsYCBwYXJhbWV0ZXIgdG8KICAgICAgICAgICAgYHRydWVgLgogICAgICAgICAgcHJvcGVydGllczoKICAgICAgICAgICAgdGxzT3B0aW9uYWw6CiAgICAgICAgICAgICAgdHlwZTogYm9vbGVhbgogICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiAiV2hlbiBzZXQgdG8gYHRydWVgIHRoZSBUTFMge30gaXMgb3B0aW9uYWwsIGRlZmF1bHRzCiAgICAgICAgICAgICAgdG8gZmFsc2UuIgogIHRhcmdldHM6CiAgICAtIHRhcmdldDogYWRtaXNzaW9uLms4cy5nYXRla2VlcGVyLnNoCiAgICAgIHJlZ286IHwKICAgICAgICBwYWNrYWdlIGs4c2h0dHBzb25seQoKICAgICAgICB2aW9sYXRpb25beyJtc2ciOiBtc2d9XSB7CiAgICAgICAgICBpbnB1dC5yZXZpZXcub2JqZWN0LmtpbmQgPT0gIkluZ3Jlc3MiCiAgICAgICAgICByZWdleC5tYXRjaCgiXihleHRlbnNpb25zfG5ldHdvcmtpbmcuazhzLmlvKS8iLCBpbnB1dC5yZXZpZXcub2JqZWN0LmFwaVZlcnNpb24pCiAgICAgICAgICBpbmdyZXNzIDo9IGlucHV0LnJldmlldy5vYmplY3QKICAgICAgICAgIG5vdCBodHRwc19jb21wbGV0ZShpbmdyZXNzKQogICAgICAgICAgbm90IHRsc19pc19vcHRpb25hbAogICAgICAgICAgbXNnIDo9IHNwcmludGYoIkluZ3Jlc3Mgc2hvdWxkIGJlIGh0dHBzLiB0bHMgY29uZmlndXJhdGlvbiBhbmQgYWxsb3ctaHR0cD1mYWxzZSBhbm5vdGF0aW9uIGFyZSByZXF1aXJlZCBmb3IgJXYiLCBbaW5ncmVzcy5tZXRhZGF0YS5uYW1lXSkKICAgICAgICB9CgogICAgICAgIHZpb2xhdGlvblt7Im1zZyI6IG1zZ31dIHsKICAgICAgICAgIGlucHV0LnJldmlldy5vYmplY3Qua2luZCA9PSAiSW5ncmVzcyIKICAgICAgICAgIHJlZ2V4Lm1hdGNoKCJeKGV4dGVuc2lvbnN8bmV0d29ya2luZy5rOHMuaW8pLyIsIGlucHV0LnJldmlldy5vYmplY3QuYXBpVmVyc2lvbikKICAgICAgICAgIGluZ3Jlc3MgOj0gaW5wdXQucmV2aWV3Lm9iamVjdAogICAgICAgICAgbm90IGFubm90YXRpb25fY29tcGxldGUoaW5ncmVzcykKICAgICAgICAgIHRsc19pc19vcHRpb25hbAogICAgICAgICAgbXNnIDo9IHNwcmludGYoIkluZ3Jlc3Mgc2hvdWxkIGJlIGh0dHBzLiBUaGUgYWxsb3ctaHR0cD1mYWxzZSBhbm5vdGF0aW9uIGlzIHJlcXVpcmVkIGZvciAldiIsIFtpbmdyZXNzLm1ldGFkYXRhLm5hbWVdKQogICAgICAgIH0KCiAgICAgICAgaHR0cHNfY29tcGxldGUoaW5ncmVzcykgPSB0cnVlIHsKICAgICAgICAgIGluZ3Jlc3Muc3BlY1sidGxzIl0KICAgICAgICAgIGNvdW50KGluZ3Jlc3Muc3BlYy50bHMpID4gMAogICAgICAgICAgaW5ncmVzcy5tZXRhZGF0YS5hbm5vdGF0aW9uc1sia3ViZXJuZXRlcy5pby9pbmdyZXNzLmFsbG93LWh0dHAiXSA9PSAiZmFsc2UiCiAgICAgICAgfQoKICAgICAgICBhbm5vdGF0aW9uX2NvbXBsZXRlKGluZ3Jlc3MpID0gdHJ1ZSB7CiAgICAgICAgICBpbmdyZXNzLm1ldGFkYXRhLmFubm90YXRpb25zWyJrdWJlcm5ldGVzLmlvL2luZ3Jlc3MuYWxsb3ctaHR0cCJdID09ICJmYWxzZSIKICAgICAgICB9CgogICAgICAgIHRsc19pc19vcHRpb25hbCB7CiAgICAgICAgICBwYXJhbWV0ZXJzIDo9IG9iamVjdC5nZXQoaW5wdXQsICJwYXJhbWV0ZXJzIiwge30pCiAgICAgICAgICBvYmplY3QuZ2V0KHBhcmFtZXRlcnMsICJ0bHNPcHRpb25hbCIsIGZhbHNlKSA9PSB0cnVlCiAgICAgICAgfQ=="
            },
            "apiGroups": [
                "extensions",
                "networking.k8s.io"
            ],
            "kinds": [
                "Ingress"
            ],
            "namespaces": "[parameters('namespaces')]",
            "excludedNamespaces": "[parameters('excludedNamespaces')]",
            "labelSelector": "[parameters('labelSelector')]",
            "values": {
                "tlsOptional": "[parameters('tlsOptional')]"
            }
            }
        }
        },
        "parameters": {
        "effect": {
            "type": "String",
            "metadata": {
            "displayName": "Effect",
            "description": "'audit' allows a non-compliant resource to be created or updated, but flags it as non-compliant. 'deny' blocks the non-compliant resource creation or update. 'disabled' turns off the policy."
            },
            "allowedValues": [
            "audit",
            "deny",
            "disabled"
            ],
            "defaultValue": "audit"
        },
        "excludedNamespaces": {
            "type": "Array",
            "metadata": {
            "displayName": "Namespace exclusions",
            "description": "List of Kubernetes namespaces to exclude from policy evaluation."
            },
            "defaultValue": [
            "kube-system",
            "gatekeeper-system",
            "azure-arc"
            ]
        },
        "namespaces": {
            "type": "Array",
            "metadata": {
            "displayName": "Namespace inclusions",
            "description": "List of Kubernetes namespaces to only include in policy evaluation. An empty list means the policy is applied to all resources in all namespaces."
            },
            "defaultValue": []
        },
        "labelSelector": {
            "type": "Object",
            "metadata": {
            "displayName": "Kubernetes label selector",
            "description": "Label query to select Kubernetes resources for policy evaluation. An empty label selector matches all Kubernetes resources."
            },
            "defaultValue": {},
            "schema": {
            "description": "A label selector is a label query over a set of resources. The result of matchLabels and matchExpressions are ANDed. An empty label selector matches all resources.",
            "type": "object",
            "properties": {
                "matchLabels": {
                "description": "matchLabels is a map of {key,value} pairs.",
                "type": "object",
                "additionalProperties": {
                    "type": "string"
                },
                "minProperties": 1
                },
                "matchExpressions": {
                "description": "matchExpressions is a list of values, a key, and an operator.",
                "type": "array",
                "items": {
                    "type": "object",
                    "properties": {
                    "key": {
                        "description": "key is the label key that the selector applies to.",
                        "type": "string"
                    },
                    "operator": {
                        "description": "operator represents a key's relationship to a set of values.",
                        "type": "string",
                        "enum": [
                        "In",
                        "NotIn",
                        "Exists",
                        "DoesNotExist"
                        ]
                    },
                    "values": {
                        "description": "values is an array of string values. If the operator is In or NotIn, the values array must be non-empty. If the operator is Exists or DoesNotExist, the values array must be empty.",
                        "type": "array",
                        "items": {
                        "type": "string"
                        }
                    }
                    },
                    "required": [
                    "key",
                    "operator"
                    ],
                    "additionalProperties": false
                },
                "minItems": 1
                }
            },
            "additionalProperties": false
            }
        },
        "tlsOptional": {
            "type": "Boolean",
            "metadata": {
            "displayName": "TLS Optional",
            "description": "Set to true to make TLS optional"
            }
        }
        }
    }
    }</code></p>
<p>Now you have created a custom Azure Policy for Kubernetes that enforces the HTTPS only constraint on your Kubernetes cluster. You can apply this policy to your cluster to ensure that all Ingress resources are HTTPS only creating a policy definition and assigning it to the management group, subscription or resource group where the AKS cluster is located.</p>
<h3 id="conclusion"><a class="toclink" href="../../2024/11/05/custom-azure-policy-for-kubernetes/#conclusion">Conclusion</a></h3>
<p>In this article, we discussed how to create a custom Azure Policy for Kubernetes. We showed you how to define a policy in the Open Policy Agent (OPA) policy language and apply it to your Kubernetes cluster. We also showed you how to create a constraint template for the policy and create an Azure Policy for the constraint template. By following these steps, you can create custom policies that enforce specific rules and effects on your Kubernetes resources.</p>
<h3 id="references"><a class="toclink" href="../../2024/11/05/custom-azure-policy-for-kubernetes/#references">References</a></h3>
<ul>
<li><a href="https://learn.microsoft.com/en-us/azure/governance/policy/concepts/policy-for-kubernetes#install-azure-policy-add-on-for-aks">Understand Azure Policy for kubernetes clusters</a></li>
<li><a href="https://github.com/open-policy-agent/gatekeeper-library/tree/master/library/general/httpsonly">Gatekeeper Library</a></li>
<li><a href="https://learn.microsoft.com/en-us/azure/governance/policy/how-to/extension-for-vscode">Azure Policy extension for Visual Studio Code</a></li>
<li><a href="https://open-policy-agent.github.io/gatekeeper/website/docs/howto/">How to use Gatekeeper</a></li>
</ul>
</div>
</article>
<nav class="md-pagination">
<a class="md-pagination__link" href="../../">1</a> <span class="md-pagination__dots">..</span> <a class="md-pagination__link" href="../7/">7</a> <a class="md-pagination__link" href="../8/">8</a> <span class="md-pagination__current">9</span> <a class="md-pagination__link" href="../10/">10</a> <a class="md-pagination__link" href="../11/">11</a> <span class="md-pagination__dots">..</span> <a class="md-pagination__link" href="../16/">16</a>
</nav>
</div>
</div>
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
</div>
<button class="md-top md-icon" data-md-component="top" hidden="" type="button">
<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  Back to top
</button>
</main>
<footer class="md-footer">
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
<div class="md-copyright__highlight">
      Copyright Â© 2023-now Rafael FernÃ¡ndez
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" rel="noopener" target="_blank">
      Material for MkDocs
    </a>
</div>
<div class="md-social">
<a class="md-social__link" href="https://www.linkedin.com/in/rafaelfernandezd/" rel="noopener" target="_blank" title="LinkedIn">
<svg viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3M135.4 416H69V202.2h66.5V416zM102.2 96a38.5 38.5 0 1 1 0 77 38.5 38.5 0 1 1 0-77m282.1 320h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9z"></path></svg>
</a>
<a class="md-social__link" href="https://github.com/rfernandezdo" rel="noopener" target="_blank" title="GitHub">
<svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg>
</a>
<a class="md-social__link" href="https://rfernandezdo.github.io/feed_rss_created.xml" rel="noopener" target="_blank" title="RSS feed">
<svg viewBox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M64 32C28.7 32 0 60.7 0 96v320c0 35.3 28.7 64 64 64h320c35.3 0 64-28.7 64-64V96c0-35.3-28.7-64-64-64zm32 104c0-13.3 10.7-24 24-24 137 0 248 111 248 248 0 13.3-10.7 24-24 24s-24-10.7-24-24c0-110.5-89.5-200-200-200-13.3 0-24-10.7-24-24m0 96c0-13.3 10.7-24 24-24 83.9 0 152 68.1 152 152 0 13.3-10.7 24-24 24s-24-10.7-24-24c0-57.4-46.6-104-104-104-13.3 0-24-10.7-24-24m0 120a32 32 0 1 1 64 0 32 32 0 1 1-64 0"></path></svg>
</a>
</div>
</div>
</div>
</footer>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<div class="md-progress" data-md-component="progress" role="progressbar"></div>
<script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.instant", "navigation.instant.progress", "navigation.tabs", "navigation.tabs.sticky", "navigation.expand", "navigation.sections", "navigation.top", "navigation.tracking", "toc.integrate", "toc.nested", "toc.smoothscroll", "footer", "content.code.copy", "content.code.select", "content.code.annotate", "content.tooltips"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
<script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
<script src="https://unpkg.com/tablesort@5.3.0/dist/tablesort.min.js"></script>
<script src="../../../javascripts/tablesort.js"></script>
<script type="module">import mermaid from "https://unpkg.com/mermaid@11.2.0/dist/mermaid.esm.min.mjs";
window.mermaidConfig = {default: {
    startOnLoad: false
}};</script>
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>